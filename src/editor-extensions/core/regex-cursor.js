// from https://github.com/codemirror/search/blob/main/src/regexp.ts
import execWithIndices from 'regexp-match-indices';
const empty = { from: -1, to: -1, match: /.*/.exec("") };
const baseFlags = "gm" + (/x/.unicode == null ? "" : "u");
/// This class is similar to [`SearchCursor`](#search.SearchCursor)
/// but searches for a regular expression pattern instead of a plain
/// string.
export class RegExpCursor {
    /// Create a cursor that will search the given range in the given
    /// document. `query` should be the raw pattern (as you'd pass it to
    /// `new RegExp`).
    constructor(text, query, options, from = 0, to = text.length) {
        this.to = to;
        this.curLine = "";
        /// Set to `true` when the cursor has reached the end of the search
        /// range.
        this.done = false;
        /// Will contain an object with the extent of the match and the
        /// match object when [`next`](#search.RegExpCursor.next)
        /// sucessfully finds a match.
        this.value = empty;
        // if (/\\[sWDnr]|\n|\r|\[\^/.test(query)) return new MultilineRegExpCursor(text, query, options, from, to) as any
        this.re = new RegExp(query, baseFlags + ((options === null || options === void 0 ? void 0 : options.ignoreCase) ? "i" : ""));
        this.iter = text.iter();
        let startLine = text.lineAt(from);
        this.curLineStart = startLine.from;
        this.matchPos = from;
        this.getLine(this.curLineStart);
    }
    getLine(skip) {
        this.iter.next(skip);
        if (this.iter.lineBreak) {
            this.curLine = "";
        }
        else {
            this.curLine = this.iter.value;
            if (this.curLineStart + this.curLine.length > this.to)
                this.curLine = this.curLine.slice(0, this.to - this.curLineStart);
            this.iter.next();
        }
    }
    nextLine() {
        this.curLineStart = this.curLineStart + this.curLine.length + 1;
        if (this.curLineStart > this.to)
            this.curLine = "";
        else
            this.getLine(0);
    }
    /// Move to the next match, if there is one.
    next() {
        for (let off = this.matchPos - this.curLineStart;;) {
            this.re.lastIndex = off;
            let match = this.matchPos <= this.to && execWithIndices(this.re, this.curLine);
            if (match) {
                let from = this.curLineStart + match.index, to = from + match[0].length;
                this.matchPos = to + (from == to ? 1 : 0);
                if (from == this.curLine.length)
                    this.nextLine();
                if (from < to || from > this.value.to) {
                    this.value = { from, to, match };
                    return this;
                }
                off = this.matchPos - this.curLineStart;
            }
            else if (this.curLineStart + this.curLine.length < this.to) {
                this.nextLine();
                off = 0;
            }
            else {
                this.done = true;
                return this;
            }
        }
    }
}
Symbol.iterator;
const flattened = new WeakMap();
// Reusable (partially) flattened document strings
class FlattenedDoc {
    constructor(from, text) {
        this.from = from;
        this.text = text;
    }
    get to() {
        return this.from + this.text.length;
    }
    static get(doc, from, to) {
        let cached = flattened.get(doc);
        if (!cached || cached.from >= to || cached.to <= from) {
            let flat = new FlattenedDoc(from, doc.sliceString(from, to));
            flattened.set(doc, flat);
            return flat;
        }
        if (cached.from == from && cached.to == to)
            return cached;
        let { text, from: cachedFrom } = cached;
        if (cachedFrom > from) {
            text = doc.sliceString(from, cachedFrom) + text;
            cachedFrom = from;
        }
        if (cached.to < to)
            text += doc.sliceString(cached.to, to);
        flattened.set(doc, new FlattenedDoc(cachedFrom, text));
        return new FlattenedDoc(from, text.slice(from - cachedFrom, to - cachedFrom));
    }
}
var Chunk;
(function (Chunk) {
    Chunk[Chunk["Base"] = 5000] = "Base";
})(Chunk || (Chunk = {}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVnZXgtY3Vyc29yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsicmVnZXgtY3Vyc29yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLG9FQUFvRTtBQUlwRSxPQUFPLGVBQWUsTUFBTSxzQkFBc0IsQ0FBQztBQUVuRCxNQUFNLEtBQUssR0FBRyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDLEVBQUUsS0FBSyxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFFLEVBQUUsQ0FBQTtBQUV6RCxNQUFNLFNBQVMsR0FBRyxJQUFJLEdBQUcsQ0FBQyxHQUFHLENBQUMsT0FBTyxJQUFJLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQTtBQUV6RCxtRUFBbUU7QUFDbkUsb0VBQW9FO0FBQ3BFLFdBQVc7QUFDWCxNQUFNLE9BQU8sWUFBWTtJQWdCeEIsaUVBQWlFO0lBQ2pFLG9FQUFvRTtJQUNwRSxrQkFBa0I7SUFDbEIsWUFBWSxJQUFVLEVBQUUsS0FBYSxFQUFFLE9BQWtDLEVBQUUsT0FBZSxDQUFDLEVBQVUsS0FBYSxJQUFJLENBQUMsTUFBTTtRQUF4QixPQUFFLEdBQUYsRUFBRSxDQUFzQjtRQWhCckgsWUFBTyxHQUFHLEVBQUUsQ0FBQTtRQUlwQixtRUFBbUU7UUFDbkUsVUFBVTtRQUNWLFNBQUksR0FBRyxLQUFLLENBQUE7UUFFWiwrREFBK0Q7UUFDL0QseURBQXlEO1FBQ3pELDhCQUE4QjtRQUM5QixVQUFLLEdBQUcsS0FBSyxDQUFBO1FBTVosa0hBQWtIO1FBQ2xILElBQUksQ0FBQyxFQUFFLEdBQUcsSUFBSSxNQUFNLENBQUMsS0FBSyxFQUFFLFNBQVMsR0FBRyxDQUFDLENBQUEsT0FBTyxhQUFQLE9BQU8sdUJBQVAsT0FBTyxDQUFFLFVBQVUsRUFBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxD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SUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsVUFBVSxFQUFFLEdBQUcsTUFBTSxDQUFBO1FBQ3ZDLElBQUksVUFBVSxHQUFHLElBQUksRUFBRTtZQUN0QixJQUFJLEdBQUcsR0FBRyxDQUFDLFdBQVcsQ0FBQyxJQUFJLEVBQUUsVUFBVSxDQUFDLEdBQUcsSUFBSSxDQUFBO1lBQy9DLFVBQVUsR0FBRyxJQUFJLENBQUE7U0FDakI7UUFDRCxJQUFJLE1BQU0sQ0FBQyxFQUFFLEdBQUcsRUFBRTtZQUNqQixJQUFJLElBQUksR0FBRyxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFBO1FBQ3ZDLFNBQVMsQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLElBQUksWUFBWSxDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFBO1FBQ3RELE9BQU8sSUFBSSxZQUFZLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxHQUFHLFVBQVUsRUFBRSxFQUFFLEdBQUcsVUFBVSxDQUFDLENBQUMsQ0FBQTtJQUM5RSxDQUFDO0NBQ0Q7QUFFRCxJQUFXLEtBQXFCO0FBQWhDLFdBQVcsS0FBSztJQUFHLG9DQUFXLENBQUE7QUFBQyxDQUFDLEVBQXJCLEtBQUssS0FBTCxLQUFLLFFBQWdCIiwic291cmNlc0NvbnRlbnQiOlsiLy8gZnJvbSBodHRwczovL2dpdGh1Yi5jb20vY29kZW1pcnJvci9zZWFyY2gvYmxvYi9tYWluL3NyYy9yZWdleHAudHNcclxuXHJcbi8vIEB0cy1pZ25vcmVcclxuaW1wb3J0IHsgVGV4dCwgVGV4dEl0ZXJhdG9yIH0gZnJvbSBcIkBjb2RlbWlycm9yL3RleHRcIlxyXG5pbXBvcnQgZXhlY1dpdGhJbmRpY2VzIGZyb20gJ3JlZ2V4cC1tYXRjaC1pbmRpY2VzJztcclxuXHJcbmNvbnN0IGVtcHR5ID0geyBmcm9tOiAtMSwgdG86IC0xLCBtYXRjaDogLy4qLy5leGVjKFwiXCIpISB9XHJcblxyXG5jb25zdCBiYXNlRmxhZ3MgPSBcImdtXCIgKyAoL3gvLnVuaWNvZGUgPT0gbnVsbCA/IFwiXCIgOiBcInVcIilcclxuXHJcbi8vLyBUaGlzIGNsYXNzIGlzIHNpbWlsYXIgdG8gW2BTZWFyY2hDdXJzb3JgXSgjc2VhcmNoLlNlYXJjaEN1cnNvcilcclxuLy8vIGJ1dCBzZWFyY2hlcyBmb3IgYSByZWd1bGFyIGV4cHJlc3Npb24gcGF0dGVybiBpbnN0ZWFkIG9mIGEgcGxhaW5cclxuLy8vIHN0cmluZy5cclxuZXhwb3J0IGNsYXNzIFJlZ0V4cEN1cnNvciBpbXBsZW1lbnRzIEl0ZXJhdG9yPHsgZnJvbTogbnVtYmVyLCB0bzogbnVtYmVyLCBtYXRjaDogUmVnRXhwRXhlY0FycmF5IH0+IHtcclxuXHRwcml2YXRlIGl0ZXIhOiBUZXh0SXRlcmF0b3JcclxuXHRwcml2YXRlIHJlITogUmVnRXhwXHJcblx0cHJpdmF0ZSBjdXJMaW5lID0gXCJcIlxyXG5cdHByaXZhdGUgY3VyTGluZVN0YXJ0ITogbnVtYmVyXHJcblx0cHJpdmF0ZSBtYXRjaFBvcyE6IG51bWJlclxyXG5cclxuXHQvLy8gU2V0IHRvIGB0cnVlYCB3aGVuIHRoZSBjdXJzb3IgaGFzIHJlYWNoZWQgdGhlIGVuZCBvZiB0aGUgc2VhcmNoXHJcblx0Ly8vIHJhbmdlLlxyXG5cdGRvbmUgPSBmYWxzZVxyXG5cclxuXHQvLy8gV2lsbCBjb250YWluIGFuIG9iamVjdCB3aXRoIHRoZSBleHRlbnQgb2YgdGhlIG1hdGNoIGFuZCB0aGVcclxuXHQvLy8gbWF0Y2ggb2JqZWN0IHdoZW4gW2BuZXh0YF0oI3NlYXJjaC5SZWdFeHBDdXJzb3IubmV4dClcclxuXHQvLy8gc3VjZXNzZnVsbHkgZmluZHMgYSBtYXRjaC5cclxuXHR2YWx1ZSA9IGVtcHR5XHJcblxyXG5cdC8vLyBDcmVhdGUgYSBjdXJzb3IgdGhhdCB3aWxsIHNlYXJjaCB0aGUgZ2l2ZW4gcmFuZ2UgaW4gdGhlIGdpdmVuXHJcblx0Ly8vIGRvY3VtZW50LiBgcXVlcnlgIHNob3VsZCBiZSB0aGUgcmF3IHBhdHRlcm4gKGFzIHlvdSdkIHBhc3MgaXQgdG9cclxuXHQvLy8gYG5ldyBSZWdFeHBgKS5cclxuXHRjb25zdHJ1Y3Rvcih0ZXh0OiBUZXh0LCBxdWVyeTogc3RyaW5nLCBvcHRpb25zPzogeyBpZ25vcmVDYXNlPzogYm9vbGVhbiB9LCBmcm9tOiBudW1iZXIgPSAwLCBwcml2YXRlIHRvOiBudW1iZXIgPSB0ZXh0Lmxlbmd0aCkge1xyXG5cdFx0Ly8gaWYgKC9cXFxcW3NXRG5yXXxcXG58XFxyfFxcW1xcXi8udGVzdChxdWVyeSkpIHJldHVybiBuZXcgTXVsdGlsaW5lUmVnRXhwQ3Vyc29yKHRleHQsIHF1ZXJ5LCBvcHRpb25zLCBmcm9tLCB0bykgYXMgYW55XHJcblx0XHR0aGlzLnJlID0gbmV3IFJlZ0V4cChxdWVyeSwgYmFzZUZsYWdzICsgKG9wdGlvbnM/Lmlnbm9yZUNhc2UgPyBcImlcIiA6IFwiXCIpKVxyXG5cdFx0dGhpcy5pdGVyID0gdGV4dC5pdGVyKClcclxuXHRcdGxldCBzdGFydExpbmUgPSB0ZXh0LmxpbmVBdChmcm9tKVxyXG5cdFx0dGhpcy5jdXJMaW5lU3RhcnQgPSBzdGFydExpbmUuZnJvbVxyXG5cdFx0dGhpcy5tYXRjaFBvcyA9IGZyb21cclxuXHRcdHRoaXMuZ2V0TGluZSh0aGlzLmN1ckxpbmVTdGFydClcclxuXHR9XHJcblxyXG5cdHByaXZhdGUgZ2V0TGluZShza2lwOiBudW1iZXIpIHtcclxuXHRcdHRoaXMuaXRlci5uZXh0KHNraXApXHJcblx0XHRpZiAodGhpcy5pdGVyLmxpbmVCcmVhaykge1xyXG5cdFx0XHR0aGlzLmN1ckxpbmUgPSBcIlwiXHJcblx0XHR9IGVsc2Uge1xyXG5cdFx0XHR0aGlzLmN1ckxpbmUgPSB0aGlzLml0ZXIudmFsdWVcclxuXHRcdFx0aWYgKHRoaXMuY3VyTGluZVN0YXJ0ICsgdGhpcy5jdXJMaW5lLmxlbmd0aCA+IHRoaXMudG8pXHJcblx0XHRcdFx0dGhpcy5jdXJMaW5lID0gdGhpcy5jdXJMaW5lLnNsaWNlKDAsIHRoaXMudG8gLSB0aGlzLmN1ckxpbmVTdGFydClcclxuXHRcdFx0dGhpcy5pdGVyLm5leHQoKVxyXG5cdFx0fVxyXG5cdH1cclxuXHJcblx0cHJpdmF0ZSBuZXh0TGluZSgpIHtcclxuXHRcdHRoaXMuY3VyTGluZVN0YXJ0ID0gdGhpcy5jdXJMaW5lU3RhcnQgKyB0aGlzLmN1ckxpbmUubGVuZ3RoICsgMVxyXG5cdFx0aWYgKHRoaXMuY3VyTGluZVN0YXJ0ID4gdGhpcy50bykgdGhpcy5jdXJMaW5lID0gXCJcIlxyXG5cdFx0ZWxzZSB0aGlzLmdldExpbmUoMClcclxuXHR9XHJcblxyXG5cdC8vLyBNb3ZlIHRvIHRoZSBuZXh0IG1hdGNoLCBpZiB0aGVyZSBpcyBvbmUuXHJcblx0bmV4dCgpIHtcclxuXHRcdGZvciAobGV0IG9mZiA9IHRoaXMubWF0Y2hQb3MgLSB0aGlzLmN1ckxpbmVTdGFydDsgOykge1xyXG5cdFx0XHR0aGlzLnJlLmxhc3RJbmRleCA9IG9mZlxyXG5cdFx0XHRsZXQgbWF0Y2ggPSB0aGlzLm1hdGNoUG9zIDw9IHRoaXMudG8gJiYgZXhlY1dpdGhJbmRpY2VzKHRoaXMucmUsIHRoaXMuY3VyTGluZSlcclxuXHRcdFx0aWYgKG1hdGNoKSB7XHJcblx0XHRcdFx0bGV0IGZyb20gPSB0aGlzLmN1ckxpbmVTdGFydCArIG1hdGNoLmluZGV4LCB0byA9IGZyb20gKyBtYXRjaFswXS5sZW5ndGhcclxuXHRcdFx0XHR0aGlzLm1hdGNoUG9zID0gdG8gKyAoZnJvbSA9PSB0byA/IDEgOiAwKVxyXG5cdFx0XHRcdGlmIChmcm9tID09IHRoaXMuY3VyTGluZS5sZW5ndGgpIHRoaXMubmV4dExpbmUoKVxyXG5cdFx0XHRcdGlmIChmcm9tIDwgdG8gfHwgZnJvbSA+IHRoaXMudmFsdWUudG8pIHtcclxuXHRcdFx0XHRcdHRoaXMudmFsdWUgPSB7IGZyb20sIHRvLCBtYXRjaCB9XHJcblx0XHRcdFx0XHRyZXR1cm4gdGhpc1xyXG5cdFx0XHRcdH1cclxuXHRcdFx0XHRvZmYgPSB0aGlzLm1hdGNoUG9zIC0gdGhpcy5jdXJMaW5lU3RhcnRcclxuXHRcdFx0fSBlbHNlIGlmICh0aGlzLmN1ckxpbmVTdGFydCArIHRoaXMuY3VyTGluZS5sZW5ndGggPCB0aGlzLnRvKSB7XHJcblx0XHRcdFx0dGhpcy5uZXh0TGluZSgpXHJcblx0XHRcdFx0b2ZmID0gMFxyXG5cdFx0XHR9IGVsc2Uge1xyXG5cdFx0XHRcdHRoaXMuZG9uZSA9IHRydWVcclxuXHRcdFx0XHRyZXR1cm4gdGhpc1xyXG5cdFx0XHR9XHJcblx0XHR9XHJcblx0fVxyXG5cclxuXHRbU3ltYm9sLml0ZXJhdG9yXSE6ICgpID0+IEl0ZXJhdG9yPHsgZnJvbTogbnVtYmVyLCB0bzogbnVtYmVyLCBtYXRjaDogUmVnRXhwRXhlY0FycmF5IH0+XHJcbn1cclxuXHJcbmNvbnN0IGZsYXR0ZW5lZCA9IG5ldyBXZWFrTWFwPFRleHQsIEZsYXR0ZW5lZERvYz4oKVxyXG5cclxuLy8gUmV1c2FibGUgKHBhcnRpYWxseSkgZmxhdHRlbmVkIGRvY3VtZW50IHN0cmluZ3NcclxuY2xhc3MgRmxhdHRlbmVkRG9jIHtcclxuXHRjb25zdHJ1Y3RvcihyZWFkb25seSBmcm9tOiBudW1iZXIsXHJcblx0XHRcdFx0cmVhZG9ubHkgdGV4dDogc3RyaW5nKSB7XHJcblx0fVxyXG5cclxuXHRnZXQgdG8oKSB7XHJcblx0XHRyZXR1cm4gdGhpcy5mcm9tICsgdGhpcy50ZXh0Lmxlbmd0aFxyXG5cdH1cclxuXHJcblx0c3RhdGljIGdldChkb2M6IFRleHQsIGZyb206IG51bWJlciwgdG86IG51bWJlcikge1xyXG5cdFx0bGV0IGNhY2hlZCA9IGZsYXR0ZW5lZC5nZXQoZG9jKVxyXG5cdFx0aWYgKCFjYWNoZWQgfHwgY2FjaGVkLmZyb20gPj0gdG8gfHwgY2FjaGVkLnRvIDw9IGZyb20pIHtcclxuXHRcdFx0bGV0IGZsYXQgPSBuZXcgRmxhdHRlbmVkRG9jKGZyb20sIGRvYy5zbGljZVN0cmluZyhmcm9tLCB0bykpXHJcblx0XHRcdGZsYXR0ZW5lZC5zZXQoZG9jLCBmbGF0KVxyXG5cdFx0XHRyZXR1cm4gZmxhdFxyXG5cdFx0fVxyXG5cdFx0aWYgKGNhY2hlZC5mcm9tID09IGZyb20gJiYgY2FjaGVkLnRvID09IHRvKSByZXR1cm4gY2FjaGVkXHJcblx0XHRsZXQgeyB0ZXh0LCBmcm9tOiBjYWNoZWRGcm9tIH0gPSBjYWNoZWRcclxuXHRcdGlmIChjYWNoZWRGcm9tID4gZnJvbSkge1xyXG5cdFx0XHR0ZXh0ID0gZG9jLnNsaWNlU3RyaW5nKGZyb20sIGNhY2hlZEZyb20pICsgdGV4dFxyXG5cdFx0XHRjYWNoZWRGcm9tID0gZnJvbVxyXG5cdFx0fVxyXG5cdFx0aWYgKGNhY2hlZC50byA8IHRvKVxyXG5cdFx0XHR0ZXh0ICs9IGRvYy5zbGljZVN0cmluZyhjYWNoZWQudG8sIHRvKVxyXG5cdFx0ZmxhdHRlbmVkLnNldChkb2MsIG5ldyBGbGF0dGVuZWREb2MoY2FjaGVkRnJvbSwgdGV4dCkpXHJcblx0XHRyZXR1cm4gbmV3IEZsYXR0ZW5lZERvYyhmcm9tLCB0ZXh0LnNsaWNlKGZyb20gLSBjYWNoZWRGcm9tLCB0byAtIGNhY2hlZEZyb20pKVxyXG5cdH1cclxufVxyXG5cclxuY29uc3QgZW51bSBDaHVuayB7IEJhc2UgPSA1MDAwIH1cclxuIl19