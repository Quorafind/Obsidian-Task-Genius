/**
 * ICS Parser Performance Tests
 * Tests for optimized parsing performance
 */
import { IcsParser } from "../parsers/ics-parser";
describe("ICS Parser Performance", () => {
    const testSource = {
        id: "test-performance",
        name: "Performance Test",
        url: "test://performance",
        enabled: true,
        refreshInterval: 60,
        showAllDayEvents: true,
        showTimedEvents: true,
        showType: "event",
    };
    // Mock ICS content with multiple events
    const createMockIcsContent = (eventCount) => {
        const events = [];
        for (let i = 0; i < eventCount; i++) {
            const date = new Date(2024, 0, i + 1);
            const dateStr = date.toISOString().slice(0, 10).replace(/-/g, '');
            events.push(`BEGIN:VEVENT
UID:event-${i}@test.com
DTSTART;VALUE=DATE:${dateStr}
DTEND;VALUE=DATE:${dateStr}
SUMMARY:Test Event ${i}
DESCRIPTION:This is test event number ${i}
LOCATION:Test Location ${i}
STATUS:CONFIRMED
CATEGORIES:test,performance
PRIORITY:5
CREATED:20240101T120000Z
LAST-MODIFIED:20240101T120000Z
END:VEVENT`);
        }
        return `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Test//Test Calendar//EN
CALSCALE:GREGORIAN
X-WR-CALNAME:Performance Test Calendar
X-WR-CALDESC:Calendar for performance testing
${events.join('\n')}
END:VCALENDAR`;
    };
    beforeEach(() => {
        // Clear cache before each test
        IcsParser.clearCache();
    });
    describe("Parsing Performance", () => {
        test("should parse small ICS content quickly", () => {
            const content = createMockIcsContent(10);
            const startTime = performance.now();
            const result = IcsParser.parse(content, testSource);
            const endTime = performance.now();
            const parseTime = endTime - startTime;
            expect(result.events).toHaveLength(10);
            expect(result.errors).toHaveLength(0);
            expect(parseTime).toBeLessThan(50); // Should be very fast for small content
            console.log(`Small content (10 events) parsing took ${parseTime.toFixed(2)}ms`);
        });
        test("should parse medium ICS content efficiently", () => {
            const content = createMockIcsContent(100);
            const startTime = performance.now();
            const result = IcsParser.parse(content, testSource);
            const endTime = performance.now();
            const parseTime = endTime - startTime;
            expect(result.events).toHaveLength(100);
            expect(result.errors).toHaveLength(0);
            expect(parseTime).toBeLessThan(200); // Should be fast for medium content
            console.log(`Medium content (100 events) parsing took ${parseTime.toFixed(2)}ms`);
        });
        test("should parse large ICS content within reasonable time", () => {
            const content = createMockIcsContent(1000);
            const startTime = performance.now();
            const result = IcsParser.parse(content, testSource);
            const endTime = performance.now();
            const parseTime = endTime - startTime;
            expect(result.events).toHaveLength(1000);
            expect(result.errors).toHaveLength(0);
            expect(parseTime).toBeLessThan(1000); // Should be under 1 second for large content
            console.log(`Large content (1000 events) parsing took ${parseTime.toFixed(2)}ms`);
        });
    });
    describe("Caching Performance", () => {
        test("should benefit from caching on repeated parsing", () => {
            const content = createMockIcsContent(100);
            // First parse (no cache)
            const startTime1 = performance.now();
            const result1 = IcsParser.parse(content, testSource);
            const endTime1 = performance.now();
            const firstParseTime = endTime1 - startTime1;
            // Second parse (with cache)
            const startTime2 = performance.now();
            const result2 = IcsParser.parse(content, testSource);
            const endTime2 = performance.now();
            const secondParseTime = endTime2 - startTime2;
            expect(result1.events).toHaveLength(100);
            expect(result2.events).toHaveLength(100);
            expect(secondParseTime).toBeLessThan(firstParseTime * 0.5); // Cache should be at least 50% faster
            console.log(`First parse: ${firstParseTime.toFixed(2)}ms, Cached parse: ${secondParseTime.toFixed(2)}ms`);
            console.log(`Cache speedup: ${(firstParseTime / secondParseTime).toFixed(2)}x`);
        });
        test("should manage cache size properly", () => {
            const cacheStatsBefore = IcsParser.getCacheStats();
            expect(cacheStatsBefore.size).toBe(0);
            // Parse multiple different contents to fill cache
            for (let i = 0; i < 60; i++) { // More than MAX_CACHE_SIZE (50)
                const content = createMockIcsContent(5) + `\n<!-- unique-${i} -->`;
                IcsParser.parse(content, Object.assign(Object.assign({}, testSource), { id: `test-${i}` }));
            }
            const cacheStatsAfter = IcsParser.getCacheStats();
            expect(cacheStatsAfter.size).toBeLessThanOrEqual(cacheStatsAfter.maxSize);
            console.log(`Cache size after filling: ${cacheStatsAfter.size}/${cacheStatsAfter.maxSize}`);
        });
    });
    describe("Memory Efficiency", () => {
        test("should handle string operations efficiently", () => {
            // Test with content that has many folded lines
            const foldedContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Test//Test Calendar//EN
BEGIN:VEVENT
UID:folded-test@test.com
DTSTART:20240101T120000Z
SUMMARY:This is a very long summary that will be folded across multiple
 lines to test the unfolding optimization and ensure it works correctly
 with the new array-based approach instead of string concatenation
DESCRIPTION:This is also a very long description that spans multiple
 lines and contains various escape sequences like \\n newlines and \\,
 commas and \\; semicolons to test the unescaping optimization
END:VEVENT
END:VCALENDAR`;
            const startTime = performance.now();
            const result = IcsParser.parse(foldedContent, testSource);
            const endTime = performance.now();
            expect(result.events).toHaveLength(1);
            expect(result.events[0].summary).toContain("folded across multiple lines");
            expect(result.events[0].description).toContain("newlines");
            console.log(`Folded content parsing took ${(endTime - startTime).toFixed(2)}ms`);
        });
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaWNzLXBhcnNlci1wZXJmb3JtYW5jZS50ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiaWNzLXBhcnNlci1wZXJmb3JtYW5jZS50ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7R0FHRztBQUVILE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUdsRCxRQUFRLENBQUMsd0JBQXdCLEVBQUUsR0FBRyxFQUFFO0lBQ3ZDLE1BQU0sVUFBVSxHQUFjO1FBQzdCLEVBQUUsRUFBRSxrQkFBa0I7UUFDdEIsSUFBSSxFQUFFLGtCQUFrQjtRQUN4QixHQUFHLEVBQUUsb0JBQW9CO1FBQ3pCLE9BQU8sRUFBRSxJQUFJO1FBQ2IsZUFBZSxFQUFFLEVBQUU7UUFDbkIsZ0JBQWdCLEVBQUUsSUFBSTtRQUN0QixlQUFlLEVBQUUsSUFBSTtRQUNyQixRQUFRLEVBQUUsT0FBTztLQUNqQixDQUFDO0lBRUYsd0NBQXdDO0lBQ3hDLE1BQU0sb0JBQW9CLEdBQUcsQ0FBQyxVQUFrQixFQUFVLEVBQUU7UUFDM0QsTUFBTSxNQUFNLEdBQUcsRUFBRSxDQUFDO1FBQ2xCLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxVQUFVLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDcEMsTUFBTSxJQUFJLEdBQUcsSUFBSSxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFDdEMsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQztZQUVsRSxNQUFNLENBQUMsSUFBSSxDQUFDO1lBQ0gsQ0FBQztxQkFDUSxPQUFPO21CQUNULE9BQU87cUJBQ0wsQ0FBQzt3Q0FDa0IsQ0FBQzt5QkFDaEIsQ0FBQzs7Ozs7O1dBTWYsQ0FBQyxD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QyxDQUFDO0lBQ0osQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsbUJBQW1CLEVBQUUsR0FBRyxFQUFFO1FBQ2xDLElBQUksQ0FBQyw2Q0FBNkMsRUFBRSxHQUFHLEVBQUU7WUFDeEQsK0NBQStDO1lBQy9DLE1BQU0sYUFBYSxHQUFHOzs7Ozs7Ozs7Ozs7O2NBYVgsQ0FBQztZQUVaLE1BQU0sU0FBUyxHQUFHLFdBQVcsQ0FBQyxHQUFHLEVBQUUsQ0FBQztZQUNwQyxNQUFNLE1BQU0sR0FBRyxTQUFTLENBQUMsS0FBSyxDQUFDLGFBQWEsRUFBRSxVQUFVLENBQUMsQ0FBQztZQUMxRCxNQUFNLE9BQU8sR0FBRyxXQUFXLENBQUMsR0FBRyxFQUFFLENBQUM7WUFFbEMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDdEMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsU0FBUyxDQUFDLDhCQUE4QixDQUFDLENBQUM7WUFDM0UsTUFBTSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsV0FBVyxDQUFDLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBRTNELE9BQU8sQ0FBQyxHQUFHLENBQUMsK0JBQStCLENBQUMsT0FBTyxHQUFHLFNBQVMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDbEYsQ0FBQyxDQUFDLENBQUM7SUFDSixDQUFDLENBQUMsQ0FBQztBQUNKLENBQUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXHJcbiAqIElDUyBQYXJzZXIgUGVyZm9ybWFuY2UgVGVzdHNcclxuICogVGVzdHMgZm9yIG9wdGltaXplZCBwYXJzaW5nIHBlcmZvcm1hbmNlXHJcbiAqL1xyXG5cclxuaW1wb3J0IHsgSWNzUGFyc2VyIH0gZnJvbSBcIi4uL3BhcnNlcnMvaWNzLXBhcnNlclwiO1xyXG5pbXBvcnQgeyBJY3NTb3VyY2UgfSBmcm9tIFwiLi4vdHlwZXMvaWNzXCI7XHJcblxyXG5kZXNjcmliZShcIklDUyBQYXJzZXIgUGVyZm9ybWFuY2VcIiwgKCkgPT4ge1xyXG5cdGNvbnN0IHRlc3RTb3VyY2U6IEljc1NvdXJjZSA9IHtcclxuXHRcdGlkOiBcInRlc3QtcGVyZm9ybWFuY2VcIixcclxuXHRcdG5hbWU6IFwiUGVyZm9ybWFuY2UgVGVzdFwiLFxyXG5cdFx0dXJsOiBcInRlc3Q6Ly9wZXJmb3JtYW5jZVwiLFxyXG5cdFx0ZW5hYmxlZDogdHJ1ZSxcclxuXHRcdHJlZnJlc2hJbnRlcnZhbDogNjAsXHJcblx0XHRzaG93QWxsRGF5RXZlbnRzOiB0cnVlLFxyXG5cdFx0c2hvd1RpbWVkRXZlbnRzOiB0cnVlLFxyXG5cdFx0c2hvd1R5cGU6IFwiZXZlbnRcIixcclxuXHR9O1xyXG5cclxuXHQvLyBNb2NrIElDUyBjb250ZW50IHdpdGggbXVsdGlwbGUgZXZlbnRzXHJcblx0Y29uc3QgY3JlYXRlTW9ja0ljc0NvbnRlbnQgPSAoZXZlbnRDb3VudDogbnVtYmVyKTogc3RyaW5nID0+IHtcclxuXHRcdGNvbnN0IGV2ZW50cyA9IFtdO1xyXG5cdFx0Zm9yIChsZXQgaSA9IDA7IGkgPCBldmVudENvdW50OyBpKyspIHtcclxuXHRcdFx0Y29uc3QgZGF0ZSA9IG5ldyBEYXRlKDIwMjQsIDAsIGkgKyAxKTtcclxuXHRcdFx0Y29uc3QgZGF0ZVN0ciA9IGRhdGUudG9JU09TdHJpbmcoKS5zbGljZSgwLCAxMCkucmVwbGFjZSgvLS9nLCAnJyk7XHJcblx0XHRcdFxyXG5cdFx0XHRldmVudHMucHVzaChgQkVHSU46VkVWRU5UXHJcblVJRDpldmVudC0ke2l9QHRlc3QuY29tXHJcbkRUU1RBUlQ7VkFMVUU9REFURToke2RhdGVTdHJ9XHJcbkRURU5EO1ZBTFVFPURBVEU6JHtkYXRlU3RyfVxyXG5TVU1NQVJZOlRlc3QgRXZlbnQgJHtpfVxyXG5ERVNDUklQVElPTjpUaGlzIGlzIHRlc3QgZXZlbnQgbnVtYmVyICR7aX1cclxuTE9DQVRJT046VGVzdCBMb2NhdGlvbiAke2l9XHJcblNUQVRVUzpDT05GSVJNRURcclxuQ0FURUdPUklFUzp0ZXN0LHBlcmZvcm1hbmNlXHJcblBSSU9SSVRZOjVcclxuQ1JFQVRFRDoyMDI0MDEwMVQxMjAwMDBaXHJcbkxBU1QtTU9ESUZJRUQ6MjAyNDAxMDFUMTIwMDAwWlxyXG5FTkQ6VkVWRU5UYCk7XHJcblx0XHR9XHJcblxyXG5cdFx0cmV0dXJuIGBCRUdJTjpWQ0FMRU5EQVJcclxuVkVSU0lPTjoyLjBcclxuUFJPRElEOi0vL1Rlc3QvL1Rlc3QgQ2FsZW5kYXIvL0VOXHJcbkNBTFNDQUxFOkdSRUdPUklBTlxyXG5YLVdSLUNBTE5BTUU6UGVyZm9ybWFuY2UgVGVzdCBDYWxlbmRhclxyXG5YLVdSLUNBTERFU0M6Q2FsZW5kYXIgZm9yIHBlcmZvcm1hbmNlIHRlc3RpbmdcclxuJHtldmVudHMuam9pbignXFxuJyl9XHJcbkVORDpWQ0FMRU5EQVJgO1xyXG5cdH07XHJcblxyXG5cdGJlZm9yZUVhY2goKCkgPT4ge1xyXG5cdFx0Ly8gQ2xlYXIgY2FjaGUgYmVmb3JlIGVhY2ggdGVzdFxyXG5cdFx0SWNzUGFyc2VyLmNsZWFyQ2FjaGUoKTtcclxuXHR9KTtcclxuXHJcblx0ZGVzY3JpYmUoXCJQYXJzaW5nIFBlcmZvcm1hbmNlXCIsICgpID0+IHtcclxuXHRcdHRlc3QoXCJzaG91bGQgcGFyc2Ugc21hbGwgSUNTIGNvbnRlbnQgcXVpY2tseVwiLCAoKSA9PiB7XHJcblx0XHRcdGNvbnN0IGNvbnRlbnQgPSBjcmVhdGVNb2NrSWNzQ29udGVudCgxMCk7XHJcblx0XHRcdFxyXG5cdFx0XHRjb25zdCBzdGFydFRpbWUgPSBwZXJmb3JtYW5jZS5ub3coKTtcclxuXHRcdFx0Y29uc3QgcmVzdWx0ID0gSWNzUGFyc2VyLnBhcnNlKGNvbnRlbnQsIHRlc3RTb3VyY2UpO1xyXG5cdFx0XHRjb25zdCBlbmRUaW1lID0gcGVyZm9ybWFuY2Uubm93KCk7XHJcblx0XHRcdFxyXG5cdFx0XHRjb25zdCBwYXJzZVRpbWUgPSBlbmRUaW1lIC0gc3RhcnRUaW1lO1xyXG5cdFx0XHRcclxuXHRcdFx0ZXhwZWN0KHJlc3VsdC5ldmVudHMpLnRvSGF2ZUxlbmd0aCgxMCk7XHJcblx0XHRcdGV4cGVjdChyZXN1bHQuZXJyb3JzKS50b0hhdmVMZW5ndGgoMCk7XHJcblx0XHRcdGV4cGVjdChwYXJzZVRpbWUpLnRvQmVMZXNzVGhhbig1MCk7IC8vIFNob3VsZCBiZSB2ZXJ5IGZhc3QgZm9yIHNtYWxsIGNvbnRlbnRcclxuXHRcdFx0XHJcblx0XHRcdGNvbnNvbGUubG9nKGBTbWFsbCBjb250ZW50ICgxMCBldmVudHMpIHBhcnNpbmcgdG9vayAke3BhcnNlVGltZS50b0ZpeGVkKDIpfW1zYCk7XHJcblx0XHR9KTtcclxuXHJcblx0XHR0ZXN0KFwic2hvdWxkIHBhcnNlIG1lZGl1bSBJQ1MgY29udGVudCBlZmZpY2llbnRseVwiLCAoKSA9PiB7XHJcblx0XHRcdGNvbnN0IGNvbnRlbnQgPSBjcmVhdGVNb2NrSWNzQ29udGVudCgxMDApO1xyXG5cdFx0XHRcclxuXHRcdFx0Y29uc3Qgc3RhcnRUaW1lID0gcGVyZm9ybWFuY2Uubm93KCk7XHJcblx0XHRcdGNvbnN0IHJlc3VsdCA9IEljc1BhcnNlci5wYXJzZShjb250ZW50LCB0ZXN0U291cmNlKTtcclxuXHRcdFx0Y29uc3QgZW5kVGltZSA9IHBlcmZvcm1hbmNlLm5vdygpO1xyXG5cdFx0XHRcclxuXHRcdFx0Y29uc3QgcGFyc2VUaW1lID0gZW5kVGltZSAtIHN0YXJ0VGltZTtcclxuXHRcdFx0XHJcblx0XHRcdGV4cGVjdChyZXN1bHQuZXZlbnRzKS50b0hhdmVMZW5ndGgoMTAwKTtcclxuXHRcdFx0ZXhwZWN0KHJlc3VsdC5lcnJvcnMpLnRvSGF2ZUxlbmd0aCgwKTtcclxuXHRcdFx0ZXhwZWN0KHBhcnNlVGltZSkudG9CZUxlc3NUaGFuKDIwMCk7IC8vIFNob3VsZCBiZSBmYXN0IGZvciBtZWRpdW0gY29udGVudFxyXG5cdFx0XHRcclxuXHRcdFx0Y29uc29sZS5sb2coYE1lZGl1bSBjb250ZW50ICgxMDAgZXZlbnRzKSBwYXJzaW5nIHRvb2sgJHtwYXJzZVRpbWUudG9GaXhlZCgyKX1tc2ApO1xyXG5cdFx0fSk7XHJcblxyXG5cdFx0dGVzdChcInNob3VsZCBwYXJzZSBsYXJnZSBJQ1MgY29udGVudCB3aXRoaW4gcmVhc29uYWJsZSB0aW1lXCIsICgpID0+IHtcclxuXHRcdFx0Y29uc3QgY29udGVudCA9IGNyZWF0ZU1vY2tJY3NDb250ZW50KDEwMDApO1xyXG5cdFx0XHRcclxuXHRcdFx0Y29uc3Qgc3RhcnRUaW1lID0gcGVyZm9ybWFuY2Uubm93KCk7XHJcblx0XHRcdGNvbnN0IHJlc3VsdCA9IEljc1BhcnNlci5wYXJzZShjb250ZW50LCB0ZXN0U291cmNlKTtcclxuXHRcdFx0Y29uc3QgZW5kVGltZSA9IHBlcmZvcm1hbmNlLm5vdygpO1xyXG5cdFx0XHRcclxuXHRcdFx0Y29uc3QgcGFyc2VUaW1lID0gZW5kVGltZSAtIHN0YXJ0VGltZTtcclxuXHRcdFx0XHJcblx0XHRcdGV4cGVjdChyZXN1bHQuZXZlbnRzKS50b0hhdmVMZW5ndGgoMTAwMCk7XHJcblx0XHRcdGV4cGVjdChyZXN1bHQuZXJyb3JzKS50b0hhdmVMZW5ndGgoMCk7XHJcblx0XHRcdGV4cGVjdChwYXJzZVRpbWUpLnRvQmVMZXNzVGhhbigxMDAwKTsgLy8gU2hvdWxkIGJlIHVuZGVyIDEgc2Vjb25kIGZvciBsYXJnZSBjb250ZW50XHJcblx0XHRcdFxyXG5cdFx0XHRjb25zb2xlLmxvZyhgTGFyZ2UgY29udGVudCAoMTAwMCBldmVudHMpIHBhcnNpbmcgdG9vayAke3BhcnNlVGltZS50b0ZpeGVkKDIpfW1zYCk7XHJcblx0XHR9KTtcclxuXHR9KTtcclxuXHJcblx0ZGVzY3JpYmUoXCJDYWNoaW5nIFBlcmZvcm1hbmNlXCIsICgpID0+IHtcclxuXHRcdHRlc3QoXCJzaG91bGQgYmVuZWZpdCBmcm9tIGNhY2hpbmcgb24gcmVwZWF0ZWQgcGFyc2luZ1wiLCAoKSA9PiB7XHJcblx0XHRcdGNvbnN0IGNvbnRlbnQgPSBjcmVhdGVNb2NrSWNzQ29udGVudCgxMDApO1xyXG5cdFx0XHRcclxuXHRcdFx0Ly8gRmlyc3QgcGFyc2UgKG5vIGNhY2hlKVxyXG5cdFx0XHRjb25zdCBzdGFydFRpbWUxID0gcGVyZm9ybWFuY2Uubm93KCk7XHJcblx0XHRcdGNvbnN0IHJlc3VsdDEgPSBJY3NQYXJzZXIucGFyc2UoY29udGVudCwgdGVzdFNvdXJjZSk7XHJcblx0XHRcdGNvbnN0IGVuZFRpbWUxID0gcGVyZm9ybWFuY2Uubm93KCk7XHJcblx0XHRcdGNvbnN0IGZpcnN0UGFyc2VUaW1lID0gZW5kVGltZTEgLSBzdGFydFRpbWUxO1xyXG5cdFx0XHRcclxuXHRcdFx0Ly8gU2Vjb25kIHBhcnNlICh3aXRoIGNhY2hlKVxyXG5cdFx0XHRjb25zdCBzdGFydFRpbWUyID0gcGVyZm9ybWFuY2Uubm93KCk7XHJcblx0XHRcdGNvbnN0IHJlc3VsdDIgPSBJY3NQYXJzZXIucGFyc2UoY29udGVudCwgdGVzdFNvdXJjZSk7XHJcblx0XHRcdGNvbnN0IGVuZFRpbWUyID0gcGVyZm9ybWFuY2Uubm93KCk7XHJcblx0XHRcdGNvbnN0IHNlY29uZFBhcnNlVGltZSA9IGVuZFRpbWUyIC0gc3RhcnRUaW1lMjtcclxuXHRcdFx0XHJcblx0XHRcdGV4cGVjdChyZXN1bHQxLmV2ZW50cykudG9IYXZlTGVuZ3RoKDEwMCk7XHJcblx0XHRcdGV4cGVjdChyZXN1bHQyLmV2ZW50cykudG9IYXZlTGVuZ3RoKDEwMCk7XHJcblx0XHRcdGV4cGVjdChzZWNvbmRQYXJzZVRpbWUpLnRvQmVMZXNzVGhhbihmaXJzdFBhcnNlVGltZSAqIDAuNSk7IC8vIENhY2hlIHNob3VsZCBiZSBhdCBsZWFzdCA1MCUgZmFzdGVyXHJcblx0XHRcdFxyXG5cdFx0XHRjb25zb2xlLmxvZyhgRmlyc3QgcGFyc2U6ICR7Zmlyc3RQYXJzZVRpbWUudG9GaXhlZCgyKX1tcywgQ2FjaGVkIHBhcnNlOiAke3NlY29uZFBhcnNlVGltZS50b0ZpeGVkKDIpfW1zYCk7XHJcblx0XHRcdGNvbnNvbGUubG9nKGBDYWNoZSBzcGVlZHVwOiAkeyhmaXJzdFBhcnNlVGltZSAvIHNlY29uZFBhcnNlVGltZSkudG9GaXhlZCgyKX14YCk7XHJcblx0XHR9KTtcclxuXHJcblx0XHR0ZXN0KFwic2hvdWxkIG1hbmFnZSBjYWNoZSBzaXplIHByb3Blcmx5XCIsICgpID0+IHtcclxuXHRcdFx0Y29uc3QgY2FjaGVTdGF0c0JlZm9yZSA9IEljc1BhcnNlci5nZXRDYWNoZVN0YXRzKCk7XHJcblx0XHRcdGV4cGVjdChjYWNoZVN0YXRzQmVmb3JlLnNpemUpLnRvQmUoMCk7XHJcblx0XHRcdFxyXG5cdFx0XHQvLyBQYXJzZSBtdWx0aXBsZSBkaWZmZXJlbnQgY29udGVudHMgdG8gZmlsbCBjYWNoZVxyXG5cdFx0XHRmb3IgKGxldCBpID0gMDsgaSA8IDYwOyBpKyspIHsgLy8gTW9yZSB0aGFuIE1BWF9DQUNIRV9TSVpFICg1MClcclxuXHRcdFx0XHRjb25zdCBjb250ZW50ID0gY3JlYXRlTW9ja0ljc0NvbnRlbnQoNSkgKyBgXFxuPCEtLSB1bmlxdWUtJHtpfSAtLT5gO1xyXG5cdFx0XHRcdEljc1BhcnNlci5wYXJzZShjb250ZW50LCB7IC4uLnRlc3RTb3VyY2UsIGlkOiBgdGVzdC0ke2l9YCB9KTtcclxuXHRcdFx0fVxyXG5cdFx0XHRcclxuXHRcdFx0Y29uc3QgY2FjaGVTdGF0c0FmdGVyID0gSWNzUGFyc2VyLmdldENhY2hlU3RhdHMoKTtcclxuXHRcdFx0ZXhwZWN0KGNhY2hlU3RhdHNBZnRlci5zaXplKS50b0JlTGVzc1RoYW5PckVxdWFsKGNhY2hlU3RhdHNBZnRlci5tYXhTaXplKTtcclxuXHRcdFx0XHJcblx0XHRcdGNvbnNvbGUubG9nKGBDYWNoZSBzaXplIGFmdGVyIGZpbGxpbmc6ICR7Y2FjaGVTdGF0c0FmdGVyLnNpemV9LyR7Y2FjaGVTdGF0c0FmdGVyLm1heFNpemV9YCk7XHJcblx0XHR9KTtcclxuXHR9KTtcclxuXHJcblx0ZGVzY3JpYmUoXCJNZW1vcnkgRWZmaWNpZW5jeVwiLCAoKSA9PiB7XHJcblx0XHR0ZXN0KFwic2hvdWxkIGhhbmRsZSBzdHJpbmcgb3BlcmF0aW9ucyBlZmZpY2llbnRseVwiLCAoKSA9PiB7XHJcblx0XHRcdC8vIFRlc3Qgd2l0aCBjb250ZW50IHRoYXQgaGFzIG1hbnkgZm9sZGVkIGxpbmVzXHJcblx0XHRcdGNvbnN0IGZvbGRlZENvbnRlbnQgPSBgQkVHSU46VkNBTEVOREFSXHJcblZFUlNJT046Mi4wXHJcblBST0RJRDotLy9UZXN0Ly9UZXN0IENhbGVuZGFyLy9FTlxyXG5CRUdJTjpWRVZFTlRcclxuVUlEOmZvbGRlZC10ZXN0QHRlc3QuY29tXHJcbkRUU1RBUlQ6MjAyNDAxMDFUMTIwMDAwWlxyXG5TVU1NQVJZOlRoaXMgaXMgYSB2ZXJ5IGxvbmcgc3VtbWFyeSB0aGF0IHdpbGwgYmUgZm9sZGVkIGFjcm9zcyBtdWx0aXBsZVxyXG4gbGluZXMgdG8gdGVzdCB0aGUgdW5mb2xkaW5nIG9wdGltaXphdGlvbiBhbmQgZW5zdXJlIGl0IHdvcmtzIGNvcnJlY3RseVxyXG4gd2l0aCB0aGUgbmV3IGFycmF5LWJhc2VkIGFwcHJvYWNoIGluc3RlYWQgb2Ygc3RyaW5nIGNvbmNhdGVuYXRpb25cclxuREVTQ1JJUFRJT046VGhpcyBpcyBhbHNvIGEgdmVyeSBsb25nIGRlc2NyaXB0aW9uIHRoYXQgc3BhbnMgbXVsdGlwbGVcclxuIGxpbmVzIGFuZCBjb250YWlucyB2YXJpb3VzIGVzY2FwZSBzZXF1ZW5jZXMgbGlrZSBcXFxcbiBuZXdsaW5lcyBhbmQgXFxcXCxcclxuIGNvbW1hcyBhbmQgXFxcXDsgc2VtaWNvbG9ucyB0byB0ZXN0IHRoZSB1bmVzY2FwaW5nIG9wdGltaXphdGlvblxyXG5FTkQ6VkVWRU5UXHJcbkVORDpWQ0FMRU5EQVJgO1xyXG5cclxuXHRcdFx0Y29uc3Qgc3RhcnRUaW1lID0gcGVyZm9ybWFuY2Uubm93KCk7XHJcblx0XHRcdGNvbnN0IHJlc3VsdCA9IEljc1BhcnNlci5wYXJzZShmb2xkZWRDb250ZW50LCB0ZXN0U291cmNlKTtcclxuXHRcdFx0Y29uc3QgZW5kVGltZSA9IHBlcmZvcm1hbmNlLm5vdygpO1xyXG5cdFx0XHRcclxuXHRcdFx0ZXhwZWN0KHJlc3VsdC5ldmVudHMpLnRvSGF2ZUxlbmd0aCgxKTtcclxuXHRcdFx0ZXhwZWN0KHJlc3VsdC5ldmVudHNbMF0uc3VtbWFyeSkudG9Db250YWluKFwiZm9sZGVkIGFjcm9zcyBtdWx0aXBsZSBsaW5lc1wiKTtcclxuXHRcdFx0ZXhwZWN0KHJlc3VsdC5ldmVudHNbMF0uZGVzY3JpcHRpb24pLnRvQ29udGFpbihcIm5ld2xpbmVzXCIpO1xyXG5cdFx0XHRcclxuXHRcdFx0Y29uc29sZS5sb2coYEZvbGRlZCBjb250ZW50IHBhcnNpbmcgdG9vayAkeyhlbmRUaW1lIC0gc3RhcnRUaW1lKS50b0ZpeGVkKDIpfW1zYCk7XHJcblx0XHR9KTtcclxuXHR9KTtcclxufSk7XHJcbiJdfQ==