import { App } from "obsidian";
import { SuggestManager } from "../components/ui/suggest";
import { getSuggestOptionsByTrigger } from "../components/ui/suggest/SpecialCharacterSuggests";
// Mock Obsidian modules
jest.mock("obsidian", () => ({
    App: jest.fn(),
    Editor: jest.fn(),
    TFile: jest.fn(),
    EditorSuggest: class {
        constructor() { }
        getSuggestions() { return []; }
        renderSuggestion() { }
        selectSuggestion() { }
        onTrigger() { return null; }
        close() { }
    },
    setIcon: jest.fn(),
}));
// Mock moment module
jest.mock("moment", () => {
    const moment = function (input) {
        return {
            format: () => "2024-01-01",
            diff: () => 0,
            startOf: () => moment(input),
            endOf: () => moment(input),
            isSame: () => true,
            isSameOrBefore: () => true,
            isSameOrAfter: () => true,
            isBefore: () => false,
            isAfter: () => false,
            isBetween: () => true,
            clone: () => moment(input),
            add: () => moment(input),
            subtract: () => moment(input),
            valueOf: () => Date.now(),
            toDate: () => new Date(),
            weekday: () => 0,
            day: () => 1,
            date: () => 1,
        };
    };
    moment.locale = jest.fn(() => "en");
    moment.utc = () => ({ format: () => "00:00:00" });
    moment.duration = () => ({ asMilliseconds: () => 0 });
    moment.weekdaysShort = () => ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
    moment.weekdaysMin = () => ["Su", "Mo", "Tu", "We", "Th", "Fr", "Sa"];
    return moment;
});
// Mock plugin with realistic data
const mockPlugin = {
    app: {
        workspace: {
            getLastOpenFiles: () => [
                "file1.md",
                "file2.md",
                "file3.md",
                "file4.md",
                "file5.md",
            ],
        },
        metadataCache: {
            getTags: () => ({
                "#work": 10,
                "#personal": 8,
                "#urgent": 5,
                "#important": 7,
                "#project": 12,
                "#meeting": 3,
                "#todo": 15,
                "#review": 4,
            }),
        },
    },
    settings: {
        preferMetadataFormat: "tasks",
    },
};
describe("Suggest Performance Tests", () => {
    let app;
    let manager;
    beforeEach(() => {
        app = new App();
        app.workspace = {
            editorSuggest: {
                suggests: [],
            },
        };
        manager = new SuggestManager(app, mockPlugin);
    });
    afterEach(() => {
        manager.cleanup();
    });
    test("should handle rapid suggest creation and destruction", () => {
        const startTime = performance.now();
        manager.startManaging();
        // Create and destroy 100 suggests rapidly
        for (let i = 0; i < 100; i++) {
            const suggest = manager.createUniversalSuggest(`test-${i}`);
            suggest.enable();
            manager.removeManagedSuggest(`universal-test-${i}`);
        }
        manager.stopManaging();
        const endTime = performance.now();
        const duration = endTime - startTime;
        // Should complete within reasonable time (adjust threshold as needed)
        expect(duration).toBeLessThan(1000); // 1 second
        expect(manager.getActiveSuggests().size).toBe(0);
    });
    test("should efficiently generate suggestions for all trigger characters", () => {
        const triggerChars = ["!", "~", "*", "#"];
        const iterations = 1000;
        const startTime = performance.now();
        for (let i = 0; i < iterations; i++) {
            for (const trigger of triggerChars) {
                const suggestions = getSuggestOptionsByTrigger(trigger, mockPlugin);
                expect(suggestions.length).toBeGreaterThan(0);
            }
        }
        const endTime = performance.now();
        const duration = endTime - startTime;
        // Should generate suggestions efficiently
        expect(duration).toBeLessThan(500); // 500ms for 4000 operations
        console.log(`Generated ${iterations * triggerChars.length} suggestions in ${duration}ms`);
    });
    test("should handle large number of active suggests", () => {
        manager.startManaging();
        const startTime = performance.now();
        // Create 50 active suggests
        const suggests = [];
        for (let i = 0; i < 50; i++) {
            const suggest = manager.createUniversalSuggest(`bulk-test-${i}`);
            suggest.enable();
            suggests.push(suggest);
        }
        expect(manager.getActiveSuggests().size).toBe(50);
        // Cleanup all at once
        manager.removeAllManagedSuggests();
        const endTime = performance.now();
        const duration = endTime - startTime;
        expect(duration).toBeLessThan(100); // Should be very fast
        expect(manager.getActiveSuggests().size).toBe(0);
        console.log(`Managed 50 suggests in ${duration}ms`);
    });
    test("should efficiently handle context filtering", () => {
        const mockEditor = {};
        const mockFile = {};
        // Create context filters
        const filters = [];
        for (let i = 0; i < 100; i++) {
            const filter = (editor, file) => {
                // Simulate some filtering logic
                return editor === mockEditor && file === mockFile;
            };
            manager.addContextFilter(`filter-${i}`, filter);
            filters.push(filter);
        }
        const startTime = performance.now();
        // Test context filtering performance
        for (let i = 0; i < 1000; i++) {
            const suggest = manager.createUniversalSuggest(`context-test-${i % 10}`, {
                contextFilter: filters[i % filters.length],
            });
            // Simulate context check
            const config = suggest.getConfig();
            if (config.contextFilter) {
                config.contextFilter(mockEditor, mockFile);
            }
        }
        const endTime = performance.now();
        const duration = endTime - startTime;
        expect(duration).toBeLessThan(200); // Should be reasonably fast
        console.log(`Context filtering test completed in ${duration}ms`);
        // Cleanup
        for (let i = 0; i < 100; i++) {
            manager.removeContextFilter(`filter-${i}`);
        }
    });
    test("should handle memory efficiently during suggest lifecycle", () => {
        var _a, _b;
        const initialMemory = ((_a = performance.memory) === null || _a === void 0 ? void 0 : _a.usedJSHeapSize) || 0;
        manager.startManaging();
        // Create and destroy suggests in cycles
        for (let cycle = 0; cycle < 10; cycle++) {
            // Create 20 suggests
            for (let i = 0; i < 20; i++) {
                const suggest = manager.createUniversalSuggest(`memory-test-${cycle}-${i}`);
                suggest.enable();
            }
            // Remove all suggests
            manager.removeAllManagedSuggests();
        }
        manager.stopManaging();
        // Force garbage collection if available
        if (global.gc) {
            global.gc();
        }
        const finalMemory = ((_b = performance.memory) === null || _b === void 0 ? void 0 : _b.usedJSHeapSize) || 0;
        const memoryDiff = finalMemory - initialMemory;
        // Memory usage should not grow significantly
        // This is a rough check - actual values depend on environment
        if (initialMemory > 0) {
            expect(memoryDiff).toBeLessThan(1024 * 1024); // Less than 1MB growth
            console.log(`Memory difference: ${memoryDiff} bytes`);
        }
    });
    test("should maintain performance with workspace suggest array manipulation", () => {
        const mockSuggests = Array.from({ length: 100 }, (_, i) => ({ id: `mock-${i}` }));
        app.workspace.editorSuggest.suggests = [...mockSuggests];
        manager.startManaging();
        const startTime = performance.now();
        // Add suggests to beginning of array (high priority)
        for (let i = 0; i < 50; i++) {
            const suggest = manager.createUniversalSuggest(`priority-test-${i}`);
            suggest.enable();
        }
        // Verify they were added to the beginning
        const workspaceSuggests = app.workspace.editorSuggest.suggests;
        expect(workspaceSuggests.length).toBe(150); // 100 original + 50 new
        // Remove all managed suggests
        manager.removeAllManagedSuggests();
        const endTime = performance.now();
        const duration = endTime - startTime;
        // Should handle array manipulation efficiently
        expect(duration).toBeLessThan(50);
        expect(workspaceSuggests.length).toBe(100); // Back to original
        console.log(`Array manipulation completed in ${duration}ms`);
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU3VnZ2VzdFBlcmZvcm1hbmNlLnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJTdWdnZXN0UGVyZm9ybWFuY2UudGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsR0FBRyxFQUFpQixNQUFNLFVBQVUsQ0FBQztBQUM5QyxPQUFPLEVBQUUsY0FBYyxFQUEwQixNQUFNLDBCQUEwQixDQUFDO0FBRWxGLE9BQU8sRUFBRSwwQkFBMEIsRUFBRSxNQUFNLG1EQUFtRCxDQUFDO0FBRS9GLHdCQUF3QjtBQUN4QixJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDO0lBQzVCLEdBQUcsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO0lBQ2QsTUFBTSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7SUFDakIsS0FBSyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7SUFDaEIsYUFBYSxFQUFFO1FBQ2QsZ0JBQWUsQ0FBQztRQUNoQixjQUFjLEtBQUssT0FBTyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQy9CLGdCQUFnQixLQUFJLENBQUM7UUFDckIsZ0JBQWdCLEtBQUksQ0FBQztRQUNyQixTQUFTLEtBQUssT0FBTyxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQzVCLEtBQUssS0FBSSxDQUFDO0tBQ1Y7SUFDRCxPQUFPLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtDQUNsQixDQUFDLENBQUMsQ0FBQztBQUVKLHFCQUFxQjtBQUNyQixJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxHQUFHLEVBQUU7SUFDeEIsTUFBTSxNQUFNLEdBQUcsVUFBUyxLQUFXO1FBQ2xDLE9BQU87WUFDTixNQUFNLEVBQUUsR0FBRyxFQUFFLENBQUMsWUFBWTtZQUMxQixJQUFJLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQztZQUNiLE9BQU8sRUFBRSxHQUFHLEVBQUUsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDO1lB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QUMvQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUMsWUFBWSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ2xDLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxtQkFBbUI7UUFFL0QsT0FBTyxDQUFDLEdBQUcsQ0FBQyxtQ0FBbUMsUUFBUSxJQUFJLENBQUMsQ0FBQztJQUM5RCxDQUFDLENBQUMsQ0FBQztBQUNKLENBQUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQXBwLCBFZGl0b3IsIFRGaWxlIH0gZnJvbSBcIm9ic2lkaWFuXCI7XHJcbmltcG9ydCB7IFN1Z2dlc3RNYW5hZ2VyLCBVbml2ZXJzYWxFZGl0b3JTdWdnZXN0IH0gZnJvbSBcIi4uL2NvbXBvbmVudHMvdWkvc3VnZ2VzdFwiO1xyXG5pbXBvcnQgVGFza1Byb2dyZXNzQmFyUGx1Z2luIGZyb20gXCIuLi9pbmRleFwiO1xyXG5pbXBvcnQgeyBnZXRTdWdnZXN0T3B0aW9uc0J5VHJpZ2dlciB9IGZyb20gXCIuLi9jb21wb25lbnRzL3VpL3N1Z2dlc3QvU3BlY2lhbENoYXJhY3RlclN1Z2dlc3RzXCI7XHJcblxyXG4vLyBNb2NrIE9ic2lkaWFuIG1vZHVsZXNcclxuamVzdC5tb2NrKFwib2JzaWRpYW5cIiwgKCkgPT4gKHtcclxuXHRBcHA6IGplc3QuZm4oKSxcclxuXHRFZGl0b3I6IGplc3QuZm4oKSxcclxuXHRURmlsZTogamVzdC5mbigpLFxyXG5cdEVkaXRvclN1Z2dlc3Q6IGNsYXNzIHtcclxuXHRcdGNvbnN0cnVjdG9yKCkge31cclxuXHRcdGdldFN1Z2dlc3Rpb25zKCkgeyByZXR1cm4gW107IH1cclxuXHRcdHJlbmRlclN1Z2dlc3Rpb24oKSB7fVxyXG5cdFx0c2VsZWN0U3VnZ2VzdGlvbigpIHt9XHJcblx0XHRvblRyaWdnZXIoKSB7IHJldHVybiBudWxsOyB9XHJcblx0XHRjbG9zZSgpIHt9XHJcblx0fSxcclxuXHRzZXRJY29uOiBqZXN0LmZuKCksXHJcbn0pKTtcclxuXHJcbi8vIE1vY2sgbW9tZW50IG1vZHVsZVxyXG5qZXN0Lm1vY2soXCJtb21lbnRcIiwgKCkgPT4ge1xyXG5cdGNvbnN0IG1vbWVudCA9IGZ1bmN0aW9uKGlucHV0PzogYW55KSB7XHJcblx0XHRyZXR1cm4ge1xyXG5cdFx0XHRmb3JtYXQ6ICgpID0+IFwiMjAyNC0wMS0wMVwiLFxyXG5cdFx0XHRkaWZmOiAoKSA9PiAwLFxyXG5cdFx0XHRzdGFydE9mOiAoKSA9PiBtb21lbnQoaW5wdXQpLFxyXG5cdFx0XHRlbmRPZjogKCkgPT4gbW9tZW50KGlucHV0KSxcclxuXHRcdFx0aXNTYW1lOiAoKSA9PiB0cnVlLFxyXG5cdFx0XHRpc1NhbWVPckJlZm9yZTogKCkgPT4gdHJ1ZSxcclxuXHRcdFx0aXNTYW1lT3JBZnRlcjogKCkgPT4gdHJ1ZSxcclxuXHRcdFx0aXNCZWZvcmU6ICgpID0+IGZhbHNlLFxyXG5cdFx0XHRpc0FmdGVyOiAoKSA9PiBmYWxzZSxcclxuXHRcdFx0aXNCZXR3ZWVuOiAoKSA9PiB0cnVlLFxyXG5cdFx0XHRjbG9uZTogKCkgPT4gbW9tZW50KGlucHV0KSxcclxuXHRcdFx0YWRkOiAoKSA9PiBtb21lbnQoaW5wdXQpLFxyXG5cdFx0XHRzdWJ0cmFjdDogKCkgPT4gbW9tZW50KGlucHV0KSxcclxuXHRcdFx0dmFsdWVPZjogKCkgPT4gRGF0ZS5ub3coKSxcclxuXHRcdFx0dG9EYXRlOiAoKSA9PiBuZXcgRGF0ZSgpLFxyXG5cdFx0XHR3ZWVrZGF5OiAoKSA9PiAwLFxyXG5cdFx0XHRkYXk6ICgpID0+IDEsXHJcblx0XHRcdGRhdGU6ICgpID0+IDEsXHJcblx0XHR9O1xyXG5cdH07XHJcblx0bW9tZW50LmxvY2FsZSA9IGplc3QuZm4oKCkgPT4gXCJlblwiKTtcclxuXHRtb21lbnQudXRjID0gKCkgPT4gKHsgZm9ybWF0OiAoKSA9PiBcIjAwOjAwOjAwXCIgfSk7XHJcblx0bW9tZW50LmR1cmF0aW9uID0gKCkgPT4gKHsgYXNNaWxsaXNlY29uZHM6ICgpID0+IDAgfSk7XHJcblx0bW9tZW50LndlZWtkYXlzU2hvcnQgPSAoKSA9PiBbXCJTdW5cIiwgXCJNb25cIiwgXCJUdWVcIiwgXCJXZWRcIiwgXCJUaHVcIiwgXCJGcmlcIiwgXCJTYXRcIl07XHJcblx0bW9tZW50LndlZWtkYXlzTWluID0gKCkgPT4gW1wiU3VcIiwgXCJNb1wiLCBcIlR1XCIsIFwiV2VcIiwgXCJUaFwiLCBcIkZyXCIsIFwiU2FcIl07XHJcblx0cmV0dXJuIG1vbWVudDtcclxufSk7XHJcblxyXG4vLyBNb2NrIHBsdWdpbiB3aXRoIHJlYWxpc3RpYyBkYXRhXHJcbmNvbnN0IG1vY2tQbHVnaW4gPSB7XHJcblx0YXBwOiB7XHJcblx0XHR3b3Jrc3BhY2U6IHtcclxuXHRcdFx0Z2V0TGFzdE9wZW5GaWxlczogKCkgPT4gW1xyXG5cdFx0XHRcdFwiZmlsZTEubWRcIixcclxuXHRcdFx0XHRcImZpbGUyLm1kXCIsXHJcblx0XHRcdFx0XCJmaWxlMy5tZFwiLFxyXG5cdFx0XHRcdFwiZmlsZTQubWRcIixcclxuXHRcdFx0XHRcImZpbGU1Lm1kXCIsXHJcblx0XHRcdF0sXHJcblx0XHR9LFxyXG5cdFx0bWV0YWRhdGFDYWNoZToge1xyXG5cdFx0XHRnZXRUYWdzOiAoKSA9PiAoe1xyXG5cdFx0XHRcdFwiI3dvcmtcIjogMTAsXHJcblx0XHRcdFx0XCIjcGVyc29uYWxcIjogOCxcclxuXHRcdFx0XHRcIiN1cmdlbnRcIjogNSxcclxuXHRcdFx0XHRcIiNpbXBvcnRhbnRcIjogNyxcclxuXHRcdFx0XHRcIiNwcm9qZWN0XCI6IDEyLFxyXG5cdFx0XHRcdFwiI21lZXRpbmdcIjogMyxcclxuXHRcdFx0XHRcIiN0b2RvXCI6IDE1LFxyXG5cdFx0XHRcdFwiI3Jldmlld1wiOiA0LFxyXG5cdFx0XHR9KSxcclxuXHRcdH0sXHJcblx0fSxcclxuXHRzZXR0aW5nczoge1xyXG5cdFx0cHJlZmVyTWV0YWRhdGFGb3JtYXQ6IFwidGFza3NcIixcclxuXHR9LFxyXG59IGFzIGFueSBhcyBUYXNrUHJvZ3Jlc3NCYXJQbHVnaW47XHJcblxyXG5kZXNjcmliZShcIlN1Z2dlc3QgUGVyZm9ybWFuY2UgVGVzdHNcIiwgKCkgPT4ge1xyXG5cdGxldCBhcHA6IEFwcDtcclxuXHRsZXQgbWFuYWdlcjogU3VnZ2VzdE1hbmFnZXI7XHJcblxyXG5cdGJlZm9yZUVhY2goKCkgPT4ge1xyXG5cdFx0YXBwID0gbmV3IEFwcCgpO1xyXG5cdFx0KGFwcCBhcyBhbnkpLndvcmtzcGFjZSA9IHtcclxuXHRcdFx0ZWRpdG9yU3VnZ2VzdDoge1xyXG5cdFx0XHRcdHN1Z2dlc3RzOiBbXSxcclxuXHRcdFx0fSxcclxuXHRcdH07XHJcblx0XHRtYW5hZ2VyID0gbmV3IFN1Z2dlc3RNYW5hZ2VyKGFwcCwgbW9ja1BsdWdpbik7XHJcblx0fSk7XHJcblxyXG5cdGFmdGVyRWFjaCgoKSA9PiB7XHJcblx0XHRtYW5hZ2VyLmNsZWFudXAoKTtcclxuXHR9KTtcclxuXHJcblx0dGVzdChcInNob3VsZCBoYW5kbGUgcmFwaWQgc3VnZ2VzdCBjcmVhdGlvbiBhbmQgZGVzdHJ1Y3Rpb25cIiwgKCkgPT4ge1xyXG5cdFx0Y29uc3Qgc3RhcnRUaW1lID0gcGVyZm9ybWFuY2Uubm93KCk7XHJcblx0XHRcclxuXHRcdG1hbmFnZXIuc3RhcnRNYW5hZ2luZygpO1xyXG5cdFx0XHJcblx0XHQvLyBDcmVhdGUgYW5kIGRlc3Ryb3kgMTAwIHN1Z2dlc3RzIHJhcGlkbHlcclxuXHRcdGZvciAobGV0IGkgPSAwOyBpIDwgMTAwOyBpKyspIHtcclxuXHRcdFx0Y29uc3Qgc3VnZ2VzdCA9IG1hbmFnZXIuY3JlYXRlVW5pdmVyc2FsU3VnZ2VzdChgdGVzdC0ke2l9YCk7XHJcblx0XHRcdHN1Z2dlc3QuZW5hYmxlKCk7XHJcblx0XHRcdG1hbmFnZXIucmVtb3ZlTWFuYWdlZFN1Z2dlc3QoYHVuaXZlcnNhbC10ZXN0LSR7aX1gKTtcclxuXHRcdH1cclxuXHRcdFxyXG5cdFx0bWFuYWdlci5zdG9wTWFuYWdpbmcoKTtcclxuXHRcdFxyXG5cdFx0Y29uc3QgZW5kVGltZSA9IHBlcmZvcm1hbmNlLm5vdygpO1xyXG5cdFx0Y29uc3QgZHVyYXRpb24gPSBlbmRUaW1lIC0gc3RhcnRUaW1lO1xyXG5cdFx0XHJcblx0XHQvLyBTaG91bGQgY29tcGxldGUgd2l0aGluIHJlYXNvbmFibGUgdGltZSAoYWRqdXN0IHRocmVzaG9sZCBhcyBuZWVkZWQpXHJcblx0XHRleHBlY3QoZHVyYXRpb24pLnRvQmVMZXNzVGhhbigxMDAwKTsgLy8gMSBzZWNvbmRcclxuXHRcdGV4cGVjdChtYW5hZ2VyLmdldEFjdGl2ZVN1Z2dlc3RzKCkuc2l6ZSkudG9CZSgwKTtcclxuXHR9KTtcclxuXHJcblx0dGVzdChcInNob3VsZCBlZmZpY2llbnRseSBnZW5lcmF0ZSBzdWdnZXN0aW9ucyBmb3IgYWxsIHRyaWdnZXIgY2hhcmFjdGVyc1wiLCAoKSA9PiB7XHJcblx0XHRjb25zdCB0cmlnZ2VyQ2hhcnMgPSBbXCIhXCIsIFwiflwiLCBcIipcIiwgXCIjXCJdO1xyXG5cdFx0Y29uc3QgaXRlcmF0aW9ucyA9IDEwMDA7XHJcblx0XHRcclxuXHRcdGNvbnN0IHN0YXJ0VGltZSA9IHBlcmZvcm1hbmNlLm5vdygpO1xyXG5cdFx0XHJcblx0XHRmb3IgKGxldCBpID0gMDsgaSA8IGl0ZXJhdGlvbnM7IGkrKykge1xyXG5cdFx0XHRmb3IgKGNvbnN0IHRyaWdnZXIgb2YgdHJpZ2dlckNoYXJzKSB7XHJcblx0XHRcdFx0Y29uc3Qgc3VnZ2VzdGlvbnMgPSBnZXRTdWdnZXN0T3B0aW9uc0J5VHJpZ2dlcih0cmlnZ2VyLCBtb2NrUGx1Z2luKTtcclxuXHRcdFx0XHRleHBlY3Qoc3VnZ2VzdGlvbnMubGVuZ3RoKS50b0JlR3JlYXRlclRoYW4oMCk7XHJcblx0XHRcdH1cclxuXHRcdH1cclxuXHRcdFxyXG5cdFx0Y29uc3QgZW5kVGltZSA9IHBlcmZvcm1hbmNlLm5vdygpO1xyXG5cdFx0Y29uc3QgZHVyYXRpb24gPSBlbmRUaW1lIC0gc3RhcnRUaW1lO1xyXG5cdFx0XHJcblx0XHQvLyBTaG91bGQgZ2VuZXJhdGUgc3VnZ2VzdGlvbnMgZWZmaWNpZW50bHlcclxuXHRcdGV4cGVjdChkdXJhdGlvbikudG9CZUxlc3NUaGFuKDUwMCk7IC8vIDUwMG1zIGZvciA0MDAwIG9wZXJhdGlvbnNcclxuXHRcdFxyXG5cdFx0Y29uc29sZS5sb2coYEdlbmVyYXRlZCAke2l0ZXJhdGlvbnMgKiB0cmlnZ2VyQ2hhcnMubGVuZ3RofSBzdWdnZXN0aW9ucyBpbiAke2R1cmF0aW9ufW1zYCk7XHJcblx0fSk7XHJcblxyXG5cdHRlc3QoXCJzaG91bGQgaGFuZGxlIGxhcmdlIG51bWJlciBvZiBhY3RpdmUgc3VnZ2VzdHNcIiwgKCkgPT4ge1xyXG5cdFx0bWFuYWdlci5zdGFydE1hbmFnaW5nKCk7XHJcblx0XHRcclxuXHRcdGNvbnN0IHN0YXJ0VGltZSA9IHBlcmZvcm1hbmNlLm5vdygpO1xyXG5cdFx0XHJcblx0XHQvLyBDcmVhdGUgNTAgYWN0aXZlIHN1Z2dlc3RzXHJcblx0XHRjb25zdCBzdWdnZXN0czogVW5pdmVyc2FsRWRpdG9yU3VnZ2VzdFtdID0gW107XHJcblx0XHRmb3IgKGxldCBpID0gMDsgaSA8IDUwOyBpKyspIHtcclxuXHRcdFx0Y29uc3Qgc3VnZ2VzdCA9IG1hbmFnZXIuY3JlYXRlVW5pdmVyc2FsU3VnZ2VzdChgYnVsay10ZXN0LSR7aX1gKTtcclxuXHRcdFx0c3VnZ2VzdC5lbmFibGUoKTtcclxuXHRcdFx0c3VnZ2VzdHMucHVzaChzdWdnZXN0KTtcclxuXHRcdH1cclxuXHRcdFxyXG5cdFx0ZXhwZWN0KG1hbmFnZXIuZ2V0QWN0aXZlU3VnZ2VzdHMoKS5zaXplKS50b0JlKDUwKTtcclxuXHRcdFxyXG5cdFx0Ly8gQ2xlYW51cCBhbGwgYXQgb25jZVxyXG5cdFx0bWFuYWdlci5yZW1vdmVBbGxNYW5hZ2VkU3VnZ2VzdHMoKTtcclxuXHRcdFxyXG5cdFx0Y29uc3QgZW5kVGltZSA9IHBlcmZvcm1hbmNlLm5vdygpO1xyXG5cdFx0Y29uc3QgZHVyYXRpb24gPSBlbmRUaW1lIC0gc3RhcnRUaW1lO1xyXG5cdFx0XHJcblx0XHRleHBlY3QoZHVyYXRpb24pLnRvQmVMZXNzVGhhbigxMDApOyAvLyBTaG91bGQgYmUgdmVyeSBmYXN0XHJcblx0XHRleHBlY3QobWFuYWdlci5nZXRBY3RpdmVTdWdnZXN0cygpLnNpemUpLnRvQmUoMCk7XHJcblx0XHRcclxuXHRcdGNvbnNvbGUubG9nKGBNYW5hZ2VkIDUwIHN1Z2dlc3RzIGluICR7ZHVyYXRpb259bXNgKTtcclxuXHR9KTtcclxuXHJcblx0dGVzdChcInNob3VsZCBlZmZpY2llbnRseSBoYW5kbGUgY29udGV4dCBmaWx0ZXJpbmdcIiwgKCkgPT4ge1xyXG5cdFx0Y29uc3QgbW9ja0VkaXRvciA9IHt9IGFzIEVkaXRvcjtcclxuXHRcdGNvbnN0IG1vY2tGaWxlID0ge30gYXMgVEZpbGU7XHJcblx0XHRcclxuXHRcdC8vIENyZWF0ZSBjb250ZXh0IGZpbHRlcnNcclxuXHRcdGNvbnN0IGZpbHRlcnMgPSBbXTtcclxuXHRcdGZvciAobGV0IGkgPSAwOyBpIDwgMTAwOyBpKyspIHtcclxuXHRcdFx0Y29uc3QgZmlsdGVyID0gKGVkaXRvcjogRWRpdG9yLCBmaWxlOiBURmlsZSkgPT4ge1xyXG5cdFx0XHRcdC8vIFNpbXVsYXRlIHNvbWUgZmlsdGVyaW5nIGxvZ2ljXHJcblx0XHRcdFx0cmV0dXJuIGVkaXRvciA9PT0gbW9ja0VkaXRvciAmJiBmaWxlID09PSBtb2NrRmlsZTtcclxuXHRcdFx0fTtcclxuXHRcdFx0bWFuYWdlci5hZGRDb250ZXh0RmlsdGVyKGBmaWx0ZXItJHtpfWAsIGZpbHRlcik7XHJcblx0XHRcdGZpbHRlcnMucHVzaChmaWx0ZXIpO1xyXG5cdFx0fVxyXG5cdFx0XHJcblx0XHRjb25zdCBzdGFydFRpbWUgPSBwZXJmb3JtYW5jZS5ub3coKTtcclxuXHRcdFxyXG5cdFx0Ly8gVGVzdCBjb250ZXh0IGZpbHRlcmluZyBwZXJmb3JtYW5jZVxyXG5cdFx0Zm9yIChsZXQgaSA9IDA7IGkgPCAxMDAwOyBpKyspIHtcclxuXHRcdFx0Y29uc3Qgc3VnZ2VzdCA9IG1hbmFnZXIuY3JlYXRlVW5pdmVyc2FsU3VnZ2VzdChgY29udGV4dC10ZXN0LSR7aSAlIDEwfWAsIHtcclxuXHRcdFx0XHRjb250ZXh0RmlsdGVyOiBmaWx0ZXJzW2kgJSBmaWx0ZXJzLmxlbmd0aF0sXHJcblx0XHRcdH0pO1xyXG5cdFx0XHQvLyBTaW11bGF0ZSBjb250ZXh0IGNoZWNrXHJcblx0XHRcdGNvbnN0IGNvbmZpZyA9IHN1Z2dlc3QuZ2V0Q29uZmlnKCk7XHJcblx0XHRcdGlmIChjb25maWcuY29udGV4dEZpbHRlcikge1xyXG5cdFx0XHRcdGNvbmZpZy5jb250ZXh0RmlsdGVyKG1vY2tFZGl0b3IsIG1vY2tGaWxlKTtcclxuXHRcdFx0fVxyXG5cdFx0fVxyXG5cdFx0XHJcblx0XHRjb25zdCBlbmRUaW1lID0gcGVyZm9ybWFuY2Uubm93KCk7XHJcblx0XHRjb25zdCBkdXJhdGlvbiA9IGVuZFRpbWUgLSBzdGFydFRpbWU7XHJcblx0XHRcclxuXHRcdGV4cGVjdChkdXJhdGlvbikudG9CZUxlc3NUaGFuKDIwMCk7IC8vIFNob3VsZCBiZSByZWFzb25hYmx5IGZhc3RcclxuXHRcdFxyXG5cdFx0Y29uc29sZS5sb2coYENvbnRleHQgZmlsdGVyaW5nIHRlc3QgY29tcGxldGVkIGluICR7ZHVyYXRpb259bXNgKTtcclxuXHRcdFxyXG5cdFx0Ly8gQ2xlYW51cFxyXG5cdFx0Zm9yIChsZXQgaSA9IDA7IGkgPCAxMDA7IGkrKykge1xyXG5cdFx0XHRtYW5hZ2VyLnJlbW92ZUNvbnRleHRGaWx0ZXIoYGZpbHRlci0ke2l9YCk7XHJcblx0XHR9XHJcblx0fSk7XHJcblxyXG5cdHRlc3QoXCJzaG91bGQgaGFuZGxlIG1lbW9yeSBlZmZpY2llbnRseSBkdXJpbmcgc3VnZ2VzdCBsaWZlY3ljbGVcIiwgKCkgPT4ge1xyXG5cdFx0Y29uc3QgaW5pdGlhbE1lbW9yeSA9IChwZXJmb3JtYW5jZSBhcyBhbnkpLm1lbW9yeT8udXNlZEpTSGVhcFNpemUgfHwgMDtcclxuXHRcdFxyXG5cdFx0bWFuYWdlci5zdGFydE1hbmFnaW5nKCk7XHJcblx0XHRcclxuXHRcdC8vIENyZWF0ZSBhbmQgZGVzdHJveSBzdWdnZXN0cyBpbiBjeWNsZXNcclxuXHRcdGZvciAobGV0IGN5Y2xlID0gMDsgY3ljbGUgPCAxMDsgY3ljbGUrKykge1xyXG5cdFx0XHQvLyBDcmVhdGUgMjAgc3VnZ2VzdHNcclxuXHRcdFx0Zm9yIChsZXQgaSA9IDA7IGkgPCAyMDsgaSsrKSB7XHJcblx0XHRcdFx0Y29uc3Qgc3VnZ2VzdCA9IG1hbmFnZXIuY3JlYXRlVW5pdmVyc2FsU3VnZ2VzdChgbWVtb3J5LXRlc3QtJHtjeWNsZX0tJHtpfWApO1xyXG5cdFx0XHRcdHN1Z2dlc3QuZW5hYmxlKCk7XHJcblx0XHRcdH1cclxuXHRcdFx0XHJcblx0XHRcdC8vIFJlbW92ZSBhbGwgc3VnZ2VzdHNcclxuXHRcdFx0bWFuYWdlci5yZW1vdmVBbGxNYW5hZ2VkU3VnZ2VzdHMoKTtcclxuXHRcdH1cclxuXHRcdFxyXG5cdFx0bWFuYWdlci5zdG9wTWFuYWdpbmcoKTtcclxuXHRcdFxyXG5cdFx0Ly8gRm9yY2UgZ2FyYmFnZSBjb2xsZWN0aW9uIGlmIGF2YWlsYWJsZVxyXG5cdFx0aWYgKGdsb2JhbC5nYykge1xyXG5cdFx0XHRnbG9iYWwuZ2MoKTtcclxuXHRcdH1cclxuXHRcdFxyXG5cdFx0Y29uc3QgZmluYWxNZW1vcnkgPSAocGVyZm9ybWFuY2UgYXMgYW55KS5tZW1vcnk/LnVzZWRKU0hlYXBTaXplIHx8IDA7XHJcblx0XHRjb25zdCBtZW1vcnlEaWZmID0gZmluYWxNZW1vcnkgLSBpbml0aWFsTWVtb3J5O1xyXG5cdFx0XHJcblx0XHQvLyBNZW1vcnkgdXNhZ2Ugc2hvdWxkIG5vdCBncm93IHNpZ25pZmljYW50bHlcclxuXHRcdC8vIFRoaXMgaXMgYSByb3VnaCBjaGVjayAtIGFjdHVhbCB2YWx1ZXMgZGVwZW5kIG9uIGVudmlyb25tZW50XHJcblx0XHRpZiAoaW5pdGlhbE1lbW9yeSA+IDApIHtcclxuXHRcdFx0ZXhwZWN0KG1lbW9yeURpZmYpLnRvQmVMZXNzVGhhbigxMDI0ICogMTAyNCk7IC8vIExlc3MgdGhhbiAxTUIgZ3Jvd3RoXHJcblx0XHRcdGNvbnNvbGUubG9nKGBNZW1vcnkgZGlmZmVyZW5jZTogJHttZW1vcnlEaWZmfSBieXRlc2ApO1xyXG5cdFx0fVxyXG5cdH0pO1xyXG5cclxuXHR0ZXN0KFwic2hvdWxkIG1haW50YWluIHBlcmZvcm1hbmNlIHdpdGggd29ya3NwYWNlIHN1Z2dlc3QgYXJyYXkgbWFuaXB1bGF0aW9uXCIsICgpID0+IHtcclxuXHRcdGNvbnN0IG1vY2tTdWdnZXN0cyA9IEFycmF5LmZyb20oeyBsZW5ndGg6IDEwMCB9LCAoXywgaSkgPT4gKHsgaWQ6IGBtb2NrLSR7aX1gIH0pKTtcclxuXHRcdChhcHAgYXMgYW55KS53b3Jrc3BhY2UuZWRpdG9yU3VnZ2VzdC5zdWdnZXN0cyA9IFsuLi5tb2NrU3VnZ2VzdHNdO1xyXG5cdFx0XHJcblx0XHRtYW5hZ2VyLnN0YXJ0TWFuYWdpbmcoKTtcclxuXHRcdFxyXG5cdFx0Y29uc3Qgc3RhcnRUaW1lID0gcGVyZm9ybWFuY2Uubm93KCk7XHJcblx0XHRcclxuXHRcdC8vIEFkZCBzdWdnZXN0cyB0byBiZWdpbm5pbmcgb2YgYXJyYXkgKGhpZ2ggcHJpb3JpdHkpXHJcblx0XHRmb3IgKGxldCBpID0gMDsgaSA8IDUwOyBpKyspIHtcclxuXHRcdFx0Y29uc3Qgc3VnZ2VzdCA9IG1hbmFnZXIuY3JlYXRlVW5pdmVyc2FsU3VnZ2VzdChgcHJpb3JpdHktdGVzdC0ke2l9YCk7XHJcblx0XHRcdHN1Z2dlc3QuZW5hYmxlKCk7XHJcblx0XHR9XHJcblx0XHRcclxuXHRcdC8vIFZlcmlmeSB0aGV5IHdlcmUgYWRkZWQgdG8gdGhlIGJlZ2lubmluZ1xyXG5cdFx0Y29uc3Qgd29ya3NwYWNlU3VnZ2VzdHMgPSAoYXBwIGFzIGFueSkud29ya3NwYWNlLmVkaXRvclN1Z2dlc3Quc3VnZ2VzdHM7XHJcblx0XHRleHBlY3Qod29ya3NwYWNlU3VnZ2VzdHMubGVuZ3RoKS50b0JlKDE1MCk7IC8vIDEwMCBvcmlnaW5hbCArIDUwIG5ld1xyXG5cdFx0XHJcblx0XHQvLyBSZW1vdmUgYWxsIG1hbmFnZWQgc3VnZ2VzdHNcclxuXHRcdG1hbmFnZXIucmVtb3ZlQWxsTWFuYWdlZFN1Z2dlc3RzKCk7XHJcblx0XHRcclxuXHRcdGNvbnN0IGVuZFRpbWUgPSBwZXJmb3JtYW5jZS5ub3coKTtcclxuXHRcdGNvbnN0IGR1cmF0aW9uID0gZW5kVGltZSAtIHN0YXJ0VGltZTtcclxuXHRcdFxyXG5cdFx0Ly8gU2hvdWxkIGhhbmRsZSBhcnJheSBtYW5pcHVsYXRpb24gZWZmaWNpZW50bHlcclxuXHRcdGV4cGVjdChkdXJhdGlvbikudG9CZUxlc3NUaGFuKDUwKTtcclxuXHRcdGV4cGVjdCh3b3Jrc3BhY2VTdWdnZXN0cy5sZW5ndGgpLnRvQmUoMTAwKTsgLy8gQmFjayB0byBvcmlnaW5hbFxyXG5cdFx0XHJcblx0XHRjb25zb2xlLmxvZyhgQXJyYXkgbWFuaXB1bGF0aW9uIGNvbXBsZXRlZCBpbiAke2R1cmF0aW9ufW1zYCk7XHJcblx0fSk7XHJcbn0pO1xyXG4iXX0=