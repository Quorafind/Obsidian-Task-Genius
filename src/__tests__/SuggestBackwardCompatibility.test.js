import { App } from "obsidian";
import { MinimalQuickCaptureSuggest } from "../components/features/quick-capture/suggest/MinimalQuickCaptureSuggest";
// Mock Obsidian modules
jest.mock("obsidian", () => ({
    App: jest.fn(),
    Editor: jest.fn(),
    EditorPosition: jest.fn(),
    EditorSuggest: class {
        constructor() { }
        getSuggestions() { return []; }
        renderSuggestion() { }
        selectSuggestion() { }
        onTrigger() { return null; }
        close() { }
    },
    setIcon: jest.fn(),
}));
// Mock moment module
jest.mock("moment", () => {
    const moment = function (input) {
        return {
            format: () => "2024-01-01",
            diff: () => 0,
            startOf: () => moment(input),
            endOf: () => moment(input),
            isSame: () => true,
            isSameOrBefore: () => true,
            isSameOrAfter: () => true,
            isBefore: () => false,
            isAfter: () => false,
            isBetween: () => true,
            clone: () => moment(input),
            add: () => moment(input),
            subtract: () => moment(input),
            valueOf: () => Date.now(),
            toDate: () => new Date(),
            weekday: () => 0,
            day: () => 1,
            date: () => 1,
        };
    };
    moment.locale = jest.fn(() => "en");
    moment.utc = () => ({ format: () => "00:00:00" });
    moment.duration = () => ({ asMilliseconds: () => 0 });
    moment.weekdaysShort = () => ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
    moment.weekdaysMin = () => ["Su", "Mo", "Tu", "We", "Th", "Fr", "Sa"];
    return moment;
});
// Mock plugin
const mockPlugin = {
    app: {
        workspace: {
            getLastOpenFiles: () => ["test1.md", "test2.md"],
        },
        metadataCache: {
            getTags: () => ({
                "#work": 5,
                "#personal": 3,
            }),
        },
    },
    settings: {
        quickCapture: {
            minimalModeSettings: {
                suggestTrigger: "/",
            },
        },
        preferMetadataFormat: "tasks",
    },
};
describe("Backward Compatibility Tests", () => {
    let suggest;
    let app;
    beforeEach(() => {
        app = new App();
        suggest = new MinimalQuickCaptureSuggest(app, mockPlugin);
    });
    test("should maintain original MinimalQuickCaptureSuggest interface", () => {
        // Test that all original methods exist
        expect(typeof suggest.setMinimalMode).toBe("function");
        expect(typeof suggest.onTrigger).toBe("function");
        expect(typeof suggest.getSuggestions).toBe("function");
        expect(typeof suggest.renderSuggestion).toBe("function");
        expect(typeof suggest.selectSuggestion).toBe("function");
    });
    test("should handle legacy @ trigger mapping to * for target", () => {
        suggest.setMinimalMode(true);
        const mockContext = {
            query: "@",
            start: { line: 0, ch: 0 },
            end: { line: 0, ch: 1 },
            editor: {},
            file: {},
        };
        const suggestions = suggest.getSuggestions(mockContext);
        // Should return target suggestions when @ is used
        expect(suggestions.length).toBeGreaterThan(0);
        expect(suggestions.some(s => s.id.includes("target") || s.replacement === "*")).toBe(true);
    });
    test("should provide fallback suggestions when new system returns empty", () => {
        suggest.setMinimalMode(true);
        // Test with an unknown trigger that would return empty from new system
        const mockContext = {
            query: "unknown",
            start: { line: 0, ch: 0 },
            end: { line: 0, ch: 1 },
            editor: {},
            file: {},
        };
        const suggestions = suggest.getSuggestions(mockContext);
        // Should return fallback suggestions
        expect(suggestions.length).toBe(4); // date, priority, target, tag
        expect(suggestions.map(s => s.id)).toEqual(["date", "priority", "target", "tag"]);
    });
    test("should handle selectSuggestion with both new and legacy actions", () => {
        const mockEditor = {
            replaceRange: jest.fn(),
            setCursor: jest.fn(),
        };
        const mockCursor = { line: 0, ch: 1 };
        // Mock the context
        suggest.context = {
            editor: mockEditor,
            end: mockCursor,
        };
        // Test with new system suggestion (has action)
        const newSuggestion = {
            id: "priority-high",
            label: "High Priority",
            icon: "arrow-up",
            description: "High priority task",
            replacement: "! ⏫",
            trigger: "!",
            action: jest.fn(),
        };
        suggest.selectSuggestion(newSuggestion, {});
        expect(mockEditor.replaceRange).toHaveBeenCalledWith("! ⏫", { line: 0, ch: 0 }, { line: 0, ch: 1 });
        expect(mockEditor.setCursor).toHaveBeenCalledWith({ line: 0, ch: 4 });
        expect(newSuggestion.action).toHaveBeenCalledWith(mockEditor, { line: 0, ch: 4 });
    });
    test("should handle legacy modal-based actions", () => {
        const mockEditor = {
            replaceRange: jest.fn(),
            setCursor: jest.fn(),
        };
        const mockCursor = { line: 0, ch: 1 };
        // Mock the context
        suggest.context = {
            editor: mockEditor,
            end: mockCursor,
        };
        // Mock the modal element and modal instance
        const mockModal = {
            showDatePickerAtCursor: jest.fn(),
            showPriorityMenuAtCursor: jest.fn(),
            showLocationMenuAtCursor: jest.fn(),
            showTagSelectorAtCursor: jest.fn(),
        };
        const mockModalEl = {
            closest: jest.fn().mockReturnValue({
                __minimalQuickCaptureModal: mockModal,
            }),
        };
        const mockEditorEl = {
            cm: {
                dom: mockModalEl,
            },
            coordsAtPos: jest.fn().mockReturnValue({ left: 100, top: 200 }),
        };
        mockEditor.cm = { dom: mockModalEl };
        mockEditor.coordsAtPos = mockEditorEl.coordsAtPos;
        // Test legacy date suggestion
        const dateSuggestion = {
            id: "date",
            label: "Date",
            icon: "calendar",
            description: "Add date",
            replacement: "~",
        };
        suggest.selectSuggestion(dateSuggestion, {});
        expect(mockEditor.replaceRange).toHaveBeenCalledWith("~", { line: 0, ch: 0 }, { line: 0, ch: 1 });
        expect(mockModal.showDatePickerAtCursor).toHaveBeenCalled();
    });
    test("should maintain original trigger character behavior", () => {
        const mockEditor = {
            getLine: jest.fn().mockReturnValue("test /"),
        };
        const mockFile = {};
        const mockCursor = { line: 0, ch: 6 };
        // Mock minimal mode context
        mockEditor.cm = {
            dom: {
                closest: jest.fn().mockReturnValue({}),
            },
        };
        suggest.setMinimalMode(true);
        const triggerInfo = suggest.onTrigger(mockCursor, mockEditor, mockFile);
        expect(triggerInfo).toEqual({
            start: { line: 0, ch: 5 },
            end: { line: 0, ch: 6 },
            query: "/",
        });
    });
    test("should handle disabled state correctly", () => {
        const mockEditor = {};
        const mockFile = {};
        const mockCursor = { line: 0, ch: 1 };
        // When not in minimal mode, should return null
        suggest.setMinimalMode(false);
        const triggerInfo = suggest.onTrigger(mockCursor, mockEditor, mockFile);
        expect(triggerInfo).toBeNull();
    });
    test("should render suggestions with correct DOM structure", () => {
        const mockEl = {
            addClass: jest.fn(),
            createDiv: jest.fn().mockReturnValue({
                createDiv: jest.fn(),
            }),
        };
        const suggestion = {
            id: "test",
            label: "Test Label",
            icon: "star",
            description: "Test Description",
            replacement: "test",
        };
        suggest.renderSuggestion(suggestion, mockEl);
        expect(mockEl.addClass).toHaveBeenCalledWith("menu-item");
        expect(mockEl.addClass).toHaveBeenCalledWith("tappable");
        expect(mockEl.createDiv).toHaveBeenCalledWith("menu-item-icon");
    });
    test("should integrate with new suggest system while maintaining compatibility", () => {
        suggest.setMinimalMode(true);
        // Test all original trigger characters
        const triggerChars = ["!", "~", "#"];
        for (const trigger of triggerChars) {
            const mockContext = {
                query: trigger,
                start: { line: 0, ch: 0 },
                end: { line: 0, ch: 1 },
                editor: {},
                file: {},
            };
            const suggestions = suggest.getSuggestions(mockContext);
            expect(suggestions.length).toBeGreaterThan(0);
            // Should have suggestions that match the trigger
            const hasMatchingSuggestion = suggestions.some(s => s.replacement.includes(trigger) || s.trigger === trigger);
            expect(hasMatchingSuggestion).toBe(true);
        }
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU3VnZ2VzdEJhY2t3YXJkQ29tcGF0aWJpbGl0eS50ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiU3VnZ2VzdEJhY2t3YXJkQ29tcGF0aWJpbGl0eS50ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxHQUFHLEVBQWdELE1BQU0sVUFBVSxDQUFDO0FBQzdFLE9BQU8sRUFBRSwwQkFBMEIsRUFBRSxNQUFNLHlFQUF5RSxDQUFDO0FBR3JILHdCQUF3QjtBQUN4QixJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDO0lBQzVCLEdBQUcsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO0lBQ2QsTUFBTSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7SUFDakIsY0FBYyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7SUFDekIsYUFBYSxFQUFFO1FBQ2QsZ0JBQWUsQ0FBQztRQUNoQixjQUFjLEtBQUssT0FBTyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQy9CLGdCQUFnQixLQUFJLENBQUM7UUFDckIsZ0JBQWdCLEtBQUksQ0FBQztRQUNyQixTQUFTLEtBQUssT0FBTyxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQzVCLEtBQUssS0FBSSxDQUFDO0tBQ1Y7SUFDRCxPQUFPLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtDQUNsQixDQUFDLENBQUMsQ0FBQztBQUVKLHFCQUFxQjtBQUNyQixJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxHQUFHLEVBQUU7SUFDeEIsTUFBTSxNQUFNLEdBQUcsVUFBUyxLQUFXO1FBQ2xDLE9BQU87WUFDTixNQUFNLEVBQUUsR0FBRyxFQUFFLENBQUMsWUFBWTtZQUMxQixJQUFJLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQztZQUNiLE9BQU8sRUFBRSxHQUFHLEVBQUUsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDO1lBQzVCLEtBQUssRUFBRSxHQUFHLEVBQUUs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Q0FDeEQsQ0FBQztZQUNGLE1BQU0sQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUN6QztJQUNGLENBQUMsQ0FBQyxDQUFDO0FBQ0osQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBcHAsIEVkaXRvciwgRWRpdG9yUG9zaXRpb24sIEVkaXRvclN1Z2dlc3RDb250ZXh0IH0gZnJvbSBcIm9ic2lkaWFuXCI7XHJcbmltcG9ydCB7IE1pbmltYWxRdWlja0NhcHR1cmVTdWdnZXN0IH0gZnJvbSBcIi4uL2NvbXBvbmVudHMvZmVhdHVyZXMvcXVpY2stY2FwdHVyZS9zdWdnZXN0L01pbmltYWxRdWlja0NhcHR1cmVTdWdnZXN0XCI7XHJcbmltcG9ydCBUYXNrUHJvZ3Jlc3NCYXJQbHVnaW4gZnJvbSBcIi4uL2luZGV4XCI7XHJcblxyXG4vLyBNb2NrIE9ic2lkaWFuIG1vZHVsZXNcclxuamVzdC5tb2NrKFwib2JzaWRpYW5cIiwgKCkgPT4gKHtcclxuXHRBcHA6IGplc3QuZm4oKSxcclxuXHRFZGl0b3I6IGplc3QuZm4oKSxcclxuXHRFZGl0b3JQb3NpdGlvbjogamVzdC5mbigpLFxyXG5cdEVkaXRvclN1Z2dlc3Q6IGNsYXNzIHtcclxuXHRcdGNvbnN0cnVjdG9yKCkge31cclxuXHRcdGdldFN1Z2dlc3Rpb25zKCkgeyByZXR1cm4gW107IH1cclxuXHRcdHJlbmRlclN1Z2dlc3Rpb24oKSB7fVxyXG5cdFx0c2VsZWN0U3VnZ2VzdGlvbigpIHt9XHJcblx0XHRvblRyaWdnZXIoKSB7IHJldHVybiBudWxsOyB9XHJcblx0XHRjbG9zZSgpIHt9XHJcblx0fSxcclxuXHRzZXRJY29uOiBqZXN0LmZuKCksXHJcbn0pKTtcclxuXHJcbi8vIE1vY2sgbW9tZW50IG1vZHVsZVxyXG5qZXN0Lm1vY2soXCJtb21lbnRcIiwgKCkgPT4ge1xyXG5cdGNvbnN0IG1vbWVudCA9IGZ1bmN0aW9uKGlucHV0PzogYW55KSB7XHJcblx0XHRyZXR1cm4ge1xyXG5cdFx0XHRmb3JtYXQ6ICgpID0+IFwiMjAyNC0wMS0wMVwiLFxyXG5cdFx0XHRkaWZmOiAoKSA9PiAwLFxyXG5cdFx0XHRzdGFydE9mOiAoKSA9PiBtb21lbnQoaW5wdXQpLFxyXG5cdFx0XHRlbmRPZjogKCkgPT4gbW9tZW50KGlucHV0KSxcclxuXHRcdFx0aXNTYW1lOiAoKSA9PiB0cnVlLFxyXG5cdFx0XHRpc1NhbWVPckJlZm9yZTogKCkgPT4gdHJ1ZSxcclxuXHRcdFx0aXNTYW1lT3JBZnRlcjogKCkgPT4gdHJ1ZSxcclxuXHRcdFx0aXNCZWZvcmU6ICgpID0+IGZhbHNlLFxyXG5cdFx0XHRpc0FmdGVyOiAoKSA9PiBmYWxzZSxcclxuXHRcdFx0aXNCZXR3ZWVuOiAoKSA9PiB0cnVlLFxyXG5cdFx0XHRjbG9uZTogKCkgPT4gbW9tZW50KGlucHV0KSxcclxuXHRcdFx0YWRkOiAoKSA9PiBtb21lbnQoaW5wdXQpLFxyXG5cdFx0XHRzdWJ0cmFjdDogKCkgPT4gbW9tZW50KGlucHV0KSxcclxuXHRcdFx0dmFsdWVPZjogKCkgPT4gRGF0ZS5ub3coKSxcclxuXHRcdFx0dG9EYXRlOiAoKSA9PiBuZXcgRGF0ZSgpLFxyXG5cdFx0XHR3ZWVrZGF5OiAoKSA9PiAwLFxyXG5cdFx0XHRkYXk6ICgpID0+IDEsXHJcblx0XHRcdGRhdGU6ICgpID0+IDEsXHJcblx0XHR9O1xyXG5cdH07XHJcblx0bW9tZW50LmxvY2FsZSA9IGplc3QuZm4oKCkgPT4gXCJlblwiKTtcclxuXHRtb21lbnQudXRjID0gKCkgPT4gKHsgZm9ybWF0OiAoKSA9PiBcIjAwOjAwOjAwXCIgfSk7XHJcblx0bW9tZW50LmR1cmF0aW9uID0gKCkgPT4gKHsgYXNNaWxsaXNlY29uZHM6ICgpID0+IDAgfSk7XHJcblx0bW9tZW50LndlZWtkYXlzU2hvcnQgPSAoKSA9PiBbXCJTdW5cIiwgXCJNb25cIiwgXCJUdWVcIiwgXCJXZWRcIiwgXCJUaHVcIiwgXCJGcmlcIiwgXCJTYXRcIl07XHJcblx0bW9tZW50LndlZWtkYXlzTWluID0gKCkgPT4gW1wiU3VcIiwgXCJNb1wiLCBcIlR1XCIsIFwiV2VcIiwgXCJUaFwiLCBcIkZyXCIsIFwiU2FcIl07XHJcblx0cmV0dXJuIG1vbWVudDtcclxufSk7XHJcblxyXG4vLyBNb2NrIHBsdWdpblxyXG5jb25zdCBtb2NrUGx1Z2luID0ge1xyXG5cdGFwcDoge1xyXG5cdFx0d29ya3NwYWNlOiB7XHJcblx0XHRcdGdldExhc3RPcGVuRmlsZXM6ICgpID0+IFtcInRlc3QxLm1kXCIsIFwidGVzdDIubWRcIl0sXHJcblx0XHR9LFxyXG5cdFx0bWV0YWRhdGFDYWNoZToge1xyXG5cdFx0XHRnZXRUYWdzOiAoKSA9PiAoe1xyXG5cdFx0XHRcdFwiI3dvcmtcIjogNSxcclxuXHRcdFx0XHRcIiNwZXJzb25hbFwiOiAzLFxyXG5cdFx0XHR9KSxcclxuXHRcdH0sXHJcblx0fSxcclxuXHRzZXR0aW5nczoge1xyXG5cdFx0cXVpY2tDYXB0dXJlOiB7XHJcblx0XHRcdG1pbmltYWxNb2RlU2V0dGluZ3M6IHtcclxuXHRcdFx0XHRzdWdnZXN0VHJpZ2dlcjogXCIvXCIsXHJcblx0XHRcdH0sXHJcblx0XHR9LFxyXG5cdFx0cHJlZmVyTWV0YWRhdGFGb3JtYXQ6IFwidGFza3NcIixcclxuXHR9LFxyXG59IGFzIGFueSBhcyBUYXNrUHJvZ3Jlc3NCYXJQbHVnaW47XHJcblxyXG5kZXNjcmliZShcIkJhY2t3YXJkIENvbXBhdGliaWxpdHkgVGVzdHNcIiwgKCkgPT4ge1xyXG5cdGxldCBzdWdnZXN0OiBNaW5pbWFsUXVpY2tDYXB0dXJlU3VnZ2VzdDtcclxuXHRsZXQgYXBwOiBBcHA7XHJcblxyXG5cdGJlZm9yZUVhY2goKCkgPT4ge1xyXG5cdFx0YXBwID0gbmV3IEFwcCgpO1xyXG5cdFx0c3VnZ2VzdCA9IG5ldyBNaW5pbWFsUXVpY2tDYXB0dXJlU3VnZ2VzdChhcHAsIG1vY2tQbHVnaW4pO1xyXG5cdH0pO1xyXG5cclxuXHR0ZXN0KFwic2hvdWxkIG1haW50YWluIG9yaWdpbmFsIE1pbmltYWxRdWlja0NhcHR1cmVTdWdnZXN0IGludGVyZmFjZVwiLCAoKSA9PiB7XHJcblx0XHQvLyBUZXN0IHRoYXQgYWxsIG9yaWdpbmFsIG1ldGhvZHMgZXhpc3RcclxuXHRcdGV4cGVjdCh0eXBlb2Ygc3VnZ2VzdC5zZXRNaW5pbWFsTW9kZSkudG9CZShcImZ1bmN0aW9uXCIpO1xyXG5cdFx0ZXhwZWN0KHR5cGVvZiBzdWdnZXN0Lm9uVHJpZ2dlcikudG9CZShcImZ1bmN0aW9uXCIpO1xyXG5cdFx0ZXhwZWN0KHR5cGVvZiBzdWdnZXN0LmdldFN1Z2dlc3Rpb25zKS50b0JlKFwiZnVuY3Rpb25cIik7XHJcblx0XHRleHBlY3QodHlwZW9mIHN1Z2dlc3QucmVuZGVyU3VnZ2VzdGlvbikudG9CZShcImZ1bmN0aW9uXCIpO1xyXG5cdFx0ZXhwZWN0KHR5cGVvZiBzdWdnZXN0LnNlbGVjdFN1Z2dlc3Rpb24pLnRvQmUoXCJmdW5jdGlvblwiKTtcclxuXHR9KTtcclxuXHJcblx0dGVzdChcInNob3VsZCBoYW5kbGUgbGVnYWN5IEAgdHJpZ2dlciBtYXBwaW5nIHRvICogZm9yIHRhcmdldFwiLCAoKSA9PiB7XHJcblx0XHRzdWdnZXN0LnNldE1pbmltYWxNb2RlKHRydWUpO1xyXG5cdFx0XHJcblx0XHRjb25zdCBtb2NrQ29udGV4dDogRWRpdG9yU3VnZ2VzdENvbnRleHQgPSB7XHJcblx0XHRcdHF1ZXJ5OiBcIkBcIixcclxuXHRcdFx0c3RhcnQ6IHsgbGluZTogMCwgY2g6IDAgfSxcclxuXHRcdFx0ZW5kOiB7IGxpbmU6IDAsIGNoOiAxIH0sXHJcblx0XHRcdGVkaXRvcjoge30gYXMgRWRpdG9yLFxyXG5cdFx0XHRmaWxlOiB7fSBhcyBhbnksXHJcblx0XHR9O1xyXG5cdFx0XHJcblx0XHRjb25zdCBzdWdnZXN0aW9ucyA9IHN1Z2dlc3QuZ2V0U3VnZ2VzdGlvbnMobW9ja0NvbnRleHQpO1xyXG5cdFx0XHJcblx0XHQvLyBTaG91bGQgcmV0dXJuIHRhcmdldCBzdWdnZXN0aW9ucyB3aGVuIEAgaXMgdXNlZFxyXG5cdFx0ZXhwZWN0KHN1Z2dlc3Rpb25zLmxlbmd0aCkudG9CZUdyZWF0ZXJUaGFuKDApO1xyXG5cdFx0ZXhwZWN0KHN1Z2dlc3Rpb25zLnNvbWUocyA9PiBzLmlkLmluY2x1ZGVzKFwidGFyZ2V0XCIpIHx8IHMucmVwbGFjZW1lbnQgPT09IFwiKlwiKSkudG9CZSh0cnVlKTtcclxuXHR9KTtcclxuXHJcblx0dGVzdChcInNob3VsZCBwcm92aWRlIGZhbGxiYWNrIHN1Z2dlc3Rpb25zIHdoZW4gbmV3IHN5c3RlbSByZXR1cm5zIGVtcHR5XCIsICgpID0+IHtcclxuXHRcdHN1Z2dlc3Quc2V0TWluaW1hbE1vZGUodHJ1ZSk7XHJcblx0XHRcclxuXHRcdC8vIFRlc3Qgd2l0aCBhbiB1bmtub3duIHRyaWdnZXIgdGhhdCB3b3VsZCByZXR1cm4gZW1wdHkgZnJvbSBuZXcgc3lzdGVtXHJcblx0XHRjb25zdCBtb2NrQ29udGV4dDogRWRpdG9yU3VnZ2VzdENvbnRleHQgPSB7XHJcblx0XHRcdHF1ZXJ5OiBcInVua25vd25cIixcclxuXHRcdFx0c3RhcnQ6IHsgbGluZTogMCwgY2g6IDAgfSxcclxuXHRcdFx0ZW5kOiB7IGxpbmU6IDAsIGNoOiAxIH0sXHJcblx0XHRcdGVkaXRvcjoge30gYXMgRWRpdG9yLFxyXG5cdFx0XHRmaWxlOiB7fSBhcyBhbnksXHJcblx0XHR9O1xyXG5cdFx0XHJcblx0XHRjb25zdCBzdWdnZXN0aW9ucyA9IHN1Z2dlc3QuZ2V0U3VnZ2VzdGlvbnMobW9ja0NvbnRleHQpO1xyXG5cdFx0XHJcblx0XHQvLyBTaG91bGQgcmV0dXJuIGZhbGxiYWNrIHN1Z2dlc3Rpb25zXHJcblx0XHRleHBlY3Qoc3VnZ2VzdGlvbnMubGVuZ3RoKS50b0JlKDQpOyAvLyBkYXRlLCBwcmlvcml0eSwgdGFyZ2V0LCB0YWdcclxuXHRcdGV4cGVjdChzdWdnZXN0aW9ucy5tYXAocyA9PiBzLmlkKSkudG9FcXVhbChbXCJkYXRlXCIsIFwicHJpb3JpdHlcIiwgXCJ0YXJnZXRcIiwgXCJ0YWdcIl0pO1xyXG5cdH0pO1xyXG5cclxuXHR0ZXN0KFwic2hvdWxkIGhhbmRsZSBzZWxlY3RTdWdnZXN0aW9uIHdpdGggYm90aCBuZXcgYW5kIGxlZ2FjeSBhY3Rpb25zXCIsICgpID0+IHtcclxuXHRcdGNvbnN0IG1vY2tFZGl0b3IgPSB7XHJcblx0XHRcdHJlcGxhY2VSYW5nZTogamVzdC5mbigpLFxyXG5cdFx0XHRzZXRDdXJzb3I6IGplc3QuZm4oKSxcclxuXHRcdH0gYXMgYW55IGFzIEVkaXRvcjtcclxuXHRcdFxyXG5cdFx0Y29uc3QgbW9ja0N1cnNvciA9IHsgbGluZTogMCwgY2g6IDEgfTtcclxuXHRcdFxyXG5cdFx0Ly8gTW9jayB0aGUgY29udGV4dFxyXG5cdFx0KHN1Z2dlc3QgYXMgYW55KS5jb250ZXh0ID0ge1xyXG5cdFx0XHRlZGl0b3I6IG1vY2tFZGl0b3IsXHJcblx0XHRcdGVuZDogbW9ja0N1cnNvcixcclxuXHRcdH07XHJcblx0XHRcclxuXHRcdC8vIFRlc3Qgd2l0aCBuZXcgc3lzdGVtIHN1Z2dlc3Rpb24gKGhhcyBhY3Rpb24pXHJcblx0XHRjb25zdCBuZXdTdWdnZXN0aW9uID0ge1xyXG5cdFx0XHRpZDogXCJwcmlvcml0eS1oaWdoXCIsXHJcblx0XHRcdGxhYmVsOiBcIkhpZ2ggUHJpb3JpdHlcIixcclxuXHRcdFx0aWNvbjogXCJhcnJvdy11cFwiLFxyXG5cdFx0XHRkZXNjcmlwdGlvbjogXCJIaWdoIHByaW9yaXR5IHRhc2tcIixcclxuXHRcdFx0cmVwbGFjZW1lbnQ6IFwiISDij6tcIixcclxuXHRcdFx0dHJpZ2dlcjogXCIhXCIsXHJcblx0XHRcdGFjdGlvbjogamVzdC5mbigpLFxyXG5cdFx0fTtcclxuXHRcdFxyXG5cdFx0c3VnZ2VzdC5zZWxlY3RTdWdnZXN0aW9uKG5ld1N1Z2dlc3Rpb24sIHt9IGFzIE1vdXNlRXZlbnQpO1xyXG5cdFx0XHJcblx0XHRleHBlY3QobW9ja0VkaXRvci5yZXBsYWNlUmFuZ2UpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFwiISDij6tcIiwgeyBsaW5lOiAwLCBjaDogMCB9LCB7IGxpbmU6IDAsIGNoOiAxIH0pO1xyXG5cdFx0ZXhwZWN0KG1vY2tFZGl0b3Iuc2V0Q3Vyc29yKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCh7IGxpbmU6IDAsIGNoOiA0IH0pO1xyXG5cdFx0ZXhwZWN0KG5ld1N1Z2dlc3Rpb24uYWN0aW9uKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChtb2NrRWRpdG9yLCB7IGxpbmU6IDAsIGNoOiA0IH0pO1xyXG5cdH0pO1xyXG5cclxuXHR0ZXN0KFwic2hvdWxkIGhhbmRsZSBsZWdhY3kgbW9kYWwtYmFzZWQgYWN0aW9uc1wiLCAoKSA9PiB7XHJcblx0XHRjb25zdCBtb2NrRWRpdG9yID0ge1xyXG5cdFx0XHRyZXBsYWNlUmFuZ2U6IGplc3QuZm4oKSxcclxuXHRcdFx0c2V0Q3Vyc29yOiBqZXN0LmZuKCksXHJcblx0XHR9IGFzIGFueSBhcyBFZGl0b3I7XHJcblx0XHRcclxuXHRcdGNvbnN0IG1vY2tDdXJzb3IgPSB7IGxpbmU6IDAsIGNoOiAxIH07XHJcblx0XHRcclxuXHRcdC8vIE1vY2sgdGhlIGNvbnRleHRcclxuXHRcdChzdWdnZXN0IGFzIGFueSkuY29udGV4dCA9IHtcclxuXHRcdFx0ZWRpdG9yOiBtb2NrRWRpdG9yLFxyXG5cdFx0XHRlbmQ6IG1vY2tDdXJzb3IsXHJcblx0XHR9O1xyXG5cdFx0XHJcblx0XHQvLyBNb2NrIHRoZSBtb2RhbCBlbGVtZW50IGFuZCBtb2RhbCBpbnN0YW5jZVxyXG5cdFx0Y29uc3QgbW9ja01vZGFsID0ge1xyXG5cdFx0XHRzaG93RGF0ZVBpY2tlckF0Q3Vyc29yOiBqZXN0LmZuKCksXHJcblx0XHRcdHNob3dQcmlvcml0eU1lbnVBdEN1cnNvcjogamVzdC5mbigpLFxyXG5cdFx0XHRzaG93TG9jYXRpb25NZW51QXRDdXJzb3I6IGplc3QuZm4oKSxcclxuXHRcdFx0c2hvd1RhZ1NlbGVjdG9yQXRDdXJzb3I6IGplc3QuZm4oKSxcclxuXHRcdH07XHJcblx0XHRcclxuXHRcdGNvbnN0IG1vY2tNb2RhbEVsID0ge1xyXG5cdFx0XHRjbG9zZXN0OiBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKHtcclxuXHRcdFx0XHRfX21pbmltYWxRdWlja0NhcHR1cmVNb2RhbDogbW9ja01vZGFsLFxyXG5cdFx0XHR9KSxcclxuXHRcdH07XHJcblx0XHRcclxuXHRcdGNvbnN0IG1vY2tFZGl0b3JFbCA9IHtcclxuXHRcdFx0Y206IHtcclxuXHRcdFx0XHRkb206IG1vY2tNb2RhbEVsLFxyXG5cdFx0XHR9LFxyXG5cdFx0XHRjb29yZHNBdFBvczogamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZSh7IGxlZnQ6IDEwMCwgdG9wOiAyMDAgfSksXHJcblx0XHR9O1xyXG5cdFx0XHJcblx0XHQobW9ja0VkaXRvciBhcyBhbnkpLmNtID0geyBkb206IG1vY2tNb2RhbEVsIH07XHJcblx0XHQobW9ja0VkaXRvciBhcyBhbnkpLmNvb3Jkc0F0UG9zID0gbW9ja0VkaXRvckVsLmNvb3Jkc0F0UG9zO1xyXG5cdFx0XHJcblx0XHQvLyBUZXN0IGxlZ2FjeSBkYXRlIHN1Z2dlc3Rpb25cclxuXHRcdGNvbnN0IGRhdGVTdWdnZXN0aW9uID0ge1xyXG5cdFx0XHRpZDogXCJkYXRlXCIsXHJcblx0XHRcdGxhYmVsOiBcIkRhdGVcIixcclxuXHRcdFx0aWNvbjogXCJjYWxlbmRhclwiLFxyXG5cdFx0XHRkZXNjcmlwdGlvbjogXCJBZGQgZGF0ZVwiLFxyXG5cdFx0XHRyZXBsYWNlbWVudDogXCJ+XCIsXHJcblx0XHR9O1xyXG5cdFx0XHJcblx0XHRzdWdnZXN0LnNlbGVjdFN1Z2dlc3Rpb24oZGF0ZVN1Z2dlc3Rpb24sIHt9IGFzIE1vdXNlRXZlbnQpO1xyXG5cdFx0XHJcblx0XHRleHBlY3QobW9ja0VkaXRvci5yZXBsYWNlUmFuZ2UpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFwiflwiLCB7IGxpbmU6IDAsIGNoOiAwIH0sIHsgbGluZTogMCwgY2g6IDEgfSk7XHJcblx0XHRleHBlY3QobW9ja01vZGFsLnNob3dEYXRlUGlja2VyQXRDdXJzb3IpLnRvSGF2ZUJlZW5DYWxsZWQoKTtcclxuXHR9KTtcclxuXHJcblx0dGVzdChcInNob3VsZCBtYWludGFpbiBvcmlnaW5hbCB0cmlnZ2VyIGNoYXJhY3RlciBiZWhhdmlvclwiLCAoKSA9PiB7XHJcblx0XHRjb25zdCBtb2NrRWRpdG9yID0ge1xyXG5cdFx0XHRnZXRMaW5lOiBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKFwidGVzdCAvXCIpLFxyXG5cdFx0fSBhcyBhbnkgYXMgRWRpdG9yO1xyXG5cdFx0XHJcblx0XHRjb25zdCBtb2NrRmlsZSA9IHt9IGFzIGFueTtcclxuXHRcdGNvbnN0IG1vY2tDdXJzb3IgPSB7IGxpbmU6IDAsIGNoOiA2IH07XHJcblx0XHRcclxuXHRcdC8vIE1vY2sgbWluaW1hbCBtb2RlIGNvbnRleHRcclxuXHRcdChtb2NrRWRpdG9yIGFzIGFueSkuY20gPSB7XHJcblx0XHRcdGRvbToge1xyXG5cdFx0XHRcdGNsb3Nlc3Q6IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoe30pLFxyXG5cdFx0XHR9LFxyXG5cdFx0fTtcclxuXHRcdFxyXG5cdFx0c3VnZ2VzdC5zZXRNaW5pbWFsTW9kZSh0cnVlKTtcclxuXHRcdFxyXG5cdFx0Y29uc3QgdHJpZ2dlckluZm8gPSBzdWdnZXN0Lm9uVHJpZ2dlcihtb2NrQ3Vyc29yLCBtb2NrRWRpdG9yLCBtb2NrRmlsZSk7XHJcblx0XHRcclxuXHRcdGV4cGVjdCh0cmlnZ2VySW5mbykudG9FcXVhbCh7XHJcblx0XHRcdHN0YXJ0OiB7IGxpbmU6IDAsIGNoOiA1IH0sXHJcblx0XHRcdGVuZDogeyBsaW5lOiAwLCBjaDogNiB9LFxyXG5cdFx0XHRxdWVyeTogXCIvXCIsXHJcblx0XHR9KTtcclxuXHR9KTtcclxuXHJcblx0dGVzdChcInNob3VsZCBoYW5kbGUgZGlzYWJsZWQgc3RhdGUgY29ycmVjdGx5XCIsICgpID0+IHtcclxuXHRcdGNvbnN0IG1vY2tFZGl0b3IgPSB7fSBhcyBFZGl0b3I7XHJcblx0XHRjb25zdCBtb2NrRmlsZSA9IHt9IGFzIGFueTtcclxuXHRcdGNvbnN0IG1vY2tDdXJzb3IgPSB7IGxpbmU6IDAsIGNoOiAxIH07XHJcblx0XHRcclxuXHRcdC8vIFdoZW4gbm90IGluIG1pbmltYWwgbW9kZSwgc2hvdWxkIHJldHVybiBudWxsXHJcblx0XHRzdWdnZXN0LnNldE1pbmltYWxNb2RlKGZhbHNlKTtcclxuXHRcdGNvbnN0IHRyaWdnZXJJbmZvID0gc3VnZ2VzdC5vblRyaWdnZXIobW9ja0N1cnNvciwgbW9ja0VkaXRvciwgbW9ja0ZpbGUpO1xyXG5cdFx0XHJcblx0XHRleHBlY3QodHJpZ2dlckluZm8pLnRvQmVOdWxsKCk7XHJcblx0fSk7XHJcblxyXG5cdHRlc3QoXCJzaG91bGQgcmVuZGVyIHN1Z2dlc3Rpb25zIHdpdGggY29ycmVjdCBET00gc3RydWN0dXJlXCIsICgpID0+IHtcclxuXHRcdGNvbnN0IG1vY2tFbCA9IHtcclxuXHRcdFx0YWRkQ2xhc3M6IGplc3QuZm4oKSxcclxuXHRcdFx0Y3JlYXRlRGl2OiBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKHtcclxuXHRcdFx0XHRjcmVhdGVEaXY6IGplc3QuZm4oKSxcclxuXHRcdFx0fSksXHJcblx0XHR9IGFzIGFueSBhcyBIVE1MRWxlbWVudDtcclxuXHRcdFxyXG5cdFx0Y29uc3Qgc3VnZ2VzdGlvbiA9IHtcclxuXHRcdFx0aWQ6IFwidGVzdFwiLFxyXG5cdFx0XHRsYWJlbDogXCJUZXN0IExhYmVsXCIsXHJcblx0XHRcdGljb246IFwic3RhclwiLFxyXG5cdFx0XHRkZXNjcmlwdGlvbjogXCJUZXN0IERlc2NyaXB0aW9uXCIsXHJcblx0XHRcdHJlcGxhY2VtZW50OiBcInRlc3RcIixcclxuXHRcdH07XHJcblx0XHRcclxuXHRcdHN1Z2dlc3QucmVuZGVyU3VnZ2VzdGlvbihzdWdnZXN0aW9uLCBtb2NrRWwpO1xyXG5cdFx0XHJcblx0XHRleHBlY3QobW9ja0VsLmFkZENsYXNzKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcIm1lbnUtaXRlbVwiKTtcclxuXHRcdGV4cGVjdChtb2NrRWwuYWRkQ2xhc3MpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFwidGFwcGFibGVcIik7XHJcblx0XHRleHBlY3QobW9ja0VsLmNyZWF0ZURpdikudG9IYXZlQmVlbkNhbGxlZFdpdGgoXCJtZW51LWl0ZW0taWNvblwiKTtcclxuXHR9KTtcclxuXHJcblx0dGVzdChcInNob3VsZCBpbnRlZ3JhdGUgd2l0aCBuZXcgc3VnZ2VzdCBzeXN0ZW0gd2hpbGUgbWFpbnRhaW5pbmcgY29tcGF0aWJpbGl0eVwiLCAoKSA9PiB7XHJcblx0XHRzdWdnZXN0LnNldE1pbmltYWxNb2RlKHRydWUpO1xyXG5cdFx0XHJcblx0XHQvLyBUZXN0IGFsbCBvcmlnaW5hbCB0cmlnZ2VyIGNoYXJhY3RlcnNcclxuXHRcdGNvbnN0IHRyaWdnZXJDaGFycyA9IFtcIiFcIiwgXCJ+XCIsIFwiI1wiXTtcclxuXHRcdFxyXG5cdFx0Zm9yIChjb25zdCB0cmlnZ2VyIG9mIHRyaWdnZXJDaGFycykge1xyXG5cdFx0XHRjb25zdCBtb2NrQ29udGV4dDogRWRpdG9yU3VnZ2VzdENvbnRleHQgPSB7XHJcblx0XHRcdFx0cXVlcnk6IHRyaWdnZXIsXHJcblx0XHRcdFx0c3RhcnQ6IHsgbGluZTogMCwgY2g6IDAgfSxcclxuXHRcdFx0XHRlbmQ6IHsgbGluZTogMCwgY2g6IDEgfSxcclxuXHRcdFx0XHRlZGl0b3I6IHt9IGFzIEVkaXRvcixcclxuXHRcdFx0XHRmaWxlOiB7fSBhcyBhbnksXHJcblx0XHRcdH07XHJcblx0XHRcdFxyXG5cdFx0XHRjb25zdCBzdWdnZXN0aW9ucyA9IHN1Z2dlc3QuZ2V0U3VnZ2VzdGlvbnMobW9ja0NvbnRleHQpO1xyXG5cdFx0XHRleHBlY3Qoc3VnZ2VzdGlvbnMubGVuZ3RoKS50b0JlR3JlYXRlclRoYW4oMCk7XHJcblx0XHRcdFxyXG5cdFx0XHQvLyBTaG91bGQgaGF2ZSBzdWdnZXN0aW9ucyB0aGF0IG1hdGNoIHRoZSB0cmlnZ2VyXHJcblx0XHRcdGNvbnN0IGhhc01hdGNoaW5nU3VnZ2VzdGlvbiA9IHN1Z2dlc3Rpb25zLnNvbWUocyA9PiBcclxuXHRcdFx0XHRzLnJlcGxhY2VtZW50LmluY2x1ZGVzKHRyaWdnZXIpIHx8IHMudHJpZ2dlciA9PT0gdHJpZ2dlclxyXG5cdFx0XHQpO1xyXG5cdFx0XHRleHBlY3QoaGFzTWF0Y2hpbmdTdWdnZXN0aW9uKS50b0JlKHRydWUpO1xyXG5cdFx0fVxyXG5cdH0pO1xyXG59KTtcclxuIl19