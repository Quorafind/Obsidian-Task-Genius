import { App } from "obsidian";
import { UniversalEditorSuggest, SuggestManager } from "../components/ui/suggest";
import { getSuggestOptionsByTrigger } from "../components/ui/suggest/SpecialCharacterSuggests";
// Mock Obsidian modules
jest.mock("obsidian", () => ({
    App: jest.fn(),
    Editor: jest.fn(),
    EditorPosition: jest.fn(),
    TFile: jest.fn(),
    EditorSuggest: class {
        constructor() { }
        getSuggestions() { return []; }
        renderSuggestion() { }
        selectSuggestion() { }
        onTrigger() { return null; }
        close() { }
    },
    setIcon: jest.fn(),
}));
// Mock moment module
jest.mock("moment", () => {
    const moment = function (input) {
        return {
            format: () => "2024-01-01",
            diff: () => 0,
            startOf: () => moment(input),
            endOf: () => moment(input),
            isSame: () => true,
            isSameOrBefore: () => true,
            isSameOrAfter: () => true,
            isBefore: () => false,
            isAfter: () => false,
            isBetween: () => true,
            clone: () => moment(input),
            add: () => moment(input),
            subtract: () => moment(input),
            valueOf: () => Date.now(),
            toDate: () => new Date(),
            weekday: () => 0,
            day: () => 1,
            date: () => 1,
        };
    };
    moment.locale = jest.fn(() => "en");
    moment.utc = () => ({ format: () => "00:00:00" });
    moment.duration = () => ({ asMilliseconds: () => 0 });
    moment.weekdaysShort = () => ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
    moment.weekdaysMin = () => ["Su", "Mo", "Tu", "We", "Th", "Fr", "Sa"];
    return moment;
});
// Mock plugin
const mockPlugin = {
    app: {
        workspace: {
            getLastOpenFiles: () => ["file1.md", "file2.md", "file3.md"],
        },
        metadataCache: {
            getTags: () => ({
                "#tag1": 5,
                "#tag2": 3,
                "#重要": 2,
            }),
        },
    },
    settings: {
        preferMetadataFormat: "tasks",
    },
};
describe("UniversalEditorSuggest", () => {
    let suggest;
    let app;
    beforeEach(() => {
        app = new App();
        suggest = new UniversalEditorSuggest(app, mockPlugin, {
            triggerChars: ["!", "~", "*", "#"],
        });
    });
    test("should initialize with correct trigger characters", () => {
        const config = suggest.getConfig();
        expect(config.triggerChars).toEqual(["!", "~", "*", "#"]);
    });
    test("should enable and disable correctly", () => {
        suggest.enable();
        expect(suggest["isEnabled"]).toBe(true);
        suggest.disable();
        expect(suggest["isEnabled"]).toBe(false);
    });
    test("should add and remove suggest options", () => {
        const customOption = {
            id: "custom",
            label: "Custom",
            icon: "star",
            description: "Custom option",
            replacement: "%",
            trigger: "%",
        };
        suggest.addSuggestOption(customOption);
        const config = suggest.getConfig();
        expect(config.triggerChars).toContain("%");
        suggest.removeSuggestOption("custom");
        // Note: This test would need access to internal suggestOptions to verify removal
    });
});
describe("SuggestManager", () => {
    let manager;
    let app;
    beforeEach(() => {
        app = new App();
        // Mock the workspace.editorSuggest.suggests array
        app.workspace = {
            editorSuggest: {
                suggests: [],
            },
        };
        manager = new SuggestManager(app, mockPlugin);
    });
    test("should start and stop managing correctly", () => {
        expect(manager.isCurrentlyManaging()).toBe(false);
        manager.startManaging();
        expect(manager.isCurrentlyManaging()).toBe(true);
        manager.stopManaging();
        expect(manager.isCurrentlyManaging()).toBe(false);
    });
    test("should add suggests with priority", () => {
        const mockSuggest = {};
        manager.startManaging();
        manager.addSuggestWithPriority(mockSuggest, "test");
        const activeSuggests = manager.getActiveSuggests();
        expect(activeSuggests.has("test")).toBe(true);
        expect(activeSuggests.get("test")).toBe(mockSuggest);
    });
    test("should remove managed suggests", () => {
        const mockSuggest = {};
        manager.startManaging();
        manager.addSuggestWithPriority(mockSuggest, "test");
        expect(manager.getActiveSuggests().has("test")).toBe(true);
        manager.removeManagedSuggest("test");
        expect(manager.getActiveSuggests().has("test")).toBe(false);
    });
    test("should cleanup properly", () => {
        manager.startManaging();
        manager.addSuggestWithPriority({}, "test1");
        manager.addSuggestWithPriority({}, "test2");
        expect(manager.getActiveSuggests().size).toBe(2);
        manager.cleanup();
        expect(manager.isCurrentlyManaging()).toBe(false);
        expect(manager.getActiveSuggests().size).toBe(0);
    });
});
describe("SpecialCharacterSuggests", () => {
    test("should return priority suggestions for ! trigger", () => {
        const suggestions = getSuggestOptionsByTrigger("!", mockPlugin);
        expect(suggestions.length).toBeGreaterThan(0);
        expect(suggestions[0].trigger).toBe("!");
        expect(suggestions.some(s => s.id.includes("priority"))).toBe(true);
    });
    test("should return date suggestions for ~ trigger", () => {
        const suggestions = getSuggestOptionsByTrigger("~", mockPlugin);
        expect(suggestions.length).toBeGreaterThan(0);
        expect(suggestions[0].trigger).toBe("~");
        expect(suggestions.some(s => s.id.includes("date"))).toBe(true);
    });
    test("should return target suggestions for * trigger", () => {
        const suggestions = getSuggestOptionsByTrigger("*", mockPlugin);
        expect(suggestions.length).toBeGreaterThan(0);
        expect(suggestions[0].trigger).toBe("*");
        expect(suggestions.some(s => s.id.includes("target"))).toBe(true);
    });
    test("should return tag suggestions for # trigger", () => {
        const suggestions = getSuggestOptionsByTrigger("#", mockPlugin);
        expect(suggestions.length).toBeGreaterThan(0);
        expect(suggestions[0].trigger).toBe("#");
        expect(suggestions.some(s => s.id.includes("tag"))).toBe(true);
    });
    test("should return empty array for unknown trigger", () => {
        const suggestions = getSuggestOptionsByTrigger("?", mockPlugin);
        expect(suggestions).toEqual([]);
    });
});
describe("Integration Tests", () => {
    test("should create universal suggest for minimal modal context", () => {
        const app = new App();
        app.workspace = {
            editorSuggest: {
                suggests: [],
            },
        };
        const manager = new SuggestManager(app, mockPlugin);
        manager.startManaging();
        const mockEditor = {};
        const suggest = manager.enableForMinimalModal(mockEditor);
        expect(suggest).toBeInstanceOf(UniversalEditorSuggest);
        expect(manager.getActiveSuggests().has("universal-minimal-modal")).toBe(true);
        manager.cleanup();
    });
    test("should handle context filters correctly", () => {
        const app = new App();
        app.workspace = {
            editorSuggest: {
                suggests: [],
            },
        };
        const manager = new SuggestManager(app, mockPlugin);
        // Add custom context filter
        const testFilter = (editor, file) => true;
        manager.addContextFilter("test", testFilter);
        const config = manager.getConfig();
        expect(config.contextFilters["test"]).toBe(testFilter);
        // Remove context filter
        manager.removeContextFilter("test");
        const updatedConfig = manager.getConfig();
        expect(updatedConfig.contextFilters["test"]).toBeUndefined();
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVW5pdmVyc2FsU3VnZ2VzdC50ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiVW5pdmVyc2FsU3VnZ2VzdC50ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxHQUFHLEVBQWlDLE1BQU0sVUFBVSxDQUFDO0FBQzlELE9BQU8sRUFBRSxzQkFBc0IsRUFBRSxjQUFjLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUVsRixPQUFPLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSxtREFBbUQsQ0FBQztBQUUvRix3QkFBd0I7QUFDeEIsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQztJQUM1QixHQUFHLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtJQUNkLE1BQU0sRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO0lBQ2pCLGNBQWMsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO0lBQ3pCLEtBQUssRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO0lBQ2hCLGFBQWEsRUFBRTtRQUNkLGdCQUFlLENBQUM7UUFDaEIsY0FBYyxLQUFLLE9BQU8sRUFBRSxDQUFDLENBQUMsQ0FBQztRQUMvQixnQkFBZ0IsS0FBSSxDQUFDO1FBQ3JCLGdCQUFnQixLQUFJLENBQUM7UUFDckIsU0FBUyxLQUFLLE9BQU8sSUFBSSxDQUFDLENBQUMsQ0FBQztRQUM1QixLQUFLLEtBQUksQ0FBQztLQUNWO0lBQ0QsT0FBTyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7Q0FDbEIsQ0FBQyxDQUFDLENBQUM7QUFFSixxQkFBcUI7QUFDckIsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsR0FBRyxFQUFFO0lBQ3hCLE1BQU0sTUFBTSxHQUFHLFVBQVMsS0FBVztRQUNsQyxPQUFPO1lBQ04sTUFBTSxFQUFFLEdBQUcsRUFBRSxDQUFDLFlBQVk7WUFDMUIsSUFBSSxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUM7WUFDYixPQUFPLEVBQUUsR0FBRyxFQUFFLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQztZQUM1QixLQUFLLEVBQUUsR0FBRyxFQUFFLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQztZQUMxQixNQUFNLEVBQUUsR0FBRyxFQUFFLENBQUMsSUFBSTtZQUNsQixjQUFjLEVBQUUsR0FBRyxFQUFFLENBQUMsSUFBSTtZQUMxQixhQUFhLEVBQUUsR0FBRyxFQUFFLENBQUMsSUFBSTtZQUN6QixRQUFRLEVBQUUsR0FBRyxFQUFFLENBQUMsS0FBSztZQUNyQixPQUFPLEVBQUUsR0FBRyxFQUFFLENBQUMsS0FBSztZQUNwQixTQUFTLEVBQUUsR0FBRyxFQUFFLENBQUMsSUFBSTtZQUNyQixLQUFLLEVBQUUsR0FBRyxFQUFFLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQztZQUMxQixHQUFHLEVBQUUsR0FBRyxFQUFFLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQztZQUN4QixRQUFRLEVBQUUsR0FBRyxFQUFFLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQztZQUM3QixPQUFPLEVBQUUsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRTtZQUN6QixNQUFNLEVBQUUsR0FBRyxFQUFFLENBQUMsSUFBSSxJQUFJLEVBQUU7WUFDeEIsT0FBTyxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUM7WUFDaEIsR0FBRyxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUM7WUFDWixJQUFJLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQztTQUNiLENBQUM7SUFDSCxDQUFDLENBQUM7SUFDRixNQUFNLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDcEMsTUFBTSxDQUFDLEdBQUcsR0FBRyxHQUFHLEVBQUUsQ0FBQyxDQUFDLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxDQUFDLFVBQVUsRUFBRSxDQUFDLENBQUM7SUFDbEQsTUFBTSxDQUFDLFFBQVEsR0FBRyxHQUFHLEVBQUUsQ0FBQyxDQUFDLEVBQUUsY0FBYyxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDdEQsTUFBTSxDQUFDLGFBQWEsR0FBRyxHQUFHLEVBQUUsQ0FBQyxDQUFDLEtBQUssRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQy9FLE1BQU0sQ0FBQyxXQUFXLEdBQUcsR0FBRyxFQUFFLENBQUMsQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztJQUN0RSxPQUFPLE1BQU0sQ0FBQztBQUNmLENBQUMsQ0FBQyxDQUFDO0FBRUgsY0FBYztBQUNkLE1BQU0sVUFBVSxHQUFHO0lBQ2xCLEdBQUcsRUFBRTtRQUNKLFNBQVMsRUFBRTtZQUNWLGdCQUFnQixFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUMsVUFBVSxFQUFFLFVBQVUsRUFBRSxVQUFVLENBQUM7U0FDNUQ7UUFDRCxhQUFhLEVBQUU7WUFDZCxPQUFPLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQztnQkFDZixPQUFPLEVBQUUsQ0FBQztnQkFDVixPQUFPLEVBQUUsQ0FBQztnQkFDVixLQUFLLEVBQUUsQ0FBQzthQUNSLENBQUM7U0FDRjtLQUNNO0lBQ1IsUUFBUSxFQUFFO1FBQ1Qsb0JBQW9CLEVBQUUsT0FBTztLQUM3QjtDQUN3QixDQUFDO0FBRTNCLFFBQVEsQ0FBQyx3QkFBd0IsRUFBRSxHQUFHLEVBQUU7SUFDdkMsSUFBSSxPQUErQixDQUFDO0lBQ3BDLElBQUksR0FBUSxDQUFDO0lBRWIsVUFBVSxDQUFDLEdBQUcsRUFBRTtRQUNmLEdBQUcsR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQ2hCLE9BQU8sR0FBRyxJQUFJLHNCQUFzQixDQUFDLEdBQUcsRUFBRSxVQUFVLEVBQUU7WUFDckQsWUFBWSxFQUFFLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxDQUFDO1NBQ2xDLENBQUMsQ0FBQztJQUNKLENBQUMsQ0FBQyxDQUFDO0lBRUgsSUFBSSxDQUFDLG1EQUFtRCxFQUFFLEdBQUcsRUFBRTtRQUM5RCxNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsU0FBUyxFQUFFLENBQUM7UUFDbkMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDO0lBQzNELENBQUMsQ0FBQyxDQUFDO0lBRUgsSUFBSSxDQUFDLHFDQUFxQyxFQUFFLEdBQUcsRUFBRTtRQUNoRCxPQUFPLENBQUMsTUFBTSxFQUFFLENBQUM7UUFDakIsTUFBTSxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUV4QyxPQUFPLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDbEIsTUFBTSxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUMxQyxDQUFDLENBQUMsQ0FBQztJQUVILElBQUksQ0FBQyx1Q0FBdUMsRUFBRSxHQUFHLEVBQUU7UUFDbEQsTUFBTSxZQUFZLEdBQUc7WUFDcEIsRUFBRSxFQUFFLFFBQVE7WUFDWixLQUFLLEVBQUUsUUFBUTtZQUNmLElBQUksRUFBRSxNQUFNO1lBQ1osV0FBVyxFQUFFLGVBQWU7WUFDNUIsV0FBVyxFQUFFLEdBQUc7WUFDaEIsT0FBTyxFQUFFLEdBQUc7U0FDWixDQUFDO1FBRUYsT0FBTyxDQUFDLGdCQUFnQixDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQ3ZDLE1BQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxTQUFTLEVBQUUsQ0FBQztRQUNuQyxNQUFNLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUUzQyxPQUFPLENBQUMsbUJBQW1CLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDdEMsaUZBQWlGO0lBQ2xGLENBQUMsQ0FBQyxDQUFDO0FBQ0osQ0FBQyxDQUFDLENBQUM7QUFFSCxRQUFRLENBQUMsZ0JBQWdCLEVBQUUsR0FBRyxFQUFFO0lBQy9CLElBQUksT0FBdUIsQ0FBQztJQUM1QixJQUFJLEdBQVEsQ0FBQztJQUViLFVBQVUsQ0FBQyxHQUFHLEVBQUU7UUFDZixHQUFHLEdBQUcsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUNoQixrREFBa0Q7UUFDakQsR0FBVyxDQUFDLFNBQVMsR0FBRztZQUN4QixhQUFhLEVBQUU7Z0JBQ2QsUUFBUSxFQUFFLEVBQUU7YUFDWjtTQUNELENBQUM7UUFDRixPQUFPLEdBQUcsSUFBSSxjQUFjLENBQUMsR0FBRyxFQUFFLFVBQVUsQ0FBQyxDQUFDO0lBQy9DLENBQUMsQ0FBQyxDQUFDO0lBRUgsSUFBSSxDQUFDLDBDQUEwQyxFQUFFLEdBQUcsRUFBRTtRQUNyRCxNQUFNLENBQUMsT0FBTyxDQUFDLG1CQUFtQixFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7UUFFbEQsT0FBTyxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBQ3hCLE1BQU0sQ0FBQyxPQUFPLENBQUMsbUJBQW1CLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUVqRCxPQUFPLENBQUMsWUFBWSxFQUFFLENBQUM7UUFDdkIsTUFBTSxDQUFDLE9BQU8sQ0FBQyxtQkFBbUIsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ25ELENBQUMsQ0FBQyxDQUFDO0lBRUgsSUFBSSxDQUFDLG1DQUFtQyxFQUFFLEdBQUcsRUFBRTtRQUM5QyxNQUFNLFdBQVcsR0FBRyxFQUFTLENBQUM7UUFDOUIsT0FBTyxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBRXhCLE9BQU8sQ0FBQyxzQkFBc0IsQ0FBQyxXQUFXLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFFcEQsTUFBTSxjQUFjLEdBQUcsT0FBTyxDQUFDLGlCQUFpQixFQUFFLENBQUM7UUFDbkQsTUFBTSxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDOUMsTUFBTSxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7SUFDdEQsQ0FBQyxDQUFDLENBQUM7SUFFSCxJQUFJLENBQUMsZ0NBQWdDLEVBQUUsR0FBRyxFQUFFO1FBQzNDLE1BQU0sV0FBVyxHQUFHLEVBQVMsQ0FBQztRQUM5QixPQUFPLENBQUMsYUFBYSxFQUFFLENBQUM7UUFFeEIsT0FBTyxDQUFDLHNCQUFzQixDQUFDLFdBQVcsRUFBRSxNQUFNLENBQUMsQ0FBQztRQUNwRCxNQUFNLENBQUMsT0FBTyxDQUFDLGlCQUFpQixFQUFFLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRTNELE9BQU8sQ0FBQyxvQkFBb0IsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUNyQyxNQUFNLENBQUMsT0FBTyxDQUFDLGlCQUFpQixFQUFFLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQzdELENBQUMsQ0FBQyxDQUFDO0lBRUgsSUFBSSxDQUFDLHlCQUF5QixFQUFFLEdBQUcsRUFBRTtRQUNwQyxPQUFPLENBQUMsYUFBYSxFQUFFLENBQUM7UUFDeEIsT0FBTyxDQUFDLHNCQUFzQixDQUFDLEVBQVMsRUFBRSxPQUFPLENBQUMsQ0FBQztRQUNuRCxPQUFPLENBQUMsc0JBQXNCLENBQUMsRUFBUyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBRW5ELE1BQU0sQ0FBQyxPQUFPLENBQUMsaUJBQWlCLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFFakQsT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQ2xCLE1BQU0sQ0FBQyxPQUFPLENBQUMsbUJBQW1CLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNsRCxNQUFNLENBQUMsT0FBTyxDQUFDLGlCQUFpQixFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ2xELENBQUMsQ0FBQyxDQUFDO0FBQ0osQ0FBQyxDQUFDLENBQUM7QUFFSCxRQUFRLENBQUMsMEJBQTBCLEVBQUUsR0FBRyxFQUFFO0lBQ3pDLElBQUksQ0FBQyxrREFBa0QsRUFBRSxHQUFHLEVBQUU7UUFDN0QsTUFBTSxXQUFXLEdBQUcsMEJBQTBCLENBQUMsR0FBRyxFQUFFLFVBQVUsQ0FBQyxDQUFDO1FBQ2hFLE1BQU0sQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzlDLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ3pDLE1BQU0sQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNyRSxDQUFDLENBQUMsQ0FBQztJQUVILElBQUksQ0FBQyw4Q0FBOEMsRUFBRSxHQUFHLEVBQUU7UUFDekQsTUFBTSxXQUFXLEdBQUcsMEJBQTBCLENBQUMsR0FBRyxFQUFFLFVBQVUsQ0FBQyxDQUFDO1FBQ2hFLE1BQU0sQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzlDLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ3pDLE1BQU0sQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNqRSxDQUFDLENBQUMsQ0FBQztJQUVILElBQUksQ0FBQyxnREFBZ0QsRUFBRSxHQUFHLEVBQUU7UUFDM0QsTUFBTSxXQUFXLEdBQUcsMEJBQTBCLENBQUMsR0FBRyxFQUFFLFVBQVUsQ0FBQyxDQUFDO1FBQ2hFLE1BQU0sQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzlDLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ3pDLE1BQU0sQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNuRSxDQUFDLENBQUMsQ0FBQztJQUVILElBQUksQ0FBQyw2Q0FBNkMsRUFBRSxHQUFHLEVBQUU7UUFDeEQsTUFBTSxXQUFXLEdBQUcsMEJBQTBCLENBQUMsR0FBRyxFQUFFLFVBQVUsQ0FBQyxDQUFDO1FBQ2hFLE1BQU0sQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzlDLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ3pDLE1BQU0sQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNoRSxDQUFDLENBQUMsQ0FBQztJQUVILElBQUksQ0FBQywrQ0FBK0MsRUFBRSxHQUFHLEVBQUU7UUFDMUQsTUFBTSxXQUFXLEdBQUcsMEJBQTBCLENBQUMsR0FBRyxFQUFFLFVBQVUsQ0FBQyxDQUFDO1FBQ2hFLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDakMsQ0FBQyxDQUFDLENBQUM7QUFDSixDQUFDLENBQUMsQ0FBQztBQUVILFFBQVEsQ0FBQyxtQkFBbUIsRUFBRSxHQUFHLEVBQUU7SUFDbEMsSUFBSSxDQUFDLDJEQUEyRCxFQUFFLEdBQUcsRUFBRTtRQUN0RSxNQUFNLEdBQUcsR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQ3JCLEdBQVcsQ0FBQyxTQUFTLEdBQUc7WUFDeEIsYUFBYSxFQUFFO2dCQUNkLFFBQVEsRUFBRSxFQUFFO2FBQ1o7U0FDRCxDQUFDO1FBRUYsTUFBTSxPQUFPLEdBQUcsSUFBSSxjQUFjLENBQUMsR0FBRyxFQUFFLFVBQVUsQ0FBQyxDQUFDO1FBQ3BELE9BQU8sQ0FBQyxhQUFhLEVBQUUsQ0FBQztRQUV4QixNQUFNLFVBQVUsR0FBRyxFQUFZLENBQUM7UUFDaEMsTUFBTSxPQUFPLEdBQUcsT0FBTyxDQUFDLHFCQUFxQixDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBRTFELE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxjQUFjLENBQUMsc0JBQXNCLENBQUMsQ0FBQztRQUN2RCxNQUFNLENBQUMsT0FBTyxDQUFDLGlCQUFpQixFQUFFLENBQUMsR0FBRyxDQUFDLHlCQUF5QixDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFOUUsT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFDO0lBQ25CLENBQUMsQ0FBQyxDQUFDO0lBRUgsSUFBSSxDQUFDLHlDQUF5QyxFQUFFLEdBQUcsRUFBRTtRQUNwRCxNQUFNLEdBQUcsR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQ3JCLEdBQVcsQ0FBQyxTQUFTLEdBQUc7WUFDeEIsYUFBYSxFQUFFO2dCQUNkLFFBQVEsRUFBRSxFQUFFO2FBQ1o7U0FDRCxDQUFDO1FBRUYsTUFBTSxPQUFPLEdBQUcsSUFBSSxjQUFjLENBQUMsR0FBRyxFQUFFLFVBQVUsQ0FBQyxDQUFDO1FBRXBELDRCQUE0QjtRQUM1QixNQUFNLFVBQVUsR0FBRyxDQUFDLE1BQWMsRUFBRSxJQUFXLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQztRQUN6RCxPQUFPLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxFQUFFLFVBQVUsQ0FBQyxDQUFDO1FBRTdDLE1BQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxTQUFTLEVBQUUsQ0FBQztRQUNuQyxNQUFNLENBQUMsTUFBTSxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUV2RCx3QkFBd0I7UUFDeEIsT0FBTyxDQUFDLG1CQUFtQixDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ3BDLE1BQU0sYUFBYSxHQUFHLE9BQU8sQ0FBQyxTQUFTLEVBQUUsQ0FBQztRQUMxQyxNQUFNLENBQUMsYUFBYSxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLGFBQWEsRUFBRSxDQUFDO0lBQzlELENBQUMsQ0FBQyxDQUFDO0FBQ0osQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBcHAsIEVkaXRvciwgRWRpdG9yUG9zaXRpb24sIFRGaWxlIH0gZnJvbSBcIm9ic2lkaWFuXCI7XHJcbmltcG9ydCB7IFVuaXZlcnNhbEVkaXRvclN1Z2dlc3QsIFN1Z2dlc3RNYW5hZ2VyIH0gZnJvbSBcIi4uL2NvbXBvbmVudHMvdWkvc3VnZ2VzdFwiO1xyXG5pbXBvcnQgVGFza1Byb2dyZXNzQmFyUGx1Z2luIGZyb20gXCIuLi9pbmRleFwiO1xyXG5pbXBvcnQgeyBnZXRTdWdnZXN0T3B0aW9uc0J5VHJpZ2dlciB9IGZyb20gXCIuLi9jb21wb25lbnRzL3VpL3N1Z2dlc3QvU3BlY2lhbENoYXJhY3RlclN1Z2dlc3RzXCI7XHJcblxyXG4vLyBNb2NrIE9ic2lkaWFuIG1vZHVsZXNcclxuamVzdC5tb2NrKFwib2JzaWRpYW5cIiwgKCkgPT4gKHtcclxuXHRBcHA6IGplc3QuZm4oKSxcclxuXHRFZGl0b3I6IGplc3QuZm4oKSxcclxuXHRFZGl0b3JQb3NpdGlvbjogamVzdC5mbigpLFxyXG5cdFRGaWxlOiBqZXN0LmZuKCksXHJcblx0RWRpdG9yU3VnZ2VzdDogY2xhc3Mge1xyXG5cdFx0Y29uc3RydWN0b3IoKSB7fVxyXG5cdFx0Z2V0U3VnZ2VzdGlvbnMoKSB7IHJldHVybiBbXTsgfVxyXG5cdFx0cmVuZGVyU3VnZ2VzdGlvbigpIHt9XHJcblx0XHRzZWxlY3RTdWdnZXN0aW9uKCkge31cclxuXHRcdG9uVHJpZ2dlcigpIHsgcmV0dXJuIG51bGw7IH1cclxuXHRcdGNsb3NlKCkge31cclxuXHR9LFxyXG5cdHNldEljb246IGplc3QuZm4oKSxcclxufSkpO1xyXG5cclxuLy8gTW9jayBtb21lbnQgbW9kdWxlXHJcbmplc3QubW9jayhcIm1vbWVudFwiLCAoKSA9PiB7XHJcblx0Y29uc3QgbW9tZW50ID0gZnVuY3Rpb24oaW5wdXQ/OiBhbnkpIHtcclxuXHRcdHJldHVybiB7XHJcblx0XHRcdGZvcm1hdDogKCkgPT4gXCIyMDI0LTAxLTAxXCIsXHJcblx0XHRcdGRpZmY6ICgpID0+IDAsXHJcblx0XHRcdHN0YXJ0T2Y6ICgpID0+IG1vbWVudChpbnB1dCksXHJcblx0XHRcdGVuZE9mOiAoKSA9PiBtb21lbnQoaW5wdXQpLFxyXG5cdFx0XHRpc1NhbWU6ICgpID0+IHRydWUsXHJcblx0XHRcdGlzU2FtZU9yQmVmb3JlOiAoKSA9PiB0cnVlLFxyXG5cdFx0XHRpc1NhbWVPckFmdGVyOiAoKSA9PiB0cnVlLFxyXG5cdFx0XHRpc0JlZm9yZTogKCkgPT4gZmFsc2UsXHJcblx0XHRcdGlzQWZ0ZXI6ICgpID0+IGZhbHNlLFxyXG5cdFx0XHRpc0JldHdlZW46ICgpID0+IHRydWUsXHJcblx0XHRcdGNsb25lOiAoKSA9PiBtb21lbnQoaW5wdXQpLFxyXG5cdFx0XHRhZGQ6ICgpID0+IG1vbWVudChpbnB1dCksXHJcblx0XHRcdHN1YnRyYWN0OiAoKSA9PiBtb21lbnQoaW5wdXQpLFxyXG5cdFx0XHR2YWx1ZU9mOiAoKSA9PiBEYXRlLm5vdygpLFxyXG5cdFx0XHR0b0RhdGU6ICgpID0+IG5ldyBEYXRlKCksXHJcblx0XHRcdHdlZWtkYXk6ICgpID0+IDAsXHJcblx0XHRcdGRheTogKCkgPT4gMSxcclxuXHRcdFx0ZGF0ZTogKCkgPT4gMSxcclxuXHRcdH07XHJcblx0fTtcclxuXHRtb21lbnQubG9jYWxlID0gamVzdC5mbigoKSA9PiBcImVuXCIpO1xyXG5cdG1vbWVudC51dGMgPSAoKSA9PiAoeyBmb3JtYXQ6ICgpID0+IFwiMDA6MDA6MDBcIiB9KTtcclxuXHRtb21lbnQuZHVyYXRpb24gPSAoKSA9PiAoeyBhc01pbGxpc2Vjb25kczogKCkgPT4gMCB9KTtcclxuXHRtb21lbnQud2Vla2RheXNTaG9ydCA9ICgpID0+IFtcIlN1blwiLCBcIk1vblwiLCBcIlR1ZVwiLCBcIldlZFwiLCBcIlRodVwiLCBcIkZyaVwiLCBcIlNhdFwiXTtcclxuXHRtb21lbnQud2Vla2RheXNNaW4gPSAoKSA9PiBbXCJTdVwiLCBcIk1vXCIsIFwiVHVcIiwgXCJXZVwiLCBcIlRoXCIsIFwiRnJcIiwgXCJTYVwiXTtcclxuXHRyZXR1cm4gbW9tZW50O1xyXG59KTtcclxuXHJcbi8vIE1vY2sgcGx1Z2luXHJcbmNvbnN0IG1vY2tQbHVnaW4gPSB7XHJcblx0YXBwOiB7XHJcblx0XHR3b3Jrc3BhY2U6IHtcclxuXHRcdFx0Z2V0TGFzdE9wZW5GaWxlczogKCkgPT4gW1wiZmlsZTEubWRcIiwgXCJmaWxlMi5tZFwiLCBcImZpbGUzLm1kXCJdLFxyXG5cdFx0fSxcclxuXHRcdG1ldGFkYXRhQ2FjaGU6IHtcclxuXHRcdFx0Z2V0VGFnczogKCkgPT4gKHtcclxuXHRcdFx0XHRcIiN0YWcxXCI6IDUsXHJcblx0XHRcdFx0XCIjdGFnMlwiOiAzLFxyXG5cdFx0XHRcdFwiI+mHjeimgVwiOiAyLFxyXG5cdFx0XHR9KSxcclxuXHRcdH0sXHJcblx0fSBhcyBhbnksXHJcblx0c2V0dGluZ3M6IHtcclxuXHRcdHByZWZlck1ldGFkYXRhRm9ybWF0OiBcInRhc2tzXCIsXHJcblx0fSxcclxufSBhcyBUYXNrUHJvZ3Jlc3NCYXJQbHVnaW47XHJcblxyXG5kZXNjcmliZShcIlVuaXZlcnNhbEVkaXRvclN1Z2dlc3RcIiwgKCkgPT4ge1xyXG5cdGxldCBzdWdnZXN0OiBVbml2ZXJzYWxFZGl0b3JTdWdnZXN0O1xyXG5cdGxldCBhcHA6IEFwcDtcclxuXHJcblx0YmVmb3JlRWFjaCgoKSA9PiB7XHJcblx0XHRhcHAgPSBuZXcgQXBwKCk7XHJcblx0XHRzdWdnZXN0ID0gbmV3IFVuaXZlcnNhbEVkaXRvclN1Z2dlc3QoYXBwLCBtb2NrUGx1Z2luLCB7XHJcblx0XHRcdHRyaWdnZXJDaGFyczogW1wiIVwiLCBcIn5cIiwgXCIqXCIsIFwiI1wiXSxcclxuXHRcdH0pO1xyXG5cdH0pO1xyXG5cclxuXHR0ZXN0KFwic2hvdWxkIGluaXRpYWxpemUgd2l0aCBjb3JyZWN0IHRyaWdnZXIgY2hhcmFjdGVyc1wiLCAoKSA9PiB7XHJcblx0XHRjb25zdCBjb25maWcgPSBzdWdnZXN0LmdldENvbmZpZygpO1xyXG5cdFx0ZXhwZWN0KGNvbmZpZy50cmlnZ2VyQ2hhcnMpLnRvRXF1YWwoW1wiIVwiLCBcIn5cIiwgXCIqXCIsIFwiI1wiXSk7XHJcblx0fSk7XHJcblxyXG5cdHRlc3QoXCJzaG91bGQgZW5hYmxlIGFuZCBkaXNhYmxlIGNvcnJlY3RseVwiLCAoKSA9PiB7XHJcblx0XHRzdWdnZXN0LmVuYWJsZSgpO1xyXG5cdFx0ZXhwZWN0KHN1Z2dlc3RbXCJpc0VuYWJsZWRcIl0pLnRvQmUodHJ1ZSk7XHJcblxyXG5cdFx0c3VnZ2VzdC5kaXNhYmxlKCk7XHJcblx0XHRleHBlY3Qoc3VnZ2VzdFtcImlzRW5hYmxlZFwiXSkudG9CZShmYWxzZSk7XHJcblx0fSk7XHJcblxyXG5cdHRlc3QoXCJzaG91bGQgYWRkIGFuZCByZW1vdmUgc3VnZ2VzdCBvcHRpb25zXCIsICgpID0+IHtcclxuXHRcdGNvbnN0IGN1c3RvbU9wdGlvbiA9IHtcclxuXHRcdFx0aWQ6IFwiY3VzdG9tXCIsXHJcblx0XHRcdGxhYmVsOiBcIkN1c3RvbVwiLFxyXG5cdFx0XHRpY29uOiBcInN0YXJcIixcclxuXHRcdFx0ZGVzY3JpcHRpb246IFwiQ3VzdG9tIG9wdGlvblwiLFxyXG5cdFx0XHRyZXBsYWNlbWVudDogXCIlXCIsXHJcblx0XHRcdHRyaWdnZXI6IFwiJVwiLFxyXG5cdFx0fTtcclxuXHJcblx0XHRzdWdnZXN0LmFkZFN1Z2dlc3RPcHRpb24oY3VzdG9tT3B0aW9uKTtcclxuXHRcdGNvbnN0IGNvbmZpZyA9IHN1Z2dlc3QuZ2V0Q29uZmlnKCk7XHJcblx0XHRleHBlY3QoY29uZmlnLnRyaWdnZXJDaGFycykudG9Db250YWluKFwiJVwiKTtcclxuXHJcblx0XHRzdWdnZXN0LnJlbW92ZVN1Z2dlc3RPcHRpb24oXCJjdXN0b21cIik7XHJcblx0XHQvLyBOb3RlOiBUaGlzIHRlc3Qgd291bGQgbmVlZCBhY2Nlc3MgdG8gaW50ZXJuYWwgc3VnZ2VzdE9wdGlvbnMgdG8gdmVyaWZ5IHJlbW92YWxcclxuXHR9KTtcclxufSk7XHJcblxyXG5kZXNjcmliZShcIlN1Z2dlc3RNYW5hZ2VyXCIsICgpID0+IHtcclxuXHRsZXQgbWFuYWdlcjogU3VnZ2VzdE1hbmFnZXI7XHJcblx0bGV0IGFwcDogQXBwO1xyXG5cclxuXHRiZWZvcmVFYWNoKCgpID0+IHtcclxuXHRcdGFwcCA9IG5ldyBBcHAoKTtcclxuXHRcdC8vIE1vY2sgdGhlIHdvcmtzcGFjZS5lZGl0b3JTdWdnZXN0LnN1Z2dlc3RzIGFycmF5XHJcblx0XHQoYXBwIGFzIGFueSkud29ya3NwYWNlID0ge1xyXG5cdFx0XHRlZGl0b3JTdWdnZXN0OiB7XHJcblx0XHRcdFx0c3VnZ2VzdHM6IFtdLFxyXG5cdFx0XHR9LFxyXG5cdFx0fTtcclxuXHRcdG1hbmFnZXIgPSBuZXcgU3VnZ2VzdE1hbmFnZXIoYXBwLCBtb2NrUGx1Z2luKTtcclxuXHR9KTtcclxuXHJcblx0dGVzdChcInNob3VsZCBzdGFydCBhbmQgc3RvcCBtYW5hZ2luZyBjb3JyZWN0bHlcIiwgKCkgPT4ge1xyXG5cdFx0ZXhwZWN0KG1hbmFnZXIuaXNDdXJyZW50bHlNYW5hZ2luZygpKS50b0JlKGZhbHNlKTtcclxuXHJcblx0XHRtYW5hZ2VyLnN0YXJ0TWFuYWdpbmcoKTtcclxuXHRcdGV4cGVjdChtYW5hZ2VyLmlzQ3VycmVudGx5TWFuYWdpbmcoKSkudG9CZSh0cnVlKTtcclxuXHJcblx0XHRtYW5hZ2VyLnN0b3BNYW5hZ2luZygpO1xyXG5cdFx0ZXhwZWN0KG1hbmFnZXIuaXNDdXJyZW50bHlNYW5hZ2luZygpKS50b0JlKGZhbHNlKTtcclxuXHR9KTtcclxuXHJcblx0dGVzdChcInNob3VsZCBhZGQgc3VnZ2VzdHMgd2l0aCBwcmlvcml0eVwiLCAoKSA9PiB7XHJcblx0XHRjb25zdCBtb2NrU3VnZ2VzdCA9IHt9IGFzIGFueTtcclxuXHRcdG1hbmFnZXIuc3RhcnRNYW5hZ2luZygpO1xyXG5cdFx0XHJcblx0XHRtYW5hZ2VyLmFkZFN1Z2dlc3RXaXRoUHJpb3JpdHkobW9ja1N1Z2dlc3QsIFwidGVzdFwiKTtcclxuXHRcdFxyXG5cdFx0Y29uc3QgYWN0aXZlU3VnZ2VzdHMgPSBtYW5hZ2VyLmdldEFjdGl2ZVN1Z2dlc3RzKCk7XHJcblx0XHRleHBlY3QoYWN0aXZlU3VnZ2VzdHMuaGFzKFwidGVzdFwiKSkudG9CZSh0cnVlKTtcclxuXHRcdGV4cGVjdChhY3RpdmVTdWdnZXN0cy5nZXQoXCJ0ZXN0XCIpKS50b0JlKG1vY2tTdWdnZXN0KTtcclxuXHR9KTtcclxuXHJcblx0dGVzdChcInNob3VsZCByZW1vdmUgbWFuYWdlZCBzdWdnZXN0c1wiLCAoKSA9PiB7XHJcblx0XHRjb25zdCBtb2NrU3VnZ2VzdCA9IHt9IGFzIGFueTtcclxuXHRcdG1hbmFnZXIuc3RhcnRNYW5hZ2luZygpO1xyXG5cdFx0XHJcblx0XHRtYW5hZ2VyLmFkZFN1Z2dlc3RXaXRoUHJpb3JpdHkobW9ja1N1Z2dlc3QsIFwidGVzdFwiKTtcclxuXHRcdGV4cGVjdChtYW5hZ2VyLmdldEFjdGl2ZVN1Z2dlc3RzKCkuaGFzKFwidGVzdFwiKSkudG9CZSh0cnVlKTtcclxuXHRcdFxyXG5cdFx0bWFuYWdlci5yZW1vdmVNYW5hZ2VkU3VnZ2VzdChcInRlc3RcIik7XHJcblx0XHRleHBlY3QobWFuYWdlci5nZXRBY3RpdmVTdWdnZXN0cygpLmhhcyhcInRlc3RcIikpLnRvQmUoZmFsc2UpO1xyXG5cdH0pO1xyXG5cclxuXHR0ZXN0KFwic2hvdWxkIGNsZWFudXAgcHJvcGVybHlcIiwgKCkgPT4ge1xyXG5cdFx0bWFuYWdlci5zdGFydE1hbmFnaW5nKCk7XHJcblx0XHRtYW5hZ2VyLmFkZFN1Z2dlc3RXaXRoUHJpb3JpdHkoe30gYXMgYW55LCBcInRlc3QxXCIpO1xyXG5cdFx0bWFuYWdlci5hZGRTdWdnZXN0V2l0aFByaW9yaXR5KHt9IGFzIGFueSwgXCJ0ZXN0MlwiKTtcclxuXHRcdFxyXG5cdFx0ZXhwZWN0KG1hbmFnZXIuZ2V0QWN0aXZlU3VnZ2VzdHMoKS5zaXplKS50b0JlKDIpO1xyXG5cdFx0XHJcblx0XHRtYW5hZ2VyLmNsZWFudXAoKTtcclxuXHRcdGV4cGVjdChtYW5hZ2VyLmlzQ3VycmVudGx5TWFuYWdpbmcoKSkudG9CZShmYWxzZSk7XHJcblx0XHRleHBlY3QobWFuYWdlci5nZXRBY3RpdmVTdWdnZXN0cygpLnNpemUpLnRvQmUoMCk7XHJcblx0fSk7XHJcbn0pO1xyXG5cclxuZGVzY3JpYmUoXCJTcGVjaWFsQ2hhcmFjdGVyU3VnZ2VzdHNcIiwgKCkgPT4ge1xyXG5cdHRlc3QoXCJzaG91bGQgcmV0dXJuIHByaW9yaXR5IHN1Z2dlc3Rpb25zIGZvciAhIHRyaWdnZXJcIiwgKCkgPT4ge1xyXG5cdFx0Y29uc3Qgc3VnZ2VzdGlvbnMgPSBnZXRTdWdnZXN0T3B0aW9uc0J5VHJpZ2dlcihcIiFcIiwgbW9ja1BsdWdpbik7XHJcblx0XHRleHBlY3Qoc3VnZ2VzdGlvbnMubGVuZ3RoKS50b0JlR3JlYXRlclRoYW4oMCk7XHJcblx0XHRleHBlY3Qoc3VnZ2VzdGlvbnNbMF0udHJpZ2dlcikudG9CZShcIiFcIik7XHJcblx0XHRleHBlY3Qoc3VnZ2VzdGlvbnMuc29tZShzID0+IHMuaWQuaW5jbHVkZXMoXCJwcmlvcml0eVwiKSkpLnRvQmUodHJ1ZSk7XHJcblx0fSk7XHJcblxyXG5cdHRlc3QoXCJzaG91bGQgcmV0dXJuIGRhdGUgc3VnZ2VzdGlvbnMgZm9yIH4gdHJpZ2dlclwiLCAoKSA9PiB7XHJcblx0XHRjb25zdCBzdWdnZXN0aW9ucyA9IGdldFN1Z2dlc3RPcHRpb25zQnlUcmlnZ2VyKFwiflwiLCBtb2NrUGx1Z2luKTtcclxuXHRcdGV4cGVjdChzdWdnZXN0aW9ucy5sZW5ndGgpLnRvQmVHcmVhdGVyVGhhbigwKTtcclxuXHRcdGV4cGVjdChzdWdnZXN0aW9uc1swXS50cmlnZ2VyKS50b0JlKFwiflwiKTtcclxuXHRcdGV4cGVjdChzdWdnZXN0aW9ucy5zb21lKHMgPT4gcy5pZC5pbmNsdWRlcyhcImRhdGVcIikpKS50b0JlKHRydWUpO1xyXG5cdH0pO1xyXG5cclxuXHR0ZXN0KFwic2hvdWxkIHJldHVybiB0YXJnZXQgc3VnZ2VzdGlvbnMgZm9yICogdHJpZ2dlclwiLCAoKSA9PiB7XHJcblx0XHRjb25zdCBzdWdnZXN0aW9ucyA9IGdldFN1Z2dlc3RPcHRpb25zQnlUcmlnZ2VyKFwiKlwiLCBtb2NrUGx1Z2luKTtcclxuXHRcdGV4cGVjdChzdWdnZXN0aW9ucy5sZW5ndGgpLnRvQmVHcmVhdGVyVGhhbigwKTtcclxuXHRcdGV4cGVjdChzdWdnZXN0aW9uc1swXS50cmlnZ2VyKS50b0JlKFwiKlwiKTtcclxuXHRcdGV4cGVjdChzdWdnZXN0aW9ucy5zb21lKHMgPT4gcy5pZC5pbmNsdWRlcyhcInRhcmdldFwiKSkpLnRvQmUodHJ1ZSk7XHJcblx0fSk7XHJcblxyXG5cdHRlc3QoXCJzaG91bGQgcmV0dXJuIHRhZyBzdWdnZXN0aW9ucyBmb3IgIyB0cmlnZ2VyXCIsICgpID0+IHtcclxuXHRcdGNvbnN0IHN1Z2dlc3Rpb25zID0gZ2V0U3VnZ2VzdE9wdGlvbnNCeVRyaWdnZXIoXCIjXCIsIG1vY2tQbHVnaW4pO1xyXG5cdFx0ZXhwZWN0KHN1Z2dlc3Rpb25zLmxlbmd0aCkudG9CZUdyZWF0ZXJUaGFuKDApO1xyXG5cdFx0ZXhwZWN0KHN1Z2dlc3Rpb25zWzBdLnRyaWdnZXIpLnRvQmUoXCIjXCIpO1xyXG5cdFx0ZXhwZWN0KHN1Z2dlc3Rpb25zLnNvbWUocyA9PiBzLmlkLmluY2x1ZGVzKFwidGFnXCIpKSkudG9CZSh0cnVlKTtcclxuXHR9KTtcclxuXHJcblx0dGVzdChcInNob3VsZCByZXR1cm4gZW1wdHkgYXJyYXkgZm9yIHVua25vd24gdHJpZ2dlclwiLCAoKSA9PiB7XHJcblx0XHRjb25zdCBzdWdnZXN0aW9ucyA9IGdldFN1Z2dlc3RPcHRpb25zQnlUcmlnZ2VyKFwiP1wiLCBtb2NrUGx1Z2luKTtcclxuXHRcdGV4cGVjdChzdWdnZXN0aW9ucykudG9FcXVhbChbXSk7XHJcblx0fSk7XHJcbn0pO1xyXG5cclxuZGVzY3JpYmUoXCJJbnRlZ3JhdGlvbiBUZXN0c1wiLCAoKSA9PiB7XHJcblx0dGVzdChcInNob3VsZCBjcmVhdGUgdW5pdmVyc2FsIHN1Z2dlc3QgZm9yIG1pbmltYWwgbW9kYWwgY29udGV4dFwiLCAoKSA9PiB7XHJcblx0XHRjb25zdCBhcHAgPSBuZXcgQXBwKCk7XHJcblx0XHQoYXBwIGFzIGFueSkud29ya3NwYWNlID0ge1xyXG5cdFx0XHRlZGl0b3JTdWdnZXN0OiB7XHJcblx0XHRcdFx0c3VnZ2VzdHM6IFtdLFxyXG5cdFx0XHR9LFxyXG5cdFx0fTtcclxuXHRcdFxyXG5cdFx0Y29uc3QgbWFuYWdlciA9IG5ldyBTdWdnZXN0TWFuYWdlcihhcHAsIG1vY2tQbHVnaW4pO1xyXG5cdFx0bWFuYWdlci5zdGFydE1hbmFnaW5nKCk7XHJcblx0XHRcclxuXHRcdGNvbnN0IG1vY2tFZGl0b3IgPSB7fSBhcyBFZGl0b3I7XHJcblx0XHRjb25zdCBzdWdnZXN0ID0gbWFuYWdlci5lbmFibGVGb3JNaW5pbWFsTW9kYWwobW9ja0VkaXRvcik7XHJcblx0XHRcclxuXHRcdGV4cGVjdChzdWdnZXN0KS50b0JlSW5zdGFuY2VPZihVbml2ZXJzYWxFZGl0b3JTdWdnZXN0KTtcclxuXHRcdGV4cGVjdChtYW5hZ2VyLmdldEFjdGl2ZVN1Z2dlc3RzKCkuaGFzKFwidW5pdmVyc2FsLW1pbmltYWwtbW9kYWxcIikpLnRvQmUodHJ1ZSk7XHJcblx0XHRcclxuXHRcdG1hbmFnZXIuY2xlYW51cCgpO1xyXG5cdH0pO1xyXG5cclxuXHR0ZXN0KFwic2hvdWxkIGhhbmRsZSBjb250ZXh0IGZpbHRlcnMgY29ycmVjdGx5XCIsICgpID0+IHtcclxuXHRcdGNvbnN0IGFwcCA9IG5ldyBBcHAoKTtcclxuXHRcdChhcHAgYXMgYW55KS53b3Jrc3BhY2UgPSB7XHJcblx0XHRcdGVkaXRvclN1Z2dlc3Q6IHtcclxuXHRcdFx0XHRzdWdnZXN0czogW10sXHJcblx0XHRcdH0sXHJcblx0XHR9O1xyXG5cdFx0XHJcblx0XHRjb25zdCBtYW5hZ2VyID0gbmV3IFN1Z2dlc3RNYW5hZ2VyKGFwcCwgbW9ja1BsdWdpbik7XHJcblx0XHRcclxuXHRcdC8vIEFkZCBjdXN0b20gY29udGV4dCBmaWx0ZXJcclxuXHRcdGNvbnN0IHRlc3RGaWx0ZXIgPSAoZWRpdG9yOiBFZGl0b3IsIGZpbGU6IFRGaWxlKSA9PiB0cnVlO1xyXG5cdFx0bWFuYWdlci5hZGRDb250ZXh0RmlsdGVyKFwidGVzdFwiLCB0ZXN0RmlsdGVyKTtcclxuXHRcdFxyXG5cdFx0Y29uc3QgY29uZmlnID0gbWFuYWdlci5nZXRDb25maWcoKTtcclxuXHRcdGV4cGVjdChjb25maWcuY29udGV4dEZpbHRlcnNbXCJ0ZXN0XCJdKS50b0JlKHRlc3RGaWx0ZXIpO1xyXG5cdFx0XHJcblx0XHQvLyBSZW1vdmUgY29udGV4dCBmaWx0ZXJcclxuXHRcdG1hbmFnZXIucmVtb3ZlQ29udGV4dEZpbHRlcihcInRlc3RcIik7XHJcblx0XHRjb25zdCB1cGRhdGVkQ29uZmlnID0gbWFuYWdlci5nZXRDb25maWcoKTtcclxuXHRcdGV4cGVjdCh1cGRhdGVkQ29uZmlnLmNvbnRleHRGaWx0ZXJzW1widGVzdFwiXSkudG9CZVVuZGVmaW5lZCgpO1xyXG5cdH0pO1xyXG59KTtcclxuIl19