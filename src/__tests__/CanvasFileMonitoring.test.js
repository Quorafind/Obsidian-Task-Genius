/**
 * Tests for Canvas file monitoring functionality
 * This test verifies that Canvas files are properly monitored for changes
 */
import { __awaiter } from "tslib";
import { isSupportedFile, isCanvasFile } from '../utils/file/file-type-detector';
// Mock TFile for testing
class MockTFile {
    constructor(path, extension, stat = { mtime: Date.now() }) {
        this.path = path;
        this.extension = extension;
        this.stat = stat;
    }
    get name() {
        return this.path.split('/').pop() || '';
    }
}
// Mock Vault for file monitoring tests
class MockVault {
    constructor() {
        this.files = new Map();
        this.eventListeners = new Map();
    }
    getFiles() {
        return Array.from(this.files.keys()).map(path => {
            const extension = path.split('.').pop() || '';
            return new MockTFile(path, extension);
        });
    }
    getFileByPath(path) {
        if (this.files.has(path)) {
            const extension = path.split('.').pop() || '';
            return new MockTFile(path, extension);
        }
        return null;
    }
    read(file) {
        return __awaiter(this, void 0, void 0, function* () {
            return this.files.get(file.path) || '';
        });
    }
    modify(file, content) {
        return __awaiter(this, void 0, void 0, function* () {
            this.files.set(file.path, content);
            this.triggerEvent('modify', file);
        });
    }
    setFileContent(path, content) {
        this.files.set(path, content);
    }
    getFileContent(path) {
        return this.files.get(path);
    }
    // Mock event system
    on(eventName, callback) {
        if (!this.eventListeners.has(eventName)) {
            this.eventListeners.set(eventName, []);
        }
        this.eventListeners.get(eventName).push(callback);
        return { unload: () => { } }; // Mock event reference
    }
    triggerEvent(eventName, ...args) {
        const listeners = this.eventListeners.get(eventName) || [];
        listeners.forEach(listener => listener(...args));
    }
    // Simulate file creation
    createFile(path, content) {
        this.setFileContent(path, content);
        const extension = path.split('.').pop() || '';
        const file = new MockTFile(path, extension);
        this.triggerEvent('create', file);
        return file;
    }
    // Simulate file deletion
    deleteFile(path) {
        const extension = path.split('.').pop() || '';
        const file = new MockTFile(path, extension);
        this.files.delete(path);
        this.triggerEvent('delete', file);
    }
}
describe('Canvas File Monitoring', () => {
    let mockVault;
    let modifyEventTriggered;
    let createEventTriggered;
    let deleteEventTriggered;
    let lastModifiedFile;
    beforeEach(() => {
        mockVault = new MockVault();
        modifyEventTriggered = false;
        createEventTriggered = false;
        deleteEventTriggered = false;
        lastModifiedFile = null;
        // Set up event listeners to track events
        mockVault.on('modify', (file) => {
            if (isSupportedFile(file)) {
                modifyEventTriggered = true;
                lastModifiedFile = file;
            }
        });
        mockVault.on('create', (file) => {
            if (isSupportedFile(file)) {
                createEventTriggered = true;
            }
        });
        mockVault.on('delete', (file) => {
            if (isSupportedFile(file)) {
                deleteEventTriggered = true;
            }
        });
    });
    describe('File Type Detection for Monitoring', () => {
        it('should correctly identify Canvas files as supported for monitoring', () => {
            const canvasFile = new MockTFile('test.canvas', 'canvas');
            expect(isSupportedFile(canvasFile)).toBe(true);
            expect(isCanvasFile(canvasFile)).toBe(true);
        });
        it('should correctly identify markdown files as supported for monitoring', () => {
            const mdFile = new MockTFile('test.md', 'md');
            expect(isSupportedFile(mdFile)).toBe(true);
            expect(isCanvasFile(mdFile)).toBe(false);
        });
        it('should reject unsupported file types for monitoring', () => {
            const txtFile = new MockTFile('test.txt', 'txt');
            expect(isSupportedFile(txtFile)).toBe(false);
        });
    });
    describe('Canvas File Modification Events', () => {
        it('should trigger modify event when Canvas file is changed', () => __awaiter(void 0, void 0, void 0, function* () {
            // Create a Canvas file
            const canvasData = {
                nodes: [
                    {
                        id: 'test-node',
                        type: 'text',
                        text: '# Test\n\n- [ ] Original task',
                        x: 100,
                        y: 100,
                        width: 300,
                        height: 200
                    }
                ],
                edges: []
            };
            const canvasFile = mockVault.createFile('test.canvas', JSON.stringify(canvasData, null, 2));
            // Reset event flags
            modifyEventTriggered = false;
            lastModifiedFile = null;
            // Modify the Canvas file
            const updatedCanvasData = Object.assign(Object.assign({}, canvasData), { nodes: [
                    Object.assign(Object.assign({}, canvasData.nodes[0]), { text: '# Test\n\n- [x] Original task' })
                ] });
            yield mockVault.modify(canvasFile, JSON.stringify(updatedCanvasData, null, 2));
            // Verify that the modify event was triggered
            expect(modifyEventTriggered).toBe(true);
            expect(lastModifiedFile).toBeTruthy();
            expect(lastModifiedFile.path).toBe('test.canvas');
        }));
        it('should trigger create event when new Canvas file is created', () => {
            const canvasData = {
                nodes: [
                    {
                        id: 'new-node',
                        type: 'text',
                        text: '# New Canvas\n\n- [ ] New task',
                        x: 100,
                        y: 100,
                        width: 300,
                        height: 200
                    }
                ],
                edges: []
            };
            mockVault.createFile('new.canvas', JSON.stringify(canvasData, null, 2));
            expect(createEventTriggered).toBe(true);
        });
        it('should trigger delete event when Canvas file is deleted', () => {
            // First create a Canvas file
            const canvasData = {
                nodes: [
                    {
                        id: 'delete-node',
                        type: 'text',
                        text: '# To Delete\n\n- [ ] Task to delete',
                        x: 100,
                        y: 100,
                        width: 300,
                        height: 200
                    }
                ],
                edges: []
            };
            mockVault.createFile('delete.canvas', JSON.stringify(canvasData, null, 2));
            // Reset event flags
            deleteEventTriggered = false;
            // Delete the file
            mockVault.deleteFile('delete.canvas');
            expect(deleteEventTriggered).toBe(true);
        });
    });
    describe('Mixed File Type Monitoring', () => {
        it('should handle both Canvas and Markdown files in monitoring', () => {
            let canvasEventTriggered = false;
            let markdownEventTriggered = false;
            // Set up specific listeners for different file types
            mockVault.on('modify', (file) => {
                if (isCanvasFile(file)) {
                    canvasEventTriggered = true;
                }
                else if (file.extension === 'md') {
                    markdownEventTriggered = true;
                }
            });
            // Create and modify Canvas file
            const canvasFile = mockVault.createFile('mixed.canvas', JSON.stringify({
                nodes: [{ id: 'test', type: 'text', text: '- [ ] Canvas task', x: 0, y: 0, width: 100, height: 100 }],
                edges: []
            }, null, 2));
            // Create and modify Markdown file
            const mdFile = mockVault.createFile('mixed.md', '# Test\n\n- [ ] Markdown task');
            // Reset flags
            canvasEventTriggered = false;
            markdownEventTriggered = false;
            // Modify both files
            mockVault.modify(canvasFile, JSON.stringify({
                nodes: [{ id: 'test', type: 'text', text: '- [x] Canvas task', x: 0, y: 0, width: 100, height: 100 }],
                edges: []
            }, null, 2));
            mockVault.modify(mdFile, '# Test\n\n- [x] Markdown task');
            expect(canvasEventTriggered).toBe(true);
            expect(markdownEventTriggered).toBe(true);
        });
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ2FudmFzRmlsZU1vbml0b3JpbmcudGVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIkNhbnZhc0ZpbGVNb25pdG9yaW5nLnRlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7OztHQUdHOztBQUdILE9BQU8sRUFBRSxlQUFlLEVBQUUsWUFBWSxFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFHakYseUJBQXlCO0FBQ3pCLE1BQU0sU0FBUztJQUNYLFlBQ1csSUFBWSxFQUNaLFNBQWlCLEVBQ2pCLE9BQTBCLEVBQUUsS0FBSyxFQUFFLElBQUksQ0FBQyxHQUFHLEVBQUUsRUFBRTtRQUYvQyxTQUFJLEdBQUosSUFBSSxDQUFRO1FBQ1osY0FBUyxHQUFULFNBQVMsQ0FBUTtRQUNqQixTQUFJLEdBQUosSUFBSSxDQUEyQztJQUN2RCxDQUFDO0lBRUosSUFBSSxJQUFJO1FBQ0osT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLEVBQUUsSUFBSSxFQUFFLENBQUM7SUFDNUMsQ0FBQztDQUNKO0FBRUQsdUNBQXVDO0FBQ3ZDLE1BQU0sU0FBUztJQUFmO1FBQ1ksVUFBSyxHQUF3QixJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQ3ZDLG1CQUFjLEdBQTRCLElBQUksR0FBRyxFQUFFLENBQUM7SUFnRWhFLENBQUM7SUE5REcsUUFBUTtRQUNKLE9BQU8sS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFO1lBQzVDLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxFQUFFLElBQUksRUFBRSxDQUFDO1lBQzlDLE9BQU8sSUFBSSxTQUFTLENBQUMsSUFBSSxFQUFFLFNBQVMsQ0FBUSxDQUFDO1FBQ2pELENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUVELGFB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QUFNLENBQUMsVUFBVSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUM7Z0JBQ3hDLEtBQUssRUFBRSxDQUFDLEVBQUUsRUFBRSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxtQkFBbUIsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLENBQUM7Z0JBQ3JHLEtBQUssRUFBRSxFQUFFO2FBQ1osRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUViLFNBQVMsQ0FBQyxNQUFNLENBQUMsTUFBTSxFQUFFLCtCQUErQixDQUFDLENBQUM7WUFFMUQsTUFBTSxDQUFDLG9CQUFvQixDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ3hDLE1BQU0sQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUM5QyxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUMsQ0FBQyxDQUFDO0FBQ1AsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogVGVzdHMgZm9yIENhbnZhcyBmaWxlIG1vbml0b3JpbmcgZnVuY3Rpb25hbGl0eVxyXG4gKiBUaGlzIHRlc3QgdmVyaWZpZXMgdGhhdCBDYW52YXMgZmlsZXMgYXJlIHByb3Blcmx5IG1vbml0b3JlZCBmb3IgY2hhbmdlc1xyXG4gKi9cclxuXHJcbmltcG9ydCB7IFRGaWxlIH0gZnJvbSAnb2JzaWRpYW4nO1xyXG5pbXBvcnQgeyBpc1N1cHBvcnRlZEZpbGUsIGlzQ2FudmFzRmlsZSB9IGZyb20gJy4uL3V0aWxzL2ZpbGUvZmlsZS10eXBlLWRldGVjdG9yJztcclxuaW1wb3J0IHsgQ2FudmFzRGF0YSB9IGZyb20gJy4uL3R5cGVzL2NhbnZhcyc7XHJcblxyXG4vLyBNb2NrIFRGaWxlIGZvciB0ZXN0aW5nXHJcbmNsYXNzIE1vY2tURmlsZSB7XHJcbiAgICBjb25zdHJ1Y3RvcihcclxuICAgICAgICBwdWJsaWMgcGF0aDogc3RyaW5nLCBcclxuICAgICAgICBwdWJsaWMgZXh0ZW5zaW9uOiBzdHJpbmcsXHJcbiAgICAgICAgcHVibGljIHN0YXQ6IHsgbXRpbWU6IG51bWJlciB9ID0geyBtdGltZTogRGF0ZS5ub3coKSB9XHJcbiAgICApIHt9XHJcblxyXG4gICAgZ2V0IG5hbWUoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMucGF0aC5zcGxpdCgnLycpLnBvcCgpIHx8ICcnO1xyXG4gICAgfVxyXG59XHJcblxyXG4vLyBNb2NrIFZhdWx0IGZvciBmaWxlIG1vbml0b3JpbmcgdGVzdHNcclxuY2xhc3MgTW9ja1ZhdWx0IHtcclxuICAgIHByaXZhdGUgZmlsZXM6IE1hcDxzdHJpbmcsIHN0cmluZz4gPSBuZXcgTWFwKCk7XHJcbiAgICBwcml2YXRlIGV2ZW50TGlzdGVuZXJzOiBNYXA8c3RyaW5nLCBGdW5jdGlvbltdPiA9IG5ldyBNYXAoKTtcclxuXHJcbiAgICBnZXRGaWxlcygpOiBURmlsZVtdIHtcclxuICAgICAgICByZXR1cm4gQXJyYXkuZnJvbSh0aGlzLmZpbGVzLmtleXMoKSkubWFwKHBhdGggPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBleHRlbnNpb24gPSBwYXRoLnNwbGl0KCcuJykucG9wKCkgfHwgJyc7XHJcbiAgICAgICAgICAgIHJldHVybiBuZXcgTW9ja1RGaWxlKHBhdGgsIGV4dGVuc2lvbikgYXMgYW55O1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGdldEZpbGVCeVBhdGgocGF0aDogc3RyaW5nKTogVEZpbGUgfCBudWxsIHtcclxuICAgICAgICBpZiAodGhpcy5maWxlcy5oYXMocGF0aCkpIHtcclxuICAgICAgICAgICAgY29uc3QgZXh0ZW5zaW9uID0gcGF0aC5zcGxpdCgnLicpLnBvcCgpIHx8ICcnO1xyXG4gICAgICAgICAgICByZXR1cm4gbmV3IE1vY2tURmlsZShwYXRoLCBleHRlbnNpb24pIGFzIGFueTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcblxyXG4gICAgYXN5bmMgcmVhZChmaWxlOiBURmlsZSk6IFByb21pc2U8c3RyaW5nPiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZmlsZXMuZ2V0KGZpbGUucGF0aCkgfHwgJyc7XHJcbiAgICB9XHJcblxyXG4gICAgYXN5bmMgbW9kaWZ5KGZpbGU6IFRGaWxlLCBjb250ZW50OiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgICAgICB0aGlzLmZpbGVzLnNldChmaWxlLnBhdGgsIGNvbnRlbnQpO1xyXG4gICAgICAgIHRoaXMudHJpZ2dlckV2ZW50KCdtb2RpZnknLCBmaWxlKTtcclxuICAgIH1cclxuXHJcbiAgICBzZXRGaWxlQ29udGVudChwYXRoOiBzdHJpbmcsIGNvbnRlbnQ6IHN0cmluZyk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMuZmlsZXMuc2V0KHBhdGgsIGNvbnRlbnQpO1xyXG4gICAgfVxyXG5cclxuICAgIGdldEZpbGVDb250ZW50KHBhdGg6IHN0cmluZyk6IHN0cmluZyB8IHVuZGVmaW5lZCB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZmlsZXMuZ2V0KHBhdGgpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIE1vY2sgZXZlbnQgc3lzdGVtXHJcbiAgICBvbihldmVudE5hbWU6IHN0cmluZywgY2FsbGJhY2s6IEZ1bmN0aW9uKTogYW55IHtcclxuICAgICAgICBpZiAoIXRoaXMuZXZlbnRMaXN0ZW5lcnMuaGFzKGV2ZW50TmFtZSkpIHtcclxuICAgICAgICAgICAgdGhpcy5ldmVudExpc3RlbmVycy5zZXQoZXZlbnROYW1lLCBbXSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuZXZlbnRMaXN0ZW5lcnMuZ2V0KGV2ZW50TmFtZSkhLnB1c2goY2FsbGJhY2spO1xyXG4gICAgICAgIHJldHVybiB7IHVubG9hZDogKCkgPT4ge30gfTsgLy8gTW9jayBldmVudCByZWZlcmVuY2VcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHRyaWdnZXJFdmVudChldmVudE5hbWU6IHN0cmluZywgLi4uYXJnczogYW55W10pOiB2b2lkIHtcclxuICAgICAgICBjb25zdCBsaXN0ZW5lcnMgPSB0aGlzLmV2ZW50TGlzdGVuZXJzLmdldChldmVudE5hbWUpIHx8IFtdO1xyXG4gICAgICAgIGxpc3RlbmVycy5mb3JFYWNoKGxpc3RlbmVyID0+IGxpc3RlbmVyKC4uLmFyZ3MpKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBTaW11bGF0ZSBmaWxlIGNyZWF0aW9uXHJcbiAgICBjcmVhdGVGaWxlKHBhdGg6IHN0cmluZywgY29udGVudDogc3RyaW5nKTogVEZpbGUge1xyXG4gICAgICAgIHRoaXMuc2V0RmlsZUNvbnRlbnQocGF0aCwgY29udGVudCk7XHJcbiAgICAgICAgY29uc3QgZXh0ZW5zaW9uID0gcGF0aC5zcGxpdCgnLicpLnBvcCgpIHx8ICcnO1xyXG4gICAgICAgIGNvbnN0IGZpbGUgPSBuZXcgTW9ja1RGaWxlKHBhdGgsIGV4dGVuc2lvbikgYXMgYW55O1xyXG4gICAgICAgIHRoaXMudHJpZ2dlckV2ZW50KCdjcmVhdGUnLCBmaWxlKTtcclxuICAgICAgICByZXR1cm4gZmlsZTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBTaW11bGF0ZSBmaWxlIGRlbGV0aW9uXHJcbiAgICBkZWxldGVGaWxlKHBhdGg6IHN0cmluZyk6IHZvaWQge1xyXG4gICAgICAgIGNvbnN0IGV4dGVuc2lvbiA9IHBhdGguc3BsaXQoJy4nKS5wb3AoKSB8fCAnJztcclxuICAgICAgICBjb25zdCBmaWxlID0gbmV3IE1vY2tURmlsZShwYXRoLCBleHRlbnNpb24pIGFzIGFueTtcclxuICAgICAgICB0aGlzLmZpbGVzLmRlbGV0ZShwYXRoKTtcclxuICAgICAgICB0aGlzLnRyaWdnZXJFdmVudCgnZGVsZXRlJywgZmlsZSk7XHJcbiAgICB9XHJcbn1cclxuXHJcbmRlc2NyaWJlKCdDYW52YXMgRmlsZSBNb25pdG9yaW5nJywgKCkgPT4ge1xyXG4gICAgbGV0IG1vY2tWYXVsdDogTW9ja1ZhdWx0O1xyXG4gICAgbGV0IG1vZGlmeUV2ZW50VHJpZ2dlcmVkOiBib29sZWFuO1xyXG4gICAgbGV0IGNyZWF0ZUV2ZW50VHJpZ2dlcmVkOiBib29sZWFuO1xyXG4gICAgbGV0IGRlbGV0ZUV2ZW50VHJpZ2dlcmVkOiBib29sZWFuO1xyXG4gICAgbGV0IGxhc3RNb2RpZmllZEZpbGU6IFRGaWxlIHwgbnVsbDtcclxuXHJcbiAgICBiZWZvcmVFYWNoKCgpID0+IHtcclxuICAgICAgICBtb2NrVmF1bHQgPSBuZXcgTW9ja1ZhdWx0KCk7XHJcbiAgICAgICAgbW9kaWZ5RXZlbnRUcmlnZ2VyZWQgPSBmYWxzZTtcclxuICAgICAgICBjcmVhdGVFdmVudFRyaWdnZXJlZCA9IGZhbHNlO1xyXG4gICAgICAgIGRlbGV0ZUV2ZW50VHJpZ2dlcmVkID0gZmFsc2U7XHJcbiAgICAgICAgbGFzdE1vZGlmaWVkRmlsZSA9IG51bGw7XHJcblxyXG4gICAgICAgIC8vIFNldCB1cCBldmVudCBsaXN0ZW5lcnMgdG8gdHJhY2sgZXZlbnRzXHJcbiAgICAgICAgbW9ja1ZhdWx0Lm9uKCdtb2RpZnknLCAoZmlsZTogVEZpbGUpID0+IHtcclxuICAgICAgICAgICAgaWYgKGlzU3VwcG9ydGVkRmlsZShmaWxlKSkge1xyXG4gICAgICAgICAgICAgICAgbW9kaWZ5RXZlbnRUcmlnZ2VyZWQgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgbGFzdE1vZGlmaWVkRmlsZSA9IGZpbGU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgbW9ja1ZhdWx0Lm9uKCdjcmVhdGUnLCAoZmlsZTogVEZpbGUpID0+IHtcclxuICAgICAgICAgICAgaWYgKGlzU3VwcG9ydGVkRmlsZShmaWxlKSkge1xyXG4gICAgICAgICAgICAgICAgY3JlYXRlRXZlbnRUcmlnZ2VyZWQgPSB0cnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIG1vY2tWYXVsdC5vbignZGVsZXRlJywgKGZpbGU6IFRGaWxlKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChpc1N1cHBvcnRlZEZpbGUoZmlsZSkpIHtcclxuICAgICAgICAgICAgICAgIGRlbGV0ZUV2ZW50VHJpZ2dlcmVkID0gdHJ1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfSk7XHJcblxyXG4gICAgZGVzY3JpYmUoJ0ZpbGUgVHlwZSBEZXRlY3Rpb24gZm9yIE1vbml0b3JpbmcnLCAoKSA9PiB7XHJcbiAgICAgICAgaXQoJ3Nob3VsZCBjb3JyZWN0bHkgaWRlbnRpZnkgQ2FudmFzIGZpbGVzIGFzIHN1cHBvcnRlZCBmb3IgbW9uaXRvcmluZycsICgpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgY2FudmFzRmlsZSA9IG5ldyBNb2NrVEZpbGUoJ3Rlc3QuY2FudmFzJywgJ2NhbnZhcycpIGFzIGFueTtcclxuICAgICAgICAgICAgZXhwZWN0KGlzU3VwcG9ydGVkRmlsZShjYW52YXNGaWxlKSkudG9CZSh0cnVlKTtcclxuICAgICAgICAgICAgZXhwZWN0KGlzQ2FudmFzRmlsZShjYW52YXNGaWxlKSkudG9CZSh0cnVlKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgaXQoJ3Nob3VsZCBjb3JyZWN0bHkgaWRlbnRpZnkgbWFya2Rvd24gZmlsZXMgYXMgc3VwcG9ydGVkIGZvciBtb25pdG9yaW5nJywgKCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBtZEZpbGUgPSBuZXcgTW9ja1RGaWxlKCd0ZXN0Lm1kJywgJ21kJykgYXMgYW55O1xyXG4gICAgICAgICAgICBleHBlY3QoaXNTdXBwb3J0ZWRGaWxlKG1kRmlsZSkpLnRvQmUodHJ1ZSk7XHJcbiAgICAgICAgICAgIGV4cGVjdChpc0NhbnZhc0ZpbGUobWRGaWxlKSkudG9CZShmYWxzZSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGl0KCdzaG91bGQgcmVqZWN0IHVuc3VwcG9ydGVkIGZpbGUgdHlwZXMgZm9yIG1vbml0b3JpbmcnLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHR4dEZpbGUgPSBuZXcgTW9ja1RGaWxlKCd0ZXN0LnR4dCcsICd0eHQnKSBhcyBhbnk7XHJcbiAgICAgICAgICAgIGV4cGVjdChpc1N1cHBvcnRlZEZpbGUodHh0RmlsZSkpLnRvQmUoZmFsc2UpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfSk7XHJcblxyXG4gICAgZGVzY3JpYmUoJ0NhbnZhcyBGaWxlIE1vZGlmaWNhdGlvbiBFdmVudHMnLCAoKSA9PiB7XHJcbiAgICAgICAgaXQoJ3Nob3VsZCB0cmlnZ2VyIG1vZGlmeSBldmVudCB3aGVuIENhbnZhcyBmaWxlIGlzIGNoYW5nZWQnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgICAgICAgIC8vIENyZWF0ZSBhIENhbnZhcyBmaWxlXHJcbiAgICAgICAgICAgIGNvbnN0IGNhbnZhc0RhdGE6IENhbnZhc0RhdGEgPSB7XHJcbiAgICAgICAgICAgICAgICBub2RlczogW1xyXG4gICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWQ6ICd0ZXN0LW5vZGUnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAndGV4dCcsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRleHQ6ICcjIFRlc3RcXG5cXG4tIFsgXSBPcmlnaW5hbCB0YXNrJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgeDogMTAwLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB5OiAxMDAsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHdpZHRoOiAzMDAsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGhlaWdodDogMjAwXHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgXSxcclxuICAgICAgICAgICAgICAgIGVkZ2VzOiBbXVxyXG4gICAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAgICAgY29uc3QgY2FudmFzRmlsZSA9IG1vY2tWYXVsdC5jcmVhdGVGaWxlKCd0ZXN0LmNhbnZhcycsIEpTT04uc3RyaW5naWZ5KGNhbnZhc0RhdGEsIG51bGwsIDIpKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIC8vIFJlc2V0IGV2ZW50IGZsYWdzXHJcbiAgICAgICAgICAgIG1vZGlmeUV2ZW50VHJpZ2dlcmVkID0gZmFsc2U7XHJcbiAgICAgICAgICAgIGxhc3RNb2RpZmllZEZpbGUgPSBudWxsO1xyXG5cclxuICAgICAgICAgICAgLy8gTW9kaWZ5IHRoZSBDYW52YXMgZmlsZVxyXG4gICAgICAgICAgICBjb25zdCB1cGRhdGVkQ2FudmFzRGF0YSA9IHtcclxuICAgICAgICAgICAgICAgIC4uLmNhbnZhc0RhdGEsXHJcbiAgICAgICAgICAgICAgICBub2RlczogW1xyXG4gICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgLi4uY2FudmFzRGF0YS5ub2Rlc1swXSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGV4dDogJyMgVGVzdFxcblxcbi0gW3hdIE9yaWdpbmFsIHRhc2snXHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgXVxyXG4gICAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAgICAgYXdhaXQgbW9ja1ZhdWx0Lm1vZGlmeShjYW52YXNGaWxlLCBKU09OLnN0cmluZ2lmeSh1cGRhdGVkQ2FudmFzRGF0YSwgbnVsbCwgMikpO1xyXG5cclxuICAgICAgICAgICAgLy8gVmVyaWZ5IHRoYXQgdGhlIG1vZGlmeSBldmVudCB3YXMgdHJpZ2dlcmVkXHJcbiAgICAgICAgICAgIGV4cGVjdChtb2RpZnlFdmVudFRyaWdnZXJlZCkudG9CZSh0cnVlKTtcclxuICAgICAgICAgICAgZXhwZWN0KGxhc3RNb2RpZmllZEZpbGUpLnRvQmVUcnV0aHkoKTtcclxuICAgICAgICAgICAgZXhwZWN0KChsYXN0TW9kaWZpZWRGaWxlIGFzIGFueSkucGF0aCkudG9CZSgndGVzdC5jYW52YXMnKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgaXQoJ3Nob3VsZCB0cmlnZ2VyIGNyZWF0ZSBldmVudCB3aGVuIG5ldyBDYW52YXMgZmlsZSBpcyBjcmVhdGVkJywgKCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBjYW52YXNEYXRhOiBDYW52YXNEYXRhID0ge1xyXG4gICAgICAgICAgICAgICAgbm9kZXM6IFtcclxuICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlkOiAnbmV3LW5vZGUnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAndGV4dCcsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRleHQ6ICcjIE5ldyBDYW52YXNcXG5cXG4tIFsgXSBOZXcgdGFzaycsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHg6IDEwMCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgeTogMTAwLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB3aWR0aDogMzAwLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBoZWlnaHQ6IDIwMFxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIF0sXHJcbiAgICAgICAgICAgICAgICBlZGdlczogW11cclxuICAgICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgICAgIG1vY2tWYXVsdC5jcmVhdGVGaWxlKCduZXcuY2FudmFzJywgSlNPTi5zdHJpbmdpZnkoY2FudmFzRGF0YSwgbnVsbCwgMikpO1xyXG5cclxuICAgICAgICAgICAgZXhwZWN0KGNyZWF0ZUV2ZW50VHJpZ2dlcmVkKS50b0JlKHRydWUpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBpdCgnc2hvdWxkIHRyaWdnZXIgZGVsZXRlIGV2ZW50IHdoZW4gQ2FudmFzIGZpbGUgaXMgZGVsZXRlZCcsICgpID0+IHtcclxuICAgICAgICAgICAgLy8gRmlyc3QgY3JlYXRlIGEgQ2FudmFzIGZpbGVcclxuICAgICAgICAgICAgY29uc3QgY2FudmFzRGF0YTogQ2FudmFzRGF0YSA9IHtcclxuICAgICAgICAgICAgICAgIG5vZGVzOiBbXHJcbiAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZDogJ2RlbGV0ZS1ub2RlJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogJ3RleHQnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0ZXh0OiAnIyBUbyBEZWxldGVcXG5cXG4tIFsgXSBUYXNrIHRvIGRlbGV0ZScsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHg6IDEwMCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgeTogMTAwLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB3aWR0aDogMzAwLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBoZWlnaHQ6IDIwMFxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIF0sXHJcbiAgICAgICAgICAgICAgICBlZGdlczogW11cclxuICAgICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgICAgIG1vY2tWYXVsdC5jcmVhdGVGaWxlKCdkZWxldGUuY2FudmFzJywgSlNPTi5zdHJpbmdpZnkoY2FudmFzRGF0YSwgbnVsbCwgMikpO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgLy8gUmVzZXQgZXZlbnQgZmxhZ3NcclxuICAgICAgICAgICAgZGVsZXRlRXZlbnRUcmlnZ2VyZWQgPSBmYWxzZTtcclxuXHJcbiAgICAgICAgICAgIC8vIERlbGV0ZSB0aGUgZmlsZVxyXG4gICAgICAgICAgICBtb2NrVmF1bHQuZGVsZXRlRmlsZSgnZGVsZXRlLmNhbnZhcycpO1xyXG5cclxuICAgICAgICAgICAgZXhwZWN0KGRlbGV0ZUV2ZW50VHJpZ2dlcmVkKS50b0JlKHRydWUpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfSk7XHJcblxyXG4gICAgZGVzY3JpYmUoJ01peGVkIEZpbGUgVHlwZSBNb25pdG9yaW5nJywgKCkgPT4ge1xyXG4gICAgICAgIGl0KCdzaG91bGQgaGFuZGxlIGJvdGggQ2FudmFzIGFuZCBNYXJrZG93biBmaWxlcyBpbiBtb25pdG9yaW5nJywgKCkgPT4ge1xyXG4gICAgICAgICAgICBsZXQgY2FudmFzRXZlbnRUcmlnZ2VyZWQgPSBmYWxzZTtcclxuICAgICAgICAgICAgbGV0IG1hcmtkb3duRXZlbnRUcmlnZ2VyZWQgPSBmYWxzZTtcclxuXHJcbiAgICAgICAgICAgIC8vIFNldCB1cCBzcGVjaWZpYyBsaXN0ZW5lcnMgZm9yIGRpZmZlcmVudCBmaWxlIHR5cGVzXHJcbiAgICAgICAgICAgIG1vY2tWYXVsdC5vbignbW9kaWZ5JywgKGZpbGU6IFRGaWxlKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoaXNDYW52YXNGaWxlKGZpbGUpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FudmFzRXZlbnRUcmlnZ2VyZWQgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChmaWxlLmV4dGVuc2lvbiA9PT0gJ21kJykge1xyXG4gICAgICAgICAgICAgICAgICAgIG1hcmtkb3duRXZlbnRUcmlnZ2VyZWQgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIC8vIENyZWF0ZSBhbmQgbW9kaWZ5IENhbnZhcyBmaWxlXHJcbiAgICAgICAgICAgIGNvbnN0IGNhbnZhc0ZpbGUgPSBtb2NrVmF1bHQuY3JlYXRlRmlsZSgnbWl4ZWQuY2FudmFzJywgSlNPTi5zdHJpbmdpZnkoe1xyXG4gICAgICAgICAgICAgICAgbm9kZXM6IFt7IGlkOiAndGVzdCcsIHR5cGU6ICd0ZXh0JywgdGV4dDogJy0gWyBdIENhbnZhcyB0YXNrJywgeDogMCwgeTogMCwgd2lkdGg6IDEwMCwgaGVpZ2h0OiAxMDAgfV0sXHJcbiAgICAgICAgICAgICAgICBlZGdlczogW11cclxuICAgICAgICAgICAgfSwgbnVsbCwgMikpO1xyXG5cclxuICAgICAgICAgICAgLy8gQ3JlYXRlIGFuZCBtb2RpZnkgTWFya2Rvd24gZmlsZVxyXG4gICAgICAgICAgICBjb25zdCBtZEZpbGUgPSBtb2NrVmF1bHQuY3JlYXRlRmlsZSgnbWl4ZWQubWQnLCAnIyBUZXN0XFxuXFxuLSBbIF0gTWFya2Rvd24gdGFzaycpO1xyXG5cclxuICAgICAgICAgICAgLy8gUmVzZXQgZmxhZ3NcclxuICAgICAgICAgICAgY2FudmFzRXZlbnRUcmlnZ2VyZWQgPSBmYWxzZTtcclxuICAgICAgICAgICAgbWFya2Rvd25FdmVudFRyaWdnZXJlZCA9IGZhbHNlO1xyXG5cclxuICAgICAgICAgICAgLy8gTW9kaWZ5IGJvdGggZmlsZXNcclxuICAgICAgICAgICAgbW9ja1ZhdWx0Lm1vZGlmeShjYW52YXNGaWxlLCBKU09OLnN0cmluZ2lmeSh7XHJcbiAgICAgICAgICAgICAgICBub2RlczogW3sgaWQ6ICd0ZXN0JywgdHlwZTogJ3RleHQnLCB0ZXh0OiAnLSBbeF0gQ2FudmFzIHRhc2snLCB4OiAwLCB5OiAwLCB3aWR0aDogMTAwLCBoZWlnaHQ6IDEwMCB9XSxcclxuICAgICAgICAgICAgICAgIGVkZ2VzOiBbXVxyXG4gICAgICAgICAgICB9LCBudWxsLCAyKSk7XHJcblxyXG4gICAgICAgICAgICBtb2NrVmF1bHQubW9kaWZ5KG1kRmlsZSwgJyMgVGVzdFxcblxcbi0gW3hdIE1hcmtkb3duIHRhc2snKTtcclxuXHJcbiAgICAgICAgICAgIGV4cGVjdChjYW52YXNFdmVudFRyaWdnZXJlZCkudG9CZSh0cnVlKTtcclxuICAgICAgICAgICAgZXhwZWN0KG1hcmtkb3duRXZlbnRUcmlnZ2VyZWQpLnRvQmUodHJ1ZSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9KTtcclxufSk7XHJcbiJdfQ==