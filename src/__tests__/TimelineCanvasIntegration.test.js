/**
 * Timeline Canvas Integration Tests
 *
 * Tests to verify that Canvas task completion works correctly in the Timeline feature
 */
import { __awaiter } from "tslib";
import { CanvasTaskUpdater } from "../parsers/canvas-task-updater";
// Mock Vault and TFile (same as CanvasTaskUpdater.test.ts)
class MockVault {
    constructor() {
        this.files = new Map();
    }
    getFileByPath(path) {
        if (this.files.has(path)) {
            return new MockTFile(path);
        }
        return null;
    }
    read(file) {
        return __awaiter(this, void 0, void 0, function* () {
            return this.files.get(file.path) || '';
        });
    }
    modify(file, content) {
        return __awaiter(this, void 0, void 0, function* () {
            this.files.set(file.path, content);
        });
    }
    setFileContent(path, content) {
        this.files.set(path, content);
    }
    getFileContent(path) {
        return this.files.get(path);
    }
    createFile(path, content) {
        this.files.set(path, content);
        return new MockTFile(path);
    }
}
class MockTFile {
    constructor(path) {
        this.path = path;
    }
    get name() {
        return this.path.split('/').pop() || '';
    }
    get extension() {
        return this.path.split('.').pop() || '';
    }
}
// Mock Plugin (same as CanvasTaskUpdater.test.ts)
class MockPlugin {
    constructor() {
        this.settings = {
            preferMetadataFormat: 'tasks',
            projectTagPrefix: {
                tasks: 'project',
                dataview: 'project'
            },
            contextTagPrefix: {
                tasks: '@',
                dataview: 'context'
            }
        };
    }
}
describe('Timeline Canvas Integration', () => {
    let mockPlugin;
    let mockVault;
    let canvasTaskUpdater;
    beforeEach(() => {
        mockPlugin = new MockPlugin();
        mockVault = new MockVault();
        // Initialize CanvasTaskUpdater
        canvasTaskUpdater = new CanvasTaskUpdater(mockVault, mockPlugin);
    });
    describe('Canvas Task Identification', () => {
        it('should correctly identify Canvas tasks', () => {
            const canvasTask = {
                id: 'canvas-task-1',
                content: 'Canvas task',
                filePath: 'test.canvas',
                line: 0,
                completed: false,
                status: ' ',
                originalMarkdown: '- [ ] Canvas task',
                metadata: {
                    sourceType: 'canvas',
                    canvasNodeId: 'node-1',
                    tags: [],
                    children: []
                }
            };
            const markdownTask = {
                id: 'markdown-task-1',
                content: 'Markdown task',
                filePath: 'test.md',
                line: 0,
                completed: false,
                status: ' ',
                originalMarkdown: '- [ ] Markdown task',
                metadata: {
                    tags: [],
                    children: []
                }
            };
            expect(CanvasTaskUpdater.isCanvasTask(canvasTask)).toBe(true);
            expect(CanvasTaskUpdater.isCanvasTask(markdownTask)).toBe(false);
        });
    });
    describe('Canvas Task Completion in Timeline', () => {
        it('should successfully complete Canvas tasks through TaskManager', () => __awaiter(void 0, void 0, void 0, function* () {
            // Create a Canvas file with a task
            const canvasData = {
                nodes: [
                    {
                        id: 'test-node',
                        type: 'text',
                        text: '# Test Canvas\n\n- [ ] Test Canvas task',
                        x: 100,
                        y: 100,
                        width: 300,
                        height: 200
                    }
                ],
                edges: []
            };
            const canvasFile = mockVault.createFile('test.canvas', JSON.stringify(canvasData, null, 2));
            // Create a Canvas task
            const originalTask = {
                id: 'test-canvas-task',
                content: 'Test Canvas task',
                filePath: 'test.canvas',
                line: 0,
                completed: false,
                status: ' ',
                originalMarkdown: '- [ ] Test Canvas task',
                metadata: {
                    sourceType: 'canvas',
                    canvasNodeId: 'test-node',
                    tags: [],
                    children: []
                }
            };
            // Create updated task (completed)
            const updatedTask = Object.assign(Object.assign({}, originalTask), { completed: true, status: 'x', metadata: Object.assign(Object.assign({}, originalTask.metadata), { completedDate: Date.now() }) });
            // Test Canvas task update directly
            const result = yield canvasTaskUpdater.updateCanvasTask(originalTask, updatedTask);
            expect(result.success).toBe(true);
            // Verify the Canvas file was updated
            const updatedContent = mockVault.getFileContent('test.canvas');
            expect(updatedContent).toBeDefined();
            const updatedCanvasData = JSON.parse(updatedContent);
            const updatedNode = updatedCanvasData.nodes.find((n) => n.id === 'test-node');
            expect(updatedNode.text).toContain('- [x] Test Canvas task');
        }));
        it('should handle Canvas task completion through Timeline toggleTaskCompletion flow', () => __awaiter(void 0, void 0, void 0, function* () {
            // This test simulates the Timeline's task completion flow
            const canvasData = {
                nodes: [
                    {
                        id: 'timeline-test-node',
                        type: 'text',
                        text: '# Timeline Test\n\n- [ ] Timeline Canvas task üìÖ 2025-01-15',
                        x: 100,
                        y: 100,
                        width: 300,
                        height: 200
                    }
                ],
                edges: []
            };
            mockVault.createFile('timeline-test.canvas', JSON.stringify(canvasData, null, 2));
            const canvasTask = {
                id: 'timeline-canvas-task',
                content: 'Timeline Canvas task',
                filePath: 'timeline-test.canvas',
                line: 0,
                completed: false,
                status: ' ',
                originalMarkdown: '- [ ] Timeline Canvas task üìÖ 2025-01-15',
                metadata: {
                    sourceType: 'canvas',
                    canvasNodeId: 'timeline-test-node',
                    dueDate: new Date('2025-01-15').getTime(),
                    tags: [],
                    children: []
                }
            };
            // Simulate the Timeline's toggleTaskCompletion logic
            const updatedTask = Object.assign(Object.assign({}, canvasTask), { completed: !canvasTask.completed });
            if (updatedTask.completed) {
                updatedTask.metadata.completedDate = Date.now();
                updatedTask.status = 'x';
            }
            // Test that CanvasTaskUpdater.isCanvasTask correctly identifies this task
            expect(CanvasTaskUpdater.isCanvasTask(canvasTask)).toBe(true);
            // Test the Canvas task update
            const result = yield canvasTaskUpdater.updateCanvasTask(canvasTask, updatedTask);
            if (!result.success) {
                console.log('Canvas task update failed:', result.error);
            }
            expect(result.success).toBe(true);
            // Verify the Canvas file was updated correctly
            const updatedContent = mockVault.getFileContent('timeline-test.canvas');
            const updatedCanvasData = JSON.parse(updatedContent);
            const updatedNode = updatedCanvasData.nodes.find((n) => n.id === 'timeline-test-node');
            expect(updatedNode.text).toContain('- [x] Timeline Canvas task');
            expect(updatedNode.text).toContain('üìÖ 2025-01-15');
            // Should also contain completion date
            const today = new Date();
            const expectedDate = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            expect(updatedNode.text).toContain(`‚úÖ ${expectedDate}`);
        }));
        it('should handle Canvas task completion with originalMarkdown matching', () => __awaiter(void 0, void 0, void 0, function* () {
            // Test the improved originalMarkdown matching logic
            const canvasData = {
                nodes: [
                    {
                        id: 'matching-test-node',
                        type: 'text',
                        text: '# Matching Test\n\n- [ ] Task with complex metadata #project/test @home ‚è´ üìÖ 2025-01-20',
                        x: 100,
                        y: 100,
                        width: 400,
                        height: 250
                    }
                ],
                edges: []
            };
            mockVault.createFile('matching-test.canvas', JSON.stringify(canvasData, null, 2));
            const complexTask = {
                id: 'complex-canvas-task',
                content: 'Task with complex metadata',
                filePath: 'matching-test.canvas',
                line: 0,
                completed: false,
                status: ' ',
                originalMarkdown: '- [ ] Task with complex metadata #project/test @home ‚è´ üìÖ 2025-01-20',
                metadata: {
                    sourceType: 'canvas',
                    canvasNodeId: 'matching-test-node',
                    dueDate: new Date('2025-01-20').getTime(),
                    priority: 4,
                    project: 'test',
                    context: 'home',
                    tags: ['#project/test'],
                    children: []
                }
            };
            // Complete the task
            const completedTask = Object.assign(Object.assign({}, complexTask), { completed: true, status: 'x', metadata: Object.assign(Object.assign({}, complexTask.metadata), { completedDate: Date.now() }) });
            const result = yield canvasTaskUpdater.updateCanvasTask(complexTask, completedTask);
            expect(result.success).toBe(true);
            // Verify the task was found and updated correctly
            const updatedContent = mockVault.getFileContent('matching-test.canvas');
            const updatedCanvasData = JSON.parse(updatedContent);
            const updatedNode = updatedCanvasData.nodes.find((n) => n.id === 'matching-test-node');
            expect(updatedNode.text).toContain('- [x] Task with complex metadata');
            expect(updatedNode.text).toContain('#project/test');
            expect(updatedNode.text).toContain('@home');
            expect(updatedNode.text).toContain('‚è´');
            expect(updatedNode.text).toContain('üìÖ 2025-01-20');
            // Should contain completion date
            const today = new Date();
            const expectedDate = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            expect(updatedNode.text).toContain(`‚úÖ ${expectedDate}`);
        }));
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVGltZWxpbmVDYW52YXNJbnRlZ3JhdGlvbi50ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiVGltZWxpbmVDYW52YXNJbnRlZ3JhdGlvbi50ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7O0dBSUc7O0FBR0gsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sZ0NBQWdDLENBQUM7QUFHbkUsMkRBQTJEO0FBQzNELE1BQU0sU0FBUztJQUFmO1FBQ1ksVUFBSyxHQUF3QixJQUFJLEdBQUcsRUFBRSxDQUFDO0lBNkJuRCxDQUFDO0lBM0JHLGFBQWEsQ0FBQyxJQUFZO1FBQ3RCLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUU7WUFDdEIsT0FBTyxJQUFJLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUM5QjtRQUNELE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7SUFFSyxJQUFJLENBQUMsSUFBZTs7WUFDdEIsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO1FBQzNDLENBQUM7S0FBQTtJQUVLLE1BQU0sQ0FBQyxJQUFlLEVBQUUsT0FBZTs7WUFDekMsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxPQUFPLENBQUMsQ0FBQztRQUN2QyxDQUFDO0tBQUE7SUFFRCxjQUFjLENBQUMsSUFBWSxFQUFFLE9BQWU7UUFDeEMsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQ2xDLENBQUM7SUFFRCxjQUFjLENBQUMsSUFBWTtRQUN2QixPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ2hDLENBQUM7SUFFRCxVQUFVLENBQUMsSUFBWSxFQUFFLE9BQWU7UUFDcEMsSUFBSSxD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RUFBRSxHQUFHLENBQUMsRUFBRSxDQUFDO1lBQzNJLE1BQU0sQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUMsU0FBUyxDQUFDLEtBQUssWUFBWSxFQUFFLENBQUMsQ0FBQztRQUM1RCxDQUFDLENBQUEsQ0FBQyxDQUFDO0lBQ1AsQ0FBQyxDQUFDLENBQUM7QUFDUCxDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiBUaW1lbGluZSBDYW52YXMgSW50ZWdyYXRpb24gVGVzdHNcclxuICpcclxuICogVGVzdHMgdG8gdmVyaWZ5IHRoYXQgQ2FudmFzIHRhc2sgY29tcGxldGlvbiB3b3JrcyBjb3JyZWN0bHkgaW4gdGhlIFRpbWVsaW5lIGZlYXR1cmVcclxuICovXHJcblxyXG5pbXBvcnQgeyBUYXNrLCBDYW52YXNUYXNrTWV0YWRhdGEgfSBmcm9tIFwiLi4vdHlwZXMvdGFza1wiO1xyXG5pbXBvcnQgeyBDYW52YXNUYXNrVXBkYXRlciB9IGZyb20gXCIuLi9wYXJzZXJzL2NhbnZhcy10YXNrLXVwZGF0ZXJcIjtcclxuaW1wb3J0IHsgQ2FudmFzRGF0YSB9IGZyb20gXCIuLi90eXBlcy9jYW52YXNcIjtcclxuXHJcbi8vIE1vY2sgVmF1bHQgYW5kIFRGaWxlIChzYW1lIGFzIENhbnZhc1Rhc2tVcGRhdGVyLnRlc3QudHMpXHJcbmNsYXNzIE1vY2tWYXVsdCB7XHJcbiAgICBwcml2YXRlIGZpbGVzOiBNYXA8c3RyaW5nLCBzdHJpbmc+ID0gbmV3IE1hcCgpO1xyXG5cclxuICAgIGdldEZpbGVCeVBhdGgocGF0aDogc3RyaW5nKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuZmlsZXMuaGFzKHBhdGgpKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBuZXcgTW9ja1RGaWxlKHBhdGgpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuXHJcbiAgICBhc3luYyByZWFkKGZpbGU6IE1vY2tURmlsZSk6IFByb21pc2U8c3RyaW5nPiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZmlsZXMuZ2V0KGZpbGUucGF0aCkgfHwgJyc7XHJcbiAgICB9XHJcblxyXG4gICAgYXN5bmMgbW9kaWZ5KGZpbGU6IE1vY2tURmlsZSwgY29udGVudDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICAgICAgdGhpcy5maWxlcy5zZXQoZmlsZS5wYXRoLCBjb250ZW50KTtcclxuICAgIH1cclxuXHJcbiAgICBzZXRGaWxlQ29udGVudChwYXRoOiBzdHJpbmcsIGNvbnRlbnQ6IHN0cmluZyk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMuZmlsZXMuc2V0KHBhdGgsIGNvbnRlbnQpO1xyXG4gICAgfVxyXG5cclxuICAgIGdldEZpbGVDb250ZW50KHBhdGg6IHN0cmluZyk6IHN0cmluZyB8IHVuZGVmaW5lZCB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZmlsZXMuZ2V0KHBhdGgpO1xyXG4gICAgfVxyXG5cclxuICAgIGNyZWF0ZUZpbGUocGF0aDogc3RyaW5nLCBjb250ZW50OiBzdHJpbmcpOiBNb2NrVEZpbGUge1xyXG4gICAgICAgIHRoaXMuZmlsZXMuc2V0KHBhdGgsIGNvbnRlbnQpO1xyXG4gICAgICAgIHJldHVybiBuZXcgTW9ja1RGaWxlKHBhdGgpO1xyXG4gICAgfVxyXG59XHJcblxyXG5jbGFzcyBNb2NrVEZpbGUge1xyXG4gICAgY29uc3RydWN0b3IocHVibGljIHBhdGg6IHN0cmluZykge31cclxuXHJcbiAgICBnZXQgbmFtZSgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5wYXRoLnNwbGl0KCcvJykucG9wKCkgfHwgJyc7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IGV4dGVuc2lvbigpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5wYXRoLnNwbGl0KCcuJykucG9wKCkgfHwgJyc7XHJcbiAgICB9XHJcbn1cclxuXHJcbi8vIE1vY2sgUGx1Z2luIChzYW1lIGFzIENhbnZhc1Rhc2tVcGRhdGVyLnRlc3QudHMpXHJcbmNsYXNzIE1vY2tQbHVnaW4ge1xyXG4gICAgc2V0dGluZ3MgPSB7XHJcbiAgICAgICAgcHJlZmVyTWV0YWRhdGFGb3JtYXQ6ICd0YXNrcycgYXMgY29uc3QsXHJcbiAgICAgICAgcHJvamVjdFRhZ1ByZWZpeDoge1xyXG4gICAgICAgICAgICB0YXNrczogJ3Byb2plY3QnLFxyXG4gICAgICAgICAgICBkYXRhdmlldzogJ3Byb2plY3QnXHJcbiAgICAgICAgfSxcclxuICAgICAgICBjb250ZXh0VGFnUHJlZml4OiB7XHJcbiAgICAgICAgICAgIHRhc2tzOiAnQCcsXHJcbiAgICAgICAgICAgIGRhdGF2aWV3OiAnY29udGV4dCdcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG59XHJcblxyXG5kZXNjcmliZSgnVGltZWxpbmUgQ2FudmFzIEludGVncmF0aW9uJywgKCkgPT4ge1xyXG4gICAgbGV0IG1vY2tQbHVnaW46IE1vY2tQbHVnaW47XHJcbiAgICBsZXQgbW9ja1ZhdWx0OiBNb2NrVmF1bHQ7XHJcbiAgICBsZXQgY2FudmFzVGFza1VwZGF0ZXI6IENhbnZhc1Rhc2tVcGRhdGVyO1xyXG5cclxuICAgIGJlZm9yZUVhY2goKCkgPT4ge1xyXG4gICAgICAgIG1vY2tQbHVnaW4gPSBuZXcgTW9ja1BsdWdpbigpO1xyXG4gICAgICAgIG1vY2tWYXVsdCA9IG5ldyBNb2NrVmF1bHQoKTtcclxuXHJcbiAgICAgICAgLy8gSW5pdGlhbGl6ZSBDYW52YXNUYXNrVXBkYXRlclxyXG4gICAgICAgIGNhbnZhc1Rhc2tVcGRhdGVyID0gbmV3IENhbnZhc1Rhc2tVcGRhdGVyKG1vY2tWYXVsdCBhcyBhbnksIG1vY2tQbHVnaW4gYXMgYW55KTtcclxuICAgIH0pO1xyXG5cclxuICAgIGRlc2NyaWJlKCdDYW52YXMgVGFzayBJZGVudGlmaWNhdGlvbicsICgpID0+IHtcclxuICAgICAgICBpdCgnc2hvdWxkIGNvcnJlY3RseSBpZGVudGlmeSBDYW52YXMgdGFza3MnLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGNhbnZhc1Rhc2s6IFRhc2s8Q2FudmFzVGFza01ldGFkYXRhPiA9IHtcclxuICAgICAgICAgICAgICAgIGlkOiAnY2FudmFzLXRhc2stMScsXHJcbiAgICAgICAgICAgICAgICBjb250ZW50OiAnQ2FudmFzIHRhc2snLFxyXG4gICAgICAgICAgICAgICAgZmlsZVBhdGg6ICd0ZXN0LmNhbnZhcycsXHJcbiAgICAgICAgICAgICAgICBsaW5lOiAwLFxyXG4gICAgICAgICAgICAgICAgY29tcGxldGVkOiBmYWxzZSxcclxuICAgICAgICAgICAgICAgIHN0YXR1czogJyAnLFxyXG4gICAgICAgICAgICAgICAgb3JpZ2luYWxNYXJrZG93bjogJy0gWyBdIENhbnZhcyB0YXNrJyxcclxuICAgICAgICAgICAgICAgIG1ldGFkYXRhOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgc291cmNlVHlwZTogJ2NhbnZhcycsXHJcbiAgICAgICAgICAgICAgICAgICAgY2FudmFzTm9kZUlkOiAnbm9kZS0xJyxcclxuICAgICAgICAgICAgICAgICAgICB0YWdzOiBbXSxcclxuICAgICAgICAgICAgICAgICAgICBjaGlsZHJlbjogW11cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IG1hcmtkb3duVGFzazogVGFzayA9IHtcclxuICAgICAgICAgICAgICAgIGlkOiAnbWFya2Rvd24tdGFzay0xJyxcclxuICAgICAgICAgICAgICAgIGNvbnRlbnQ6ICdNYXJrZG93biB0YXNrJyxcclxuICAgICAgICAgICAgICAgIGZpbGVQYXRoOiAndGVzdC5tZCcsXHJcbiAgICAgICAgICAgICAgICBsaW5lOiAwLFxyXG4gICAgICAgICAgICAgICAgY29tcGxldGVkOiBmYWxzZSxcclxuICAgICAgICAgICAgICAgIHN0YXR1czogJyAnLFxyXG4gICAgICAgICAgICAgICAgb3JpZ2luYWxNYXJrZG93bjogJy0gWyBdIE1hcmtkb3duIHRhc2snLFxyXG4gICAgICAgICAgICAgICAgbWV0YWRhdGE6IHtcclxuICAgICAgICAgICAgICAgICAgICB0YWdzOiBbXSxcclxuICAgICAgICAgICAgICAgICAgICBjaGlsZHJlbjogW11cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgICAgIGV4cGVjdChDYW52YXNUYXNrVXBkYXRlci5pc0NhbnZhc1Rhc2soY2FudmFzVGFzaykpLnRvQmUodHJ1ZSk7XHJcbiAgICAgICAgICAgIGV4cGVjdChDYW52YXNUYXNrVXBkYXRlci5pc0NhbnZhc1Rhc2sobWFya2Rvd25UYXNrKSkudG9CZShmYWxzZSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBkZXNjcmliZSgnQ2FudmFzIFRhc2sgQ29tcGxldGlvbiBpbiBUaW1lbGluZScsICgpID0+IHtcclxuICAgICAgICBpdCgnc2hvdWxkIHN1Y2Nlc3NmdWxseSBjb21wbGV0ZSBDYW52YXMgdGFza3MgdGhyb3VnaCBUYXNrTWFuYWdlcicsIGFzeW5jICgpID0+IHtcclxuICAgICAgICAgICAgLy8gQ3JlYXRlIGEgQ2FudmFzIGZpbGUgd2l0aCBhIHRhc2tcclxuICAgICAgICAgICAgY29uc3QgY2FudmFzRGF0YTogQ2FudmFzRGF0YSA9IHtcclxuICAgICAgICAgICAgICAgIG5vZGVzOiBbXHJcbiAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZDogJ3Rlc3Qtbm9kZScsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICd0ZXh0JyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGV4dDogJyMgVGVzdCBDYW52YXNcXG5cXG4tIFsgXSBUZXN0IENhbnZhcyB0YXNrJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgeDogMTAwLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB5OiAxMDAsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHdpZHRoOiAzMDAsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGhlaWdodDogMjAwXHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgXSxcclxuICAgICAgICAgICAgICAgIGVkZ2VzOiBbXVxyXG4gICAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAgICAgY29uc3QgY2FudmFzRmlsZSA9IG1vY2tWYXVsdC5jcmVhdGVGaWxlKCd0ZXN0LmNhbnZhcycsIEpTT04uc3RyaW5naWZ5KGNhbnZhc0RhdGEsIG51bGwsIDIpKTtcclxuXHJcbiAgICAgICAgICAgIC8vIENyZWF0ZSBhIENhbnZhcyB0YXNrXHJcbiAgICAgICAgICAgIGNvbnN0IG9yaWdpbmFsVGFzazogVGFzazxDYW52YXNUYXNrTWV0YWRhdGE+ID0ge1xyXG4gICAgICAgICAgICAgICAgaWQ6ICd0ZXN0LWNhbnZhcy10YXNrJyxcclxuICAgICAgICAgICAgICAgIGNvbnRlbnQ6ICdUZXN0IENhbnZhcyB0YXNrJyxcclxuICAgICAgICAgICAgICAgIGZpbGVQYXRoOiAndGVzdC5jYW52YXMnLFxyXG4gICAgICAgICAgICAgICAgbGluZTogMCxcclxuICAgICAgICAgICAgICAgIGNvbXBsZXRlZDogZmFsc2UsXHJcbiAgICAgICAgICAgICAgICBzdGF0dXM6ICcgJyxcclxuICAgICAgICAgICAgICAgIG9yaWdpbmFsTWFya2Rvd246ICctIFsgXSBUZXN0IENhbnZhcyB0YXNrJyxcclxuICAgICAgICAgICAgICAgIG1ldGFkYXRhOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgc291cmNlVHlwZTogJ2NhbnZhcycsXHJcbiAgICAgICAgICAgICAgICAgICAgY2FudmFzTm9kZUlkOiAndGVzdC1ub2RlJyxcclxuICAgICAgICAgICAgICAgICAgICB0YWdzOiBbXSxcclxuICAgICAgICAgICAgICAgICAgICBjaGlsZHJlbjogW11cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgICAgIC8vIENyZWF0ZSB1cGRhdGVkIHRhc2sgKGNvbXBsZXRlZClcclxuICAgICAgICAgICAgY29uc3QgdXBkYXRlZFRhc2s6IFRhc2s8Q2FudmFzVGFza01ldGFkYXRhPiA9IHtcclxuICAgICAgICAgICAgICAgIC4uLm9yaWdpbmFsVGFzayxcclxuICAgICAgICAgICAgICAgIGNvbXBsZXRlZDogdHJ1ZSxcclxuICAgICAgICAgICAgICAgIHN0YXR1czogJ3gnLFxyXG4gICAgICAgICAgICAgICAgbWV0YWRhdGE6IHtcclxuICAgICAgICAgICAgICAgICAgICAuLi5vcmlnaW5hbFRhc2subWV0YWRhdGEsXHJcbiAgICAgICAgICAgICAgICAgICAgY29tcGxldGVkRGF0ZTogRGF0ZS5ub3coKVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAgICAgLy8gVGVzdCBDYW52YXMgdGFzayB1cGRhdGUgZGlyZWN0bHlcclxuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgY2FudmFzVGFza1VwZGF0ZXIudXBkYXRlQ2FudmFzVGFzayhvcmlnaW5hbFRhc2ssIHVwZGF0ZWRUYXNrKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIGV4cGVjdChyZXN1bHQuc3VjY2VzcykudG9CZSh0cnVlKTtcclxuXHJcbiAgICAgICAgICAgIC8vIFZlcmlmeSB0aGUgQ2FudmFzIGZpbGUgd2FzIHVwZGF0ZWRcclxuICAgICAgICAgICAgY29uc3QgdXBkYXRlZENvbnRlbnQgPSBtb2NrVmF1bHQuZ2V0RmlsZUNvbnRlbnQoJ3Rlc3QuY2FudmFzJyk7XHJcbiAgICAgICAgICAgIGV4cGVjdCh1cGRhdGVkQ29udGVudCkudG9CZURlZmluZWQoKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIGNvbnN0IHVwZGF0ZWRDYW52YXNEYXRhID0gSlNPTi5wYXJzZSh1cGRhdGVkQ29udGVudCEpO1xyXG4gICAgICAgICAgICBjb25zdCB1cGRhdGVkTm9kZSA9IHVwZGF0ZWRDYW52YXNEYXRhLm5vZGVzLmZpbmQoKG46IGFueSkgPT4gbi5pZCA9PT0gJ3Rlc3Qtbm9kZScpO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgZXhwZWN0KHVwZGF0ZWROb2RlLnRleHQpLnRvQ29udGFpbignLSBbeF0gVGVzdCBDYW52YXMgdGFzaycpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBpdCgnc2hvdWxkIGhhbmRsZSBDYW52YXMgdGFzayBjb21wbGV0aW9uIHRocm91Z2ggVGltZWxpbmUgdG9nZ2xlVGFza0NvbXBsZXRpb24gZmxvdycsIGFzeW5jICgpID0+IHtcclxuICAgICAgICAgICAgLy8gVGhpcyB0ZXN0IHNpbXVsYXRlcyB0aGUgVGltZWxpbmUncyB0YXNrIGNvbXBsZXRpb24gZmxvd1xyXG4gICAgICAgICAgICBjb25zdCBjYW52YXNEYXRhOiBDYW52YXNEYXRhID0ge1xyXG4gICAgICAgICAgICAgICAgbm9kZXM6IFtcclxuICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlkOiAndGltZWxpbmUtdGVzdC1ub2RlJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogJ3RleHQnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0ZXh0OiAnIyBUaW1lbGluZSBUZXN0XFxuXFxuLSBbIF0gVGltZWxpbmUgQ2FudmFzIHRhc2sg8J+ThSAyMDI1LTAxLTE1JyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgeDogMTAwLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB5OiAxMDAsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHdpZHRoOiAzMDAsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGhlaWdodDogMjAwXHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgXSxcclxuICAgICAgICAgICAgICAgIGVkZ2VzOiBbXVxyXG4gICAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAgICAgbW9ja1ZhdWx0LmNyZWF0ZUZpbGUoJ3RpbWVsaW5lLXRlc3QuY2FudmFzJywgSlNPTi5zdHJpbmdpZnkoY2FudmFzRGF0YSwgbnVsbCwgMikpO1xyXG5cclxuICAgICAgICAgICAgY29uc3QgY2FudmFzVGFzazogVGFzazxDYW52YXNUYXNrTWV0YWRhdGE+ID0ge1xyXG4gICAgICAgICAgICAgICAgaWQ6ICd0aW1lbGluZS1jYW52YXMtdGFzaycsXHJcbiAgICAgICAgICAgICAgICBjb250ZW50OiAnVGltZWxpbmUgQ2FudmFzIHRhc2snLCAgLy8gQ29udGVudCBzaG91bGQgYmUgY2xlYW4gdGFzayB0ZXh0XHJcbiAgICAgICAgICAgICAgICBmaWxlUGF0aDogJ3RpbWVsaW5lLXRlc3QuY2FudmFzJyxcclxuICAgICAgICAgICAgICAgIGxpbmU6IDAsXHJcbiAgICAgICAgICAgICAgICBjb21wbGV0ZWQ6IGZhbHNlLFxyXG4gICAgICAgICAgICAgICAgc3RhdHVzOiAnICcsXHJcbiAgICAgICAgICAgICAgICBvcmlnaW5hbE1hcmtkb3duOiAnLSBbIF0gVGltZWxpbmUgQ2FudmFzIHRhc2sg8J+ThSAyMDI1LTAxLTE1JywgIC8vIFRoaXMgc2hvdWxkIG1hdGNoIHRoZSBDYW52YXMgZmlsZSBleGFjdGx5XHJcbiAgICAgICAgICAgICAgICBtZXRhZGF0YToge1xyXG4gICAgICAgICAgICAgICAgICAgIHNvdXJjZVR5cGU6ICdjYW52YXMnLFxyXG4gICAgICAgICAgICAgICAgICAgIGNhbnZhc05vZGVJZDogJ3RpbWVsaW5lLXRlc3Qtbm9kZScsXHJcbiAgICAgICAgICAgICAgICAgICAgZHVlRGF0ZTogbmV3IERhdGUoJzIwMjUtMDEtMTUnKS5nZXRUaW1lKCksXHJcbiAgICAgICAgICAgICAgICAgICAgdGFnczogW10sXHJcbiAgICAgICAgICAgICAgICAgICAgY2hpbGRyZW46IFtdXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICAvLyBTaW11bGF0ZSB0aGUgVGltZWxpbmUncyB0b2dnbGVUYXNrQ29tcGxldGlvbiBsb2dpY1xyXG4gICAgICAgICAgICBjb25zdCB1cGRhdGVkVGFzayA9IHsgLi4uY2FudmFzVGFzaywgY29tcGxldGVkOiAhY2FudmFzVGFzay5jb21wbGV0ZWQgfTtcclxuXHJcbiAgICAgICAgICAgIGlmICh1cGRhdGVkVGFzay5jb21wbGV0ZWQpIHtcclxuICAgICAgICAgICAgICAgIHVwZGF0ZWRUYXNrLm1ldGFkYXRhLmNvbXBsZXRlZERhdGUgPSBEYXRlLm5vdygpO1xyXG4gICAgICAgICAgICAgICAgdXBkYXRlZFRhc2suc3RhdHVzID0gJ3gnO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAvLyBUZXN0IHRoYXQgQ2FudmFzVGFza1VwZGF0ZXIuaXNDYW52YXNUYXNrIGNvcnJlY3RseSBpZGVudGlmaWVzIHRoaXMgdGFza1xyXG4gICAgICAgICAgICBleHBlY3QoQ2FudmFzVGFza1VwZGF0ZXIuaXNDYW52YXNUYXNrKGNhbnZhc1Rhc2spKS50b0JlKHRydWUpO1xyXG5cclxuICAgICAgICAgICAgLy8gVGVzdCB0aGUgQ2FudmFzIHRhc2sgdXBkYXRlXHJcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGNhbnZhc1Rhc2tVcGRhdGVyLnVwZGF0ZUNhbnZhc1Rhc2soY2FudmFzVGFzaywgdXBkYXRlZFRhc2spO1xyXG5cclxuICAgICAgICAgICAgaWYgKCFyZXN1bHQuc3VjY2Vzcykge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ0NhbnZhcyB0YXNrIHVwZGF0ZSBmYWlsZWQ6JywgcmVzdWx0LmVycm9yKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBleHBlY3QocmVzdWx0LnN1Y2Nlc3MpLnRvQmUodHJ1ZSk7XHJcblxyXG4gICAgICAgICAgICAvLyBWZXJpZnkgdGhlIENhbnZhcyBmaWxlIHdhcyB1cGRhdGVkIGNvcnJlY3RseVxyXG4gICAgICAgICAgICBjb25zdCB1cGRhdGVkQ29udGVudCA9IG1vY2tWYXVsdC5nZXRGaWxlQ29udGVudCgndGltZWxpbmUtdGVzdC5jYW52YXMnKTtcclxuICAgICAgICAgICAgY29uc3QgdXBkYXRlZENhbnZhc0RhdGEgPSBKU09OLnBhcnNlKHVwZGF0ZWRDb250ZW50ISk7XHJcbiAgICAgICAgICAgIGNvbnN0IHVwZGF0ZWROb2RlID0gdXBkYXRlZENhbnZhc0RhdGEubm9kZXMuZmluZCgobjogYW55KSA9PiBuLmlkID09PSAndGltZWxpbmUtdGVzdC1ub2RlJyk7XHJcblxyXG4gICAgICAgICAgICBleHBlY3QodXBkYXRlZE5vZGUudGV4dCkudG9Db250YWluKCctIFt4XSBUaW1lbGluZSBDYW52YXMgdGFzaycpO1xyXG4gICAgICAgICAgICBleHBlY3QodXBkYXRlZE5vZGUudGV4dCkudG9Db250YWluKCfwn5OFIDIwMjUtMDEtMTUnKTtcclxuXHJcbiAgICAgICAgICAgIC8vIFNob3VsZCBhbHNvIGNvbnRhaW4gY29tcGxldGlvbiBkYXRlXHJcbiAgICAgICAgICAgIGNvbnN0IHRvZGF5ID0gbmV3IERhdGUoKTtcclxuICAgICAgICAgICAgY29uc3QgZXhwZWN0ZWREYXRlID0gYCR7dG9kYXkuZ2V0RnVsbFllYXIoKX0tJHtTdHJpbmcodG9kYXkuZ2V0TW9udGgoKSArIDEpLnBhZFN0YXJ0KDIsICcwJyl9LSR7U3RyaW5nKHRvZGF5LmdldERhdGUoKSkucGFkU3RhcnQoMiwgJzAnKX1gO1xyXG4gICAgICAgICAgICBleHBlY3QodXBkYXRlZE5vZGUudGV4dCkudG9Db250YWluKGDinIUgJHtleHBlY3RlZERhdGV9YCk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGl0KCdzaG91bGQgaGFuZGxlIENhbnZhcyB0YXNrIGNvbXBsZXRpb24gd2l0aCBvcmlnaW5hbE1hcmtkb3duIG1hdGNoaW5nJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICAgICAgICAvLyBUZXN0IHRoZSBpbXByb3ZlZCBvcmlnaW5hbE1hcmtkb3duIG1hdGNoaW5nIGxvZ2ljXHJcbiAgICAgICAgICAgIGNvbnN0IGNhbnZhc0RhdGE6IENhbnZhc0RhdGEgPSB7XHJcbiAgICAgICAgICAgICAgICBub2RlczogW1xyXG4gICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWQ6ICdtYXRjaGluZy10ZXN0LW5vZGUnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAndGV4dCcsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRleHQ6ICcjIE1hdGNoaW5nIFRlc3RcXG5cXG4tIFsgXSBUYXNrIHdpdGggY29tcGxleCBtZXRhZGF0YSAjcHJvamVjdC90ZXN0IEBob21lIOKPqyDwn5OFIDIwMjUtMDEtMjAnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB4OiAxMDAsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHk6IDEwMCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgd2lkdGg6IDQwMCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgaGVpZ2h0OiAyNTBcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBdLFxyXG4gICAgICAgICAgICAgICAgZWRnZXM6IFtdXHJcbiAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICBtb2NrVmF1bHQuY3JlYXRlRmlsZSgnbWF0Y2hpbmctdGVzdC5jYW52YXMnLCBKU09OLnN0cmluZ2lmeShjYW52YXNEYXRhLCBudWxsLCAyKSk7XHJcblxyXG4gICAgICAgICAgICBjb25zdCBjb21wbGV4VGFzazogVGFzazxDYW52YXNUYXNrTWV0YWRhdGE+ID0ge1xyXG4gICAgICAgICAgICAgICAgaWQ6ICdjb21wbGV4LWNhbnZhcy10YXNrJyxcclxuICAgICAgICAgICAgICAgIGNvbnRlbnQ6ICdUYXNrIHdpdGggY29tcGxleCBtZXRhZGF0YScsXHJcbiAgICAgICAgICAgICAgICBmaWxlUGF0aDogJ21hdGNoaW5nLXRlc3QuY2FudmFzJyxcclxuICAgICAgICAgICAgICAgIGxpbmU6IDAsXHJcbiAgICAgICAgICAgICAgICBjb21wbGV0ZWQ6IGZhbHNlLFxyXG4gICAgICAgICAgICAgICAgc3RhdHVzOiAnICcsXHJcbiAgICAgICAgICAgICAgICBvcmlnaW5hbE1hcmtkb3duOiAnLSBbIF0gVGFzayB3aXRoIGNvbXBsZXggbWV0YWRhdGEgI3Byb2plY3QvdGVzdCBAaG9tZSDij6sg8J+ThSAyMDI1LTAxLTIwJyxcclxuICAgICAgICAgICAgICAgIG1ldGFkYXRhOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgc291cmNlVHlwZTogJ2NhbnZhcycsXHJcbiAgICAgICAgICAgICAgICAgICAgY2FudmFzTm9kZUlkOiAnbWF0Y2hpbmctdGVzdC1ub2RlJyxcclxuICAgICAgICAgICAgICAgICAgICBkdWVEYXRlOiBuZXcgRGF0ZSgnMjAyNS0wMS0yMCcpLmdldFRpbWUoKSxcclxuICAgICAgICAgICAgICAgICAgICBwcmlvcml0eTogNCxcclxuICAgICAgICAgICAgICAgICAgICBwcm9qZWN0OiAndGVzdCcsXHJcbiAgICAgICAgICAgICAgICAgICAgY29udGV4dDogJ2hvbWUnLFxyXG4gICAgICAgICAgICAgICAgICAgIHRhZ3M6IFsnI3Byb2plY3QvdGVzdCddLFxyXG4gICAgICAgICAgICAgICAgICAgIGNoaWxkcmVuOiBbXVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAgICAgLy8gQ29tcGxldGUgdGhlIHRhc2tcclxuICAgICAgICAgICAgY29uc3QgY29tcGxldGVkVGFzayA9IHtcclxuICAgICAgICAgICAgICAgIC4uLmNvbXBsZXhUYXNrLFxyXG4gICAgICAgICAgICAgICAgY29tcGxldGVkOiB0cnVlLFxyXG4gICAgICAgICAgICAgICAgc3RhdHVzOiAneCcsXHJcbiAgICAgICAgICAgICAgICBtZXRhZGF0YToge1xyXG4gICAgICAgICAgICAgICAgICAgIC4uLmNvbXBsZXhUYXNrLm1ldGFkYXRhLFxyXG4gICAgICAgICAgICAgICAgICAgIGNvbXBsZXRlZERhdGU6IERhdGUubm93KClcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGNhbnZhc1Rhc2tVcGRhdGVyLnVwZGF0ZUNhbnZhc1Rhc2soY29tcGxleFRhc2ssIGNvbXBsZXRlZFRhc2spO1xyXG5cclxuICAgICAgICAgICAgZXhwZWN0KHJlc3VsdC5zdWNjZXNzKS50b0JlKHRydWUpO1xyXG5cclxuICAgICAgICAgICAgLy8gVmVyaWZ5IHRoZSB0YXNrIHdhcyBmb3VuZCBhbmQgdXBkYXRlZCBjb3JyZWN0bHlcclxuICAgICAgICAgICAgY29uc3QgdXBkYXRlZENvbnRlbnQgPSBtb2NrVmF1bHQuZ2V0RmlsZUNvbnRlbnQoJ21hdGNoaW5nLXRlc3QuY2FudmFzJyk7XHJcbiAgICAgICAgICAgIGNvbnN0IHVwZGF0ZWRDYW52YXNEYXRhID0gSlNPTi5wYXJzZSh1cGRhdGVkQ29udGVudCEpO1xyXG4gICAgICAgICAgICBjb25zdCB1cGRhdGVkTm9kZSA9IHVwZGF0ZWRDYW52YXNEYXRhLm5vZGVzLmZpbmQoKG46IGFueSkgPT4gbi5pZCA9PT0gJ21hdGNoaW5nLXRlc3Qtbm9kZScpO1xyXG5cclxuICAgICAgICAgICAgZXhwZWN0KHVwZGF0ZWROb2RlLnRleHQpLnRvQ29udGFpbignLSBbeF0gVGFzayB3aXRoIGNvbXBsZXggbWV0YWRhdGEnKTtcclxuICAgICAgICAgICAgZXhwZWN0KHVwZGF0ZWROb2RlLnRleHQpLnRvQ29udGFpbignI3Byb2plY3QvdGVzdCcpO1xyXG4gICAgICAgICAgICBleHBlY3QodXBkYXRlZE5vZGUudGV4dCkudG9Db250YWluKCdAaG9tZScpO1xyXG4gICAgICAgICAgICBleHBlY3QodXBkYXRlZE5vZGUudGV4dCkudG9Db250YWluKCfij6snKTtcclxuICAgICAgICAgICAgZXhwZWN0KHVwZGF0ZWROb2RlLnRleHQpLnRvQ29udGFpbign8J+ThSAyMDI1LTAxLTIwJyk7XHJcblxyXG4gICAgICAgICAgICAvLyBTaG91bGQgY29udGFpbiBjb21wbGV0aW9uIGRhdGVcclxuICAgICAgICAgICAgY29uc3QgdG9kYXkgPSBuZXcgRGF0ZSgpO1xyXG4gICAgICAgICAgICBjb25zdCBleHBlY3RlZERhdGUgPSBgJHt0b2RheS5nZXRGdWxsWWVhcigpfS0ke1N0cmluZyh0b2RheS5nZXRNb250aCgpICsgMSkucGFkU3RhcnQoMiwgJzAnKX0tJHtTdHJpbmcodG9kYXkuZ2V0RGF0ZSgpKS5wYWRTdGFydCgyLCAnMCcpfWA7XHJcbiAgICAgICAgICAgIGV4cGVjdCh1cGRhdGVkTm9kZS50ZXh0KS50b0NvbnRhaW4oYOKchSAke2V4cGVjdGVkRGF0ZX1gKTtcclxuICAgICAgICB9KTtcclxuICAgIH0pO1xyXG59KTtcclxuIl19